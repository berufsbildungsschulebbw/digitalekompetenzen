<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intra - BBW Digitale Kompetenzen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); min-height: calc(100vh - 40px); }
        .header { text-align: center; margin-bottom: 40px; }
        .back-button { display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; margin-bottom: 20px; transition: background 0.3s; }
        .back-button:hover { background: #5a67d8; }
        .back-button.hidden { display: none; }
        h1 { color: #2d3748; font-size: 2.5em; margin-bottom: 10px; }
        h3 { color: #2d3748; margin-bottom: 15px; }
        .subtitle { color: #718096; font-size: 1.1em; }
        .login-section { max-width: 400px; margin: 0 auto; padding: 40px; background: #f8f9fa; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-section h2 { color: #495057; margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #495057; font-weight: 500; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; transition: border-color 0.3s; }
        .form-input:focus { outline: none; border-color: #667eea; }
        .form-select { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; background: white; cursor: pointer; }
        .login-button { width: 100%; padding: 14px; background: #9C27B0; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .login-button:hover { background: #7B1FA2; transform: translateY(-2px); }
        .error-message { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; }
        .dashboard-section { display: none; }
        .dashboard-section.active { display: block; }
        .user-info { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .user-details h3 { margin-bottom: 5px; color: white; }
        .logout-button { padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .logout-button:hover { background: white; color: #667eea; }
        .tab-navigation { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #dee2e6; }
        .tab-button { padding: 12px 24px; background: transparent; border: none; color: #6c757d; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-button:hover { color: #495057; }
        .tab-button.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .code-generator { background: #f8f9fa; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .code-form { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .code-form .form-group { flex: 1; min-width: 180px; margin-bottom: 0; }
        .generate-button { padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .generate-button:hover { background: #218838; }
        .code-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .download-button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .download-button:hover { background: #0056b3; }
        .download-button:disabled { background: #cccccc; cursor: not-allowed; }
        .code-list { background: white; border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; }
        .code-table { width: 100%; border-collapse: collapse; }
        .code-table th, .code-table td { padding: 12px; border-bottom: 1px solid #dee2e6; text-align: left; }
        .code-table th:first-child, .code-table td:first-child { width: 40px; text-align: center; }
        .code-table th { background: #f8f9fa; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; }
        .code-table tr:last-child td { border-bottom: none; }
        .code-table tr:hover { background: #f8f9fa; }
        .code-badge { display: inline-block; padding: 4px 12px; background: #e3f2fd; color: #1565c0; border-radius: 20px; font-weight: 500; font-family: monospace; font-size: 1.1em; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; }
        .status-active { background: #d4edda; color: #155724; }
        .status-used { background: #fff3cd; color: #856404; }
        .status-expired { background: #f8d7da; color: #721c24; }
        .action-button { padding: 6px 12px; margin: 0 2px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: all 0.3s; }
        .view-button { background: #17a2b8; color: white; }
        .view-button:hover { background: #138496; }
        .delete-button { background: #dc3545; color: white; }
        .delete-button:hover { background: #c82333; }
        .results-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #667eea; }
        .stat-number { font-size: 2.5em; font-weight: bold; color: #667eea; }
        .stat-label { color: #6c757d; margin-top: 5px; }
        .department-chart { background: white; border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .chart-header { font-size: 1.2em; font-weight: 600; color: #495057; margin-bottom: 20px; }
        .chart-bars { display: flex; flex-direction: column; gap: 15px; }
        .chart-bar { display: flex; align-items: center; gap: 15px; }
        .bar-label { width: 200px; font-weight: 500; color: #495057; }
        .bar-container { flex: 1; background: #e9ecef; border-radius: 5px; height: 30px; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 5px; transition: width 1s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-weight: bold; }
        .dept-comparison-chart { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .dept-bars { display: flex; justify-content: space-around; align-items: flex-end; height: 250px; margin: 20px 0; padding: 0 20px; border-left: 2px solid #dee2e6; border-bottom: 2px solid #dee2e6; }
        .dept-bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; max-width: 150px; }
        .dept-bar { width: 60px; background: linear-gradient(180deg, #667eea, #764ba2); border-radius: 5px 5px 0 0; transition: height 1s ease; display: flex; align-items: flex-start; justify-content: center; padding-top: 10px; color: white; font-weight: bold; }
        .dept-bar-label { margin-top: 10px; text-align: center; font-size: 0.85em; color: #495057; }
        .results-table { width: 100%; border-collapse: collapse; background: white; border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; }
        .results-table th, .results-table td { padding: 12px; border-bottom: 1px solid #dee2e6; text-align: left; }
        .results-table th { background: #f8f9fa; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; }
        .results-table tr:last-child td { border-bottom: none; }
        .score-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-weight: bold; color: white; }
        .score-high { background: #28a745; }
        .score-medium { background: #ffc107; }
        .score-low { background: #dc3545; }
        .export-button { padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 20px; }
        .export-button:hover { background: #5a6268; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #2d3748; }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d; }
        /* --- Styles f√ºr Ergebnis-Details --- */
        .score-circle { width: 120px; height: 120px; margin: 10px auto; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5em; font-weight: bold; color: white; }
        .score-excellent { background: linear-gradient(135deg, #28a745, #20c997); }
        .score-good { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .score-needs-improvement { background: linear-gradient(135deg, #dc3545, #c82333); }
        .category-result { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .category-result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .category-result-title { font-weight: bold; color: #2d3748; }
        .category-result-score { font-weight: bold; }
        .result-bar-container { background: #e9ecef; border-radius: 5px; height: 18px; overflow: hidden; }
        .result-bar { height: 100%; border-radius: 5px; }
        .recommendations { background: #f0f8ff; border: 2px solid #667eea; border-radius: 15px; padding: 20px; margin-top: 20px; }
        .recommendation-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea; }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 1.8em; }
            .tab-navigation { flex-wrap: wrap; }
            .code-form { flex-direction: column; align-items: stretch; }
            .code-form .form-group { margin-bottom: 15px; }
            .user-info { flex-direction: column; text-align: center; gap: 15px; }
            .dept-bars { flex-direction: column; height: auto; align-items: stretch; gap: 20px; }
            .dept-bar-group { max-width: none; flex-direction: row; justify-content: space-between; align-items: center; }
            .dept-bar { width: 100%; height: 40px !important; border-radius: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" id="backButton" class="back-button">‚Üê Zur√ºck zur Startseite</a>
        
        <div class="header">
            <h1>Intra-Bereich</h1>
            <p class="subtitle">Verwaltung und Auswertung digitaler Kompetenzen</p>
        </div>

        <div id="loginSection" class="login-section">
            <h2>üîê Anmeldung</h2>
            <div id="errorMessage" class="error-message">Ung√ºltige Anmeldedaten. Bitte versuchen Sie es erneut.</div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select id="department" class="form-select" required>
                        <option value="">Bitte w√§hlen...</option>
                        <option value="bau">Bau</option>
                        <option value="technik">Technik | Ern√§hrung</option>
                        <option value="maschinenbau">Maschinenbau</option>
                        <option value="informatik">Informatik | Naturwissenschaften</option>
                        <option value="admin">Administration</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Benutzername</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" class="login-button">Anmelden</button>
            </form>
        </div>

        <div id="dashboardSection" class="dashboard-section">
            <div class="user-info">
                <div class="user-details">
                    <h3 id="userDepartment">Abteilung</h3>
                    <p id="userName">Benutzer</p>
                </div>
                <button id="logoutBtn" class="logout-button">üö™ Abmelden</button>
            </div>

            <div id="tabNav" class="tab-navigation">
                <button class="tab-button active" data-tab="codes">üìù Code-Verwaltung</button>
                <button class="tab-button" data-tab="results">üìä Ergebnisse</button>
                <button class="tab-button" data-tab="statistics">üìà Statistiken</button>
                <button id="adminTabButton" class="tab-button" data-tab="admin" style="display: none;">‚öôÔ∏è Administration</button>
            </div>

            <div id="codesTab" class="tab-content active">
                <div class="code-generator">
                    <h3>Neue Test-Codes generieren</h3>
                    <div class="code-form">
                        <div class="form-group" id="adminDepartmentSelector" style="display: none;">
                            <label class="form-label">F√ºr Abteilung</label>
                            <select id="adminDepartmentSelect" class="form-select">
                                <option value="admin">Administration</option>
                                <option value="bau">Bau</option>
                                <option value="technik">Technik | Ern√§hrung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <input type="text" id="codeDescription" class="form-input" placeholder="z.B. Q1 2025 Assessment" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">G√ºltig bis</label>
                            <input type="date" id="codeExpiry" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anzahl</label>
                            <input id="codeQuantity" type="number" class="form-input" min="1" max="1000" step="1" value="10">
                        </div>
                        <button id="generateCodesBtn" class="generate-button">Codes generieren</button>
                    </div>
                </div>
                <div class="code-list-header">
                    <h3>Generierte Codes</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="downloadCodesBtn" class="download-button" disabled>üì• Ausgew√§hlte herunterladen</button>
                        <button id="deleteSelectedBtn" class="delete-button" style="padding: 10px 20px; border-radius: 8px; font-weight: bold;" disabled>üóëÔ∏è Ausgew√§hlte l√∂schen</button>
                    </div>
                </div>
                <div class="code-list">
                    <table class="code-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Code</th>
                                <th>Beschreibung</th>
                                <th>Abteilung</th>
                                <th>Erstellt am</th>
                                <th>G√ºltig bis</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="codeTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="resultsTab" class="tab-content">
                <div class="results-overview">
                    <div class="stat-card"><div class="stat-number" id="totalTests">0</div><div class="stat-label">Durchgef√ºhrte Tests</div></div>
                    <div class="stat-card"><div class="stat-number" id="avgScore">0%</div><div class="stat-label">Durchschnittlicher Score</div></div>
                    <div class="stat-card"><div class="stat-number" id="activeCodes">0</div><div class="stat-label">Aktive Codes</div></div>
                    <div class="stat-card"><div class="stat-number" id="completionRate">0%</div><div class="stat-label">Abschlussrate</div></div>
                </div>
                <h3 style="margin: 30px 0 20px;">Individuelle Ergebnisse nach Code</h3>
                <div style="margin-bottom: 20px; display:flex; gap:10px; align-items:center;">
                    <select id="codeFilter" class="form-select" style="width: auto;"><option value="">Alle Codes</option></select>
                    <button id="refreshResultsBtn" class="download-button" type="button">üîÑ Neu laden</button>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Code</th><th>Datum</th><th>Gesamtscore</th><th>Bereich 1</th><th>Bereich 2</th><th>Bereich 3</th><th>Bereich 4</th><th>Bereich 5</th><th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
                <button id="exportResultsBtn" class="export-button">üì• Ergebnisse exportieren (CSV)</button>
            </div>

            <div id="statisticsTab" class="tab-content">
                <div class="department-chart">
                    <div class="chart-header">Durchschnittliche Scores nach Kompetenzbereich</div>
                    <div class="chart-bars">
                        <div class="chart-bar"><div class="bar-label">Grundkenntnisse IKT</div><div class="bar-container"><div class="bar-fill" id="bar1" style="width: 0%;">0%</div></div></div>
                        <div class="chart-bar"><div class="bar-label">Anwendung im Unterricht</div><div class="bar-container"><div class="bar-fill" id="bar2" style="width: 0%;">0%</div></div></div>
                        <div class="chart-bar"><div class="bar-label">Medien- & Infokompetenz</div><div class="bar-container"><div class="bar-fill" id="bar3" style="width: 0%;">0%</div></div></div>
                        <div class="chart-bar"><div class="bar-label">Daten & Sicherheit</div><div class="bar-container"><div class="bar-fill" id="bar4" style="width: 0%;">0%</div></div></div>
                        <div class="chart-bar"><div class="bar-label">Kommunikation</div><div class="bar-container"><div class="bar-fill" id="bar5" style="width: 0%;">0%</div></div></div>
                    </div>
                </div>
                <div class="department-chart">
                    <div class="chart-header">Entwicklung √ºber Zeit</div>
                    <p style="color: #6c757d; text-align: center; padding: 40px;">Hier w√ºrde ein Liniendiagramm mit der zeitlichen Entwicklung der Kompetenzen angezeigt werden.</p>
                </div>
            </div>

            <div id="adminTab" class="tab-content">
                <div class="code-generator">
                    <h3>Benutzerverwaltung</h3>
                    <div class="code-form">
                        <div class="form-group">
                            <label class="form-label">Abteilung</label>
                            <select id="newUserDepartmentSelect" class="form-select">
                                <option value="bau">Bau</option>
                                <option value="technik">Technik | Ern√§hrung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                                <option value="admin">Administration</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Benutzername</label>
                            <input type="text" id="newUsername" class="form-input" placeholder="z.B. mueller">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Passwort</label>
                            <input type="password" id="newPassword" class="form-input" placeholder="Mind. 6 Zeichen">
                        </div>
                        <button id="addUserBtn" class="generate-button">Benutzer hinzuf√ºgen</button>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Bestehende Benutzer</h4>
                        <div id="userList" style="margin-top: 10px; background: white; padding: 15px; border-radius: 8px;"></div>
                    </div>
                </div>
                <h3>Abteilungs√ºbersicht</h3>
                <div class="results-overview">
                    <div class="stat-card"><div class="stat-number" id="allDepartmentsCount">0</div><div class="stat-label">Aktive Abteilungen</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalTestsAdmin">0</div><div class="stat-label">Tests Gesamt</div></div>
                    <div class="stat-card"><div class="stat-number" id="avgScoreAdmin">0%</div><div class="stat-label">Gesamt-Durchschnitt</div></div>
                    <div class="stat-card"><div class="stat-number" id="bestDeptAdmin">-</div><div class="stat-label">Beste Abteilung</div></div>
                </div>
                <h3 style="margin: 30px 0 20px;">Abteilungsvergleich</h3>
                <div class="dept-comparison-chart">
                    <div class="chart-header">Durchschnittliche Scores nach Abteilung</div>
                    <div class="dept-bars" id="deptBarsChart"></div>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Abteilung</th><th>Anzahl Tests</th><th>√ò Score</th><th>Beste Kompetenz</th><th>Schw√§chste Kompetenz</th><th>Trend</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Test-Details</h3>
                    <button class="modal-close" data-modal-id="detailModal">√ó</button>
                </div>
                <div id="modalBody"></div>
            </div>
        </div>
        
        <div id="alertModal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h3 id="alertModalTitle">Hinweis</h3>
                    <button class="modal-close" data-modal-id="alertModal">√ó</button>
                </div>
                <div id="alertModalBody" style="margin: 10px 0 20px; color: #495057; line-height: 1.6;"></div>
                <div id="alertModalFooter" style="text-align: right;"></div>
            </div>
        </div>
    </div>
    
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCHhycjQmHU00_dQl5Xdo5PZCTn8JODk20",
            authDomain: "ikt-komp-bbw.firebaseapp.com",
            projectId: "ikt-komp-bbw",
            storageBucket: "ikt-komp-bbw.firebasestorage.app",
            messagingSenderId: "154620660911",
            appId: "1:154620660911:web:20d389d699d2f0d2c2d85a",
            measurementId: "G-JZ1VC46184"
        });
    </script>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, 
            collection, query, writeBatch, where, getDocs, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = JSON.parse(window.__firebase_config);
        let app = null, db = null, auth = null;
        let firebaseReady = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            firebaseReady = true;
        } catch (e) {
            console.error("Firebase-Initialisierung fehlgeschlagen:", e);
        }

        // Firestore Collection References
        const codesCollection = collection(db, 'codes');
        const resultsCollection = collection(db, 'results');
        const accountsDocRef = doc(db, 'config', 'userAccounts');

        // State Management
        let currentUser = null;
        let currentDepartment = null;
        let generatedCodes = [];
        let testResults = [];
        let userAccounts = {};

        // Data for new features
        const deptNames = {
            'bau': 'Bau', 'technik': 'Technik | Ern√§hrung', 'maschinenbau': 'Maschinenbau',
            'informatik': 'Informatik | Naturwissenschaften', 'admin': 'Administration'
        };

        const sections = [ { id: 1, name: "Grundkenntnisse IKT", questions: [ { id: 1, text: "Wie sicher f√ºhlen Sie sich beim Verbinden von technischen Ger√§ten (z.B. Beamer, Drucker) mit Ihrem Computer?" }, { id: 2, text: "Wie gut k√∂nnen Sie Office-Programme (Word, Excel, PowerPoint) f√ºr die Erstellung von Unterrichtsmaterialien nutzen?" }, { id: 3, text: "Wie routiniert nutzen Sie Cloud-Dienste (OneDrive, Teams) f√ºr Ihre Unterrichtsvorbereitung?" } ] }, { id: 2, name: "Anwendung im Unterricht", questions: [ { id: 4, text: "Wie h√§ufig setzen Sie digitale Werkzeuge oder KI-Tools f√ºr die Erstellung von Lernmaterialien ein?" }, { id: 5, text: "Wie interaktiv gestalten Sie Ihren Unterricht mit digitalen Tools (z.B. Kahoot, Quizlet, digitale Pinnw√§nde, Forms)?" }, { id: 6, text: "Wie setzen Sie E-Assessments f√ºr die Leistungserfassung ein?" } ] }, { id: 3, name: "Medien- und Informationskompetenz", questions: [ { id: 7, text: "Wie gut kennen Sie die Funktionsweise von Social Media und deren m√∂gliche Einsatzorte im Unterricht?" }, { id: 8, text: "K√∂nnen Sie multimediale Inhalte (Videos, Podcasts, interaktive Pr√§sentationen) f√ºr Ihren Unterricht erstellen?" }, { id: 9, text: "Wie vermitteln Sie Ihren Lernenden kritische Medienkompetenz und Quellenpr√ºfung?" } ] }, { id: 4, name: "Datenverwaltung und Datensicherheit", questions: [ { id: 10, text: "Wie gut kennen Sie die rechtlichen Grundlagen zum Datenschutz im schulischen Kontext?" }, { id: 11, text: "Wie verwalten Sie Ihre Passw√∂rter und Zugangsdaten?" }, { id: 12, text: "Wie strukturiert verwalten Sie digitale Unterrichtsmaterialien und Lernendendaten?" } ] }, { id: 5, name: "Kommunikation und Kollaboration", questions: [ { id: 13, text: "Wie aktiv nutzen Sie Teams oder √§hnliche Plattformen f√ºr die Kommunikation mit Kollegium und Lernenden?" }, { id: 14, text: "Wie gut k√∂nnen Sie kollaborative Dokumente (z.B. in Teams/OneDrive) f√ºr gemeinsame Projekte nutzen?" }, { id: 15, text: "Wie professionell ist Ihre digitale Kommunikation (Netiquette, Antwortzeiten, Strukturierung)?" } ] } ];
        
        const categoryNames = [ "Grundkenntnisse IKT", "Anwendung im Unterricht", "Medien- und Informationskompetenz", "Datenverwaltung und Datensicherheit", "Kommunikation und Kollaboration" ];

        // --- Helper Functions ---
        function toJsDate(ts) { if (!ts) return null; if (typeof ts === 'string') return new Date(ts); if (ts.toDate) return ts.toDate(); if (ts.seconds) return new Date(ts.seconds * 1000); return null; }
        function getCat(result, idx) { const cp = result?.categoryPercentages || {}; return cp[idx] ?? cp[String(idx)] ?? 0; }
        function generateRandomCode() { return (Math.random().toString(36).substring(2, 6) + '-' + Math.random().toString(36).substring(2, 6)).toUpperCase(); }

        function generateRecommendations(results) {
            const recommendations = [];
            const recMap = {
                1: "Besuchen Sie Basis-Schulungen zu Office 365.",
                2: "Experimentieren Sie mit interaktiven Tools wie Kahoot.",
                3: "Lernen Sie Tools zur Erstellung multimedialer Inhalte kennen.",
                4: "Nehmen Sie an einer Datenschutz-Schulung teil.",
                5: "Nutzen Sie Teams aktiver f√ºr die Zusammenarbeit."
            };
            for (let i = 1; i <= 5; i++) {
                if (results.categoryPercentages[i] < 60) {
                    recommendations.push({ title: categoryNames[i - 1], text: recMap[i] });
                }
            }
            if (recommendations.length === 0) {
                recommendations.push({ title: "Fortgeschrittene Kompetenzen", text: "Erkunden Sie KI-Tools f√ºr den Unterricht." });
            }
            return recommendations.slice(0, 3);
        }

        function showCategoryDetails(categoryIndex) {
            const section = sections.find(s => s.id === categoryIndex);
            if (!section) return;
            const departmentCodes = currentDepartment === 'admin' ? generatedCodes.map(c => c.code) : generatedCodes.filter(c => c.department === currentDepartment).map(c => c.code);
            const relevantResults = testResults.filter(r => r?.answers && departmentCodes.includes(r.testCode));

            if (relevantResults.length === 0) {
                return showCustomAlert(`F√ºr den Bereich "${section.name}" liegen noch keine Detail-Ergebnisse vor.`);
            }

            const questionsHTML = section.questions.map(question => {
                const answersForQ = relevantResults.map(r => r.answers[question.id]).filter(a => a !== undefined);
                const avgScore = answersForQ.length ? answersForQ.reduce((a, b) => a + b, 0) / answersForQ.length : 0;
                const avgPercent = (avgScore / 4) * 100;
                const barColor = avgPercent >= 75 ? '#28a745' : avgPercent >= 50 ? '#ffc107' : '#dc3545';
                return `
                    <div class="category-result">
                        <p style="margin-bottom: 8px;">${question.text}</p>
                        <div class="category-result-header">
                            <span class="category-result-title">√ò Antwort:</span>
                            <span class="category-result-score">${avgScore.toFixed(2)} / 4.00</span>
                        </div>
                        <div class="result-bar-container">
                            <div class="result-bar" style="width: ${avgPercent}%; background: ${barColor};"></div>
                        </div>
                    </div>`;
            }).join('');

            document.getElementById('modalTitle').textContent = `Detailauswertung: ${section.name}`;
            document.getElementById('modalBody').innerHTML = `<p>Basierend auf <strong>${relevantResults.length}</strong> Tests.</p><hr style="margin: 15px 0;">${questionsHTML}`;
            document.getElementById('detailModal').classList.add('active');
        }

        // --- Core Application Logic ---
        async function handleLogin(event) {
            event.preventDefault();
            const department = document.getElementById('department').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const accounts = userAccounts[department] || [];
            const loginOk = Array.isArray(accounts) && accounts.some(acc => acc.user === username && acc.pass === password);

            if (loginOk && department) {
                currentUser = username;
                currentDepartment = department;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('backButton').classList.add('hidden');
                document.getElementById('dashboardSection').classList.add('active');
                document.getElementById('userDepartment').textContent = deptNames[department] || department;
                document.getElementById('userName').textContent = `Benutzer: ${username}`;
                const isAdmin = department === 'admin';
                document.getElementById('adminTabButton').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('adminDepartmentSelector').style.display = isAdmin ? 'block' : 'none';
                loadDashboardData();
                if (isAdmin) loadUserList();
            } else {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                setTimeout(() => { errorMessage.style.display = 'none'; }, 3000);
            }
        }

        function handleLogout() { location.reload(); }

        function switchTab(tabButton) {
            const tabName = tabButton.dataset.tab;
            document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
            tabButton.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (tabName === 'results') loadResultsData();
            if (tabName === 'statistics') loadStatisticsData();
            if (tabName === 'admin') loadAdminData();
        }

        async function generateCodes() {
            const description = document.getElementById('codeDescription').value.trim();
            const expiryStr = document.getElementById('codeExpiry').value;
            const quantity = parseInt(document.getElementById('codeQuantity').value);
            const isAdmin = currentDepartment === 'admin';
            const targetDepartment = isAdmin ? document.getElementById('adminDepartmentSelect').value : currentDepartment;
            if (!description || !expiryStr) return showCustomAlert('Bitte alle Felder ausf√ºllen.');
            
            for (let i = 0; i < quantity; i++) {
                const codeData = {
                    code: generateRandomCode(), description, department: targetDepartment,
                    created: new Date().toLocaleDateString('de-DE'),
                    expiry: new Date(expiryStr).toLocaleDateString('de-DE'),
                    expiryDate: new Date(expiryStr).toISOString(), status: 'Aktiv'
                };
                await addDoc(codesCollection, codeData);
            }
            showCustomAlert(`${quantity} Code(s) wurden generiert.`);
        }

        function loadDashboardData() {
            const codeTableBody = document.getElementById('codeTableBody');
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);
            document.getElementById('selectAllCheckbox').checked = false;
            updateDownloadButtonState();
            if (departmentCodes.length === 0) {
                codeTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Keine Codes vorhanden.</td></tr>`;
                return;
            }
            document.querySelector('.code-table th:nth-child(4)').style.display = isAdmin ? '' : 'none';
            codeTableBody.innerHTML = departmentCodes.sort((a,b) => (b.createdTimestamp?.seconds || 0) - (a.createdTimestamp?.seconds || 0))
                .map(code => {
                    const isExpired = new Date() > new Date(code.expiryDate);
                    const status = isExpired ? 'Abgelaufen' : 'Aktiv';
                    const statusClass = isExpired ? 'status-expired' : 'status-active';
                    const participants = testResults.filter(r => r.testCode === code.code).length;
                    return `
                        <tr data-doc-id="${code.id}" data-code="${code.code}">
                            <td><input type="checkbox" class="code-checkbox" value="${code.code}"></td>
                            <td><span class="code-badge">${code.code}</span></td>
                            <td>${code.description}</td>
                            <td style="display: ${isAdmin ? '' : 'none'}">${deptNames[code.department] || code.department}</td>
                            <td>${code.created}</td>
                            <td>${code.expiry}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span> (${participants})</td>
                            <td><button class="action-button view-button">Ansehen</button><button class="action-button delete-button">L√∂schen</button></td>
                        </tr>`;
                }).join('');
            updateStatistics();
        }

        function loadResultsData() {
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes.map(c => c.code) : generatedCodes.filter(c => c.department === currentDepartment).map(c => c.code);
            const relevantResults = testResults.filter(r => r?.testCode && departmentCodes.includes(r.testCode));
            
            const codeFilter = document.getElementById('codeFilter');
            codeFilter.innerHTML = '<option value="">Alle Codes</option>' + departmentCodes.map(code => `<option value="${code}">${code}</option>`).join('');
            
            displayResults(relevantResults);
        }

        function displayResults(results) {
            const resultsTableBody = document.getElementById('resultsTableBody');
            if (!results || results.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Keine Ergebnisse vorhanden</td></tr>';
                return;
            }
            resultsTableBody.innerHTML = results.sort((a,b) => (toJsDate(b.timestamp) || 0) - (toJsDate(a.timestamp) || 0))
                .map(result => {
                    const scoreClass = result.totalPercentage >= 80 ? 'score-high' : result.totalPercentage >= 60 ? 'score-medium' : 'score-low';
                    return `
                        <tr data-doc-id="${result.id}">
                            <td><span class="code-badge">${result.testCode}</span></td>
                            <td>${toJsDate(result.timestamp)?.toLocaleDateString('de-DE') || 'N/A'}</td>
                            <td><span class="score-badge ${scoreClass}">${result.totalPercentage || 0}%</span></td>
                            ${[1,2,3,4,5].map(i => `<td>${getCat(result,i)}%</td>`).join('')}
                            <td><button class="action-button view-button">Details</button></td>
                        </tr>`;
                }).join('');
        }

        function loadStatisticsData() {
            const departmentCodes = currentDepartment === 'admin' ? generatedCodes.map(c => c.code) : generatedCodes.filter(c => c.department === currentDepartment).map(c => c.code);
            const relevantResults = testResults.filter(r => r && r.testCode && departmentCodes.includes(r.testCode));
            
            for (let i = 1; i <= 5; i++) {
                const bar = document.getElementById(`bar${i}`);
                let avg = 0;
                if (relevantResults.length > 0) {
                    const scores = relevantResults.map(r => getCat(r, i) || 0);
                    avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                }
                if (bar) {
                    bar.style.width = avg + '%';
                    bar.textContent = avg + '%';
                    const chartBar = bar.closest('.chart-bar');
                    if(chartBar) {
                        chartBar.style.cursor = 'pointer';
                        chartBar.onclick = () => showCategoryDetails(i);
                    }
                }
            }
        }

        function loadAdminData() {
            const adminTableBody = document.getElementById('adminTableBody');
            const departments = Object.keys(deptNames).filter(d => d !== 'admin');
            document.getElementById('allDepartmentsCount').textContent = departments.length;
            
            let bestDept = { name: '-', score: 0 };
            const deptStats = [];
            
            const tableRows = departments.map(deptKey => {
                const deptCodes = generatedCodes.filter(c => c.department === deptKey).map(c => c.code);
                const deptResults = testResults.filter(r => r?.testCode && deptCodes.includes(r.testCode));
                if (deptResults.length === 0) {
                    deptStats.push({ name: deptNames[deptKey], score: 0 });
                    return `<tr><td>${deptNames[deptKey]}</td><td>0</td><td>N/A</td><td>N/A</td><td>N/A</td><td>-</td></tr>`;
                }
                const avgScore = Math.round(deptResults.reduce((sum, r) => sum + (r.totalPercentage || 0), 0) / deptResults.length);
                if (avgScore > bestDept.score) bestDept = { name: deptNames[deptKey], score: avgScore };
                deptStats.push({ name: deptNames[deptKey], score: avgScore });
                // ... logic for best/worst competency can be added here
                return `
                    <tr>
                        <td>${deptNames[deptKey]}</td>
                        <td>${deptResults.length}</td>
                        <td><span class="score-badge ${avgScore >= 80 ? 'score-high' : avgScore >= 60 ? 'score-medium' : 'score-low'}">${avgScore}%</span></td>
                        <td>...</td><td>...</td><td>-</td>
                    </tr>`;
            }).join('');
            
            adminTableBody.innerHTML = tableRows;
            document.getElementById('bestDeptAdmin').textContent = bestDept.name;

            const deptBarsChart = document.getElementById('deptBarsChart');
            const maxScore = Math.max(...deptStats.map(d => d.score), 100);
            deptBarsChart.innerHTML = deptStats.map(dept => {
                const height = dept.score > 0 ? (dept.score / maxScore) * 100 : 5;
                return `<div class="dept-bar-group"><div class="dept-bar" style="height: ${height}%;">${dept.score > 0 ? dept.score + '%' : ''}</div><div class="dept-bar-label">${dept.name}</div></div>`;
            }).join('');

            updateStatistics();
            loadUserList();
        }

        function loadUserList() {
            const userList = document.getElementById('userList');
            let html = '';
            for (const [dept, users] of Object.entries(userAccounts)) {
                html += `<div><strong>${deptNames[dept] || dept}:</strong><br>`;
                if (Array.isArray(users) && users.length > 0) {
                    users.forEach(user => {
                        html += `<div style="margin-left: 20px;">${user.user} <button class="action-button delete-button" onclick="window.removeUser('${dept}', '${user.user}')">Entfernen</button></div>`;
                    });
                } else {
                    html += `<div style="margin-left: 20px; color: #6c757d;">Keine Benutzer (Demo-Login aktiv)</div>`;
                }
                html += `</div>`;
            }
            userList.innerHTML = html;
        }

        async function addUser() {
            const dept = document.getElementById('newUserDepartmentSelect').value;
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            if (!username || password.length < 6) return showCustomAlert('Benutzername und Passwort (mind. 6 Zeichen) erforderlich.');
            if (!userAccounts[dept]) userAccounts[dept] = [];
            if (userAccounts[dept].some(u => u.user === username)) return showCustomAlert('Benutzer existiert bereits.');
            userAccounts[dept].push({ user: username, pass: password });
            if (firebaseReady) await setDoc(accountsDocRef, userAccounts);
            showCustomAlert(`Benutzer ${username} wurde hinzugef√ºgt.`);
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            loadUserList();
        }

        window.removeUser = async function(dept, username) {
            showCustomConfirm(`Benutzer <strong>${username}</strong> wirklich entfernen?`, "Entfernen", async () => {
                if (userAccounts[dept]) {
                    userAccounts[dept] = userAccounts[dept].filter(u => u.user !== username);
                    if (firebaseReady) await setDoc(accountsDocRef, userAccounts);
                    showCustomAlert(`Benutzer ${username} wurde entfernt.`);
                    loadUserList();
                }
            });
        };

        function updateStatistics() {
            const isAdmin = currentDepartment === 'admin';
            const allRelevantResults = testResults.filter(r => r?.totalPercentage !== undefined);
            const departmentCodes = isAdmin ? generatedCodes.map(c => c.code) : generatedCodes.filter(c => c.department === currentDepartment).map(c => c.code);
            const relevantResults = allRelevantResults.filter(r => departmentCodes.includes(r.testCode));
            
            document.getElementById('totalTests').textContent = relevantResults.length;
            document.getElementById('activeCodes').textContent = generatedCodes.filter(c => new Date(c.expiryDate) >= new Date()).length;
            const avgScore = relevantResults.length ? Math.round(relevantResults.reduce((sum, r) => sum + r.totalPercentage, 0) / relevantResults.length) : 0;
            document.getElementById('avgScore').textContent = avgScore + '%';
            const usedCodes = new Set(relevantResults.map(r => r.testCode)).size;
            document.getElementById('completionRate').textContent = departmentCodes.length ? Math.round((usedCodes / departmentCodes.length) * 100) + '%' : '0%';

            if (isAdmin) {
                document.getElementById('totalTestsAdmin').textContent = allRelevantResults.length;
                const avgScoreAdmin = allRelevantResults.length ? Math.round(allRelevantResults.reduce((sum, r) => sum + r.totalPercentage, 0) / allRelevantResults.length) : 0;
                document.getElementById('avgScoreAdmin').textContent = avgScoreAdmin + '%';
            }
        }
        
        function viewResultDetails(docId) {
            const result = testResults.find(r => r.id === docId);
            if (!result) return showCustomAlert('Ergebnis-Details konnten nicht geladen werden.');
            
            document.getElementById('modalTitle').textContent = `Detailergebnis f√ºr Code: ${result.testCode}`;
            const modalBody = document.getElementById('modalBody');
            let scoreClass = 'score-needs-improvement', scoreText = 'Es besteht Entwicklungsbedarf.';
            if (result.totalPercentage >= 80) { scoreClass = 'score-excellent'; scoreText = 'Ausgezeichnet!'; }
            else if (result.totalPercentage >= 60) { scoreClass = 'score-good'; scoreText = 'Gut!'; }

            const categoriesHTML = categoryNames.map((name, i) => { const p = getCat(result, i+1); const bc = p >= 80 ? '#28a745' : p >= 60 ? '#ffc107' : '#dc3545'; return `<div class="category-result"><div class="category-result-header"><span class="category-result-title">${name}</span><span class="category-result-score">${p}%</span></div><div class="result-bar-container"><div class="result-bar" style="width: ${p}%; background: ${bc};"></div></div></div>`; }).join('');
            const recommendationsHTML = generateRecommendations(result).map(rec => `<div class="recommendation-item"><strong>${rec.title}:</strong> ${rec.text}</div>`).join('');
            
            modalBody.innerHTML = `<div style="text-align: center;"><div class="score-circle ${scoreClass}">${result.totalPercentage}%</div><p style="font-size: 1.1em; color: #495057;">${scoreText}</p></div><hr style="margin: 20px 0;"><h4>Kompetenzbereiche</h4>${categoriesHTML}<div class="recommendations"><h4 style="margin-bottom: 10px;">Empfohlene Massnahmen</h4>${recommendationsHTML}</div>`;
            document.getElementById('detailModal').classList.add('active');
        }
        
        function viewCodeDetails(docId) { /* ... Omitted ... */ }
        async function deleteCode(docId, code) { /* ... Omitted ... */ }
        async function deleteSelectedCodes() { /* ... Omitted ... */ }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
        function showCustomAlert(message) { /* ... Omitted ... */ }
        window.showCustomAlert = showCustomAlert;
        function showCustomConfirm(message, confirmText, onConfirm) { /* ... Omitted ... */ }
        window.showCustomConfirm = showCustomConfirm;
        function updateDownloadButtonState() { /* ... Omitted ... */ }
        function toggleAllCheckboxes(source) { /* ... Omitted ... */ }
        function downloadSelectedCodes() { /* ... Omitted ... */ }
        function exportResults() { /* ... Omitted ... */ }
        function filterResults() { /* ... Omitted ... */ }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loginButton = document.querySelector('.login-button');
            if (loginButton) loginButton.disabled = true;
            
            await (async function() {
                if (!firebaseReady) { userAccounts = { 'admin': [{ user: 'admin', pass: 'admin123' }] }; return; }
                try {
                    await signInAnonymously(auth);
                    const docSnap = await getDoc(accountsDocRef);
                    userAccounts = docSnap.exists() ? docSnap.data() : { 'admin': [{ user: 'admin', pass: 'admin123' }] };
                    onSnapshot(codesCollection, (snapshot) => { generatedCodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (currentUser) loadDashboardData(); });
                    onSnapshot(resultsCollection, (snapshot) => { testResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (currentUser) { updateStatistics(); if (document.getElementById('resultsTab').classList.contains('active')) loadResultsData(); if (document.getElementById('statisticsTab').classList.contains('active')) loadStatisticsData(); } });
                    await getDocs(codesCollection).then(snap => generatedCodes = snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    await getDocs(resultsCollection).then(snap => testResults = snap.docs.map(d => ({ id: d.id, ...d.data() })));
                } catch (error) { console.error('Fehler bei der Firebase-Initialisierung:', error); }
            })();
            
            if (loginButton) loginButton.disabled = false;
            
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('generateCodesBtn').addEventListener('click', generateCodes);
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('tabNav').addEventListener('click', (e) => { const btn = e.target.closest('.tab-button'); if (btn) switchTab(btn); });
            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', e => closeModal(e.target.dataset.modalId)));
            document.getElementById('codeFilter').addEventListener('change', filterResults);
            
            document.addEventListener('click', e => {
                if (e.target.closest('#resultsTableBody')?.classList.contains('view-button')) {
                    viewResultDetails(e.target.closest('tr').dataset.docId);
                }
            });
        });
    </script>
</body>
</html>
