<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intra - BBW Digitale Kompetenzen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: calc(100vh - 40px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #5a67d8;
        }

        .back-button.hidden {
            display: none;
        }

        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        h3 {
             color: #2d3748;
             margin-bottom: 15px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }

        /* Login Section */
        .login-section {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-section h2 {
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: #9C27B0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        /* Dashboard Section */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details h3 {
            margin-bottom: 5px;
            color: white;
        }

        .logout-button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-button:hover {
            background: white;
            color: #667eea;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6c757d;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            color: #495057;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Code Management */
        .code-generator {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .code-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .code-form .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 0;
        }

        .generate-button {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-button:hover {
            background: #218838;
        }

        .code-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .download-button {
             padding: 10px 20px;
             background: #007bff;
             color: white;
             border: none;
             border-radius: 8px;
             font-weight: bold;
             cursor: pointer;
             transition: all 0.3s;
        }
        
        .download-button:hover {
            background: #0056b3;
        }
        
        .download-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .code-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .code-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .code-table th, .code-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }
        
        .code-table th:first-child, .code-table td:first-child {
            width: 40px;
            text-align: center;
        }

        .code-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .code-table tr:last-child td {
            border-bottom: none;
        }

        .code-table tr:hover {
            background: #f8f9fa;
        }

        .code-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 20px;
            font-weight: 500;
            font-family: monospace;
            font-size: 1.1em;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-used {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .action-button {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .view-button {
            background: #17a2b8;
            color: white;
        }

        .view-button:hover {
            background: #138496;
        }

        .delete-button {
            background: #dc3545;
            color: white;
        }

        .delete-button:hover {
            background: #c82333;
        }

        /* Results Section */
        .results-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        /* Department Stats */
        .department-chart {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .chart-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
        }

        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            width: 200px;
            font-weight: 500;
            color: #495057;
        }

        .bar-container {
            flex: 1;
            background: #e9ecef;
            border-radius: 5px;
            height: 30px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }

        .dept-comparison-chart {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .dept-bars {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 250px;
            margin: 20px 0;
            padding: 0 20px;
            border-left: 2px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
        }

        .dept-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 150px;
        }

        .dept-bar {
            width: 60px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            transition: height 1s ease;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10px;
            color: white;
            font-weight: bold;
        }

        .dept-bar-label {
            margin-top: 10px;
            text-align: center;
            font-size: 0.85em;
            color: #495057;
        }

        /* Individual Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .results-table th, .results-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-table tr:last-child td {
            border-bottom: none;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }

        .score-high { background: #28a745; }
.score-medium { background: #ffc107; }
.score-needs-improvement { background: #ff9800; }
.score-low { background: #ff69b4; }

        /* Export Button */
        .export-button {
            padding: 12px 30px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .export-button:hover {
            background: #5a6268;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
             color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .tab-navigation {
                flex-wrap: wrap;
            }

            .code-form {
                flex-direction: column;
                align-items: stretch;
            }
            
             .code-form .form-group {
                margin-bottom: 15px;
            }

            .user-info {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .dept-bars {
                flex-direction: column;
                height: auto;
                align-items: stretch;
                gap: 20px;
            }

            .dept-bar-group {
                max-width: none;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .dept-bar {
                width: 100%;
                height: 40px !important;
                border-radius: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" id="backButton" class="back-button">← Zurück zur Startseite</a>
        
        <div class="header">
            <h1>Intra-Bereich</h1>
            <p class="subtitle">Verwaltung und Auswertung digitaler Kompetenzen</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>🔐 Anmeldung</h2>
            <div id="errorMessage" class="error-message">
                Ungültige Anmeldedaten. Bitte versuchen Sie es erneut.
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select id="department" class="form-select" required>
                        <option value="">Bitte wählen...</option>
                        <option value="bau">Bau</option>
                        <option value="technik">Technik | Ernährung</option>
                        <option value="maschinenbau">Maschinenbau</option>
                        <option value="informatik">Informatik | Naturwissenschaften</option>
                        <option value="admin">Administration</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Benutzername</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" class="login-button">Anmelden</button>
            </form>
            <p style="margin-top: 20px; color: #6c757d; font-size: 0.9em; text-align: center;">
            </p>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard-section">
            <!-- User Info Bar -->
            <div class="user-info">
                <div class="user-details">
                    <h3 id="userDepartment">Abteilung</h3>
                    <p id="userName">Benutzer</p>
                </div>
                <button id="logoutBtn" class="logout-button">🚪 Abmelden</button>
            </div>

            <!-- Tab Navigation -->
            <div id="tabNav" class="tab-navigation">
                <button class="tab-button active" data-tab="codes">
                    📝 Code-Verwaltung
                </button>
                <button class="tab-button" data-tab="results">
                    📊 Ergebnisse
                </button>
                <button class="tab-button" data-tab="statistics">
                    📈 Statistiken
                </button>
                <button id="adminTabButton" class="tab-button" data-tab="admin" style="display: none;">
                    ⚙️ Administration
                </button>
            </div>

            <!-- Tab: Code Management -->
            <div id="codesTab" class="tab-content active">
                <div class="code-generator">
                    <h3>Neue Test-Codes generieren</h3>
                    <div class="code-form">
                        <div class="form-group" id="adminDepartmentSelector" style="display: none;">
                            <label class="form-label">Für Abteilung</label>
                            <select id="adminDepartmentSelect" class="form-select">
                                <option value="admin">Administration</option>
                                <option value="bau">Bau</option>
                                <option value="technik">Technik | Ernährung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <input type="text" id="codeDescription" class="form-input" 
                                   placeholder="z.B. Q1 2025 Assessment" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anzahl</label>
                            <input id="codeQuantity" type="number" class="form-input" min="1" max="1000" step="1" value="10">
                        </div>
                        <button id="generateCodesBtn" class="generate-button">
                            Codes generieren
                        </button>
                    </div>
                </div>

                <div class="code-list-header">
                     <h3>Generierte Codes</h3>
                     <div style="display: flex; gap: 10px;">
                         <button id="downloadCodesBtn" class="download-button" disabled>
                            📥 Ausgewählte herunterladen
                         </button>
                         <button id="deleteSelectedBtn" class="delete-button" style="padding: 10px 20px; border-radius: 8px; font-weight: bold;" disabled>
                            🗑️ Ausgewählte löschen
                         </button>
                     </div>
                </div>

                <div class="code-list">
                    <table class="code-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAllCheckbox"></th>
                <th>Code</th>
                <th>Beschreibung</th>
                <th id="deptHeader">Abteilung</th>
                <th>Erstellt am</th>
                <th>Teilnehmer</th>
                <th>Aktionen</th>
            </tr>
        </thead>
    
                        <tbody id="codeTableBody">
                            <!-- Codes will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Results -->
            <div id="resultsTab" class="tab-content">
                <div class="results-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTests">0</div>
                        <div class="stat-label">Durchgeführte Tests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScore">0%</div>
                        <div class="stat-label">Durchschnittlicher Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCodes">0</div>
                        <div class="stat-label">Aktive Codes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">Abschlussrate</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Individuelle Ergebnisse nach Code</h3>
                <div style="margin-bottom: 20px; display:flex; gap:10px; align-items:center;">
                    <select id="codeFilter" class="form-select" style="width: auto;">
                        <option value="">Alle Codes</option>
                    </select>
                    <button id="refreshResultsBtn" class="download-button" type="button">🔄 Neu laden</button>
                </div>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Datum</th>
                            <th>Gesamtscore</th>
                            <th>Bereich 1</th>
                            <th>Bereich 2</th>
                            <th>Bereich 3</th>
                            <th>Bereich 4</th>
                            <th>Bereich 5</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>

                <button id="exportResultsBtn" class="export-button">
                    📥 Ergebnisse exportieren (CSV)
                </button>
            </div>

            <!-- Tab: Statistics -->
            <div id="statisticsTab" class="tab-content">
                <div class="department-chart">
                    <div class="chart-header">Durchschnittliche Scores nach Kompetenzbereich</div>
                    <div class="chart-bars">
                        <div class="chart-bar">
                            <div class="bar-label">Grundkenntnisse IKT</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar1" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Anwendung im Unterricht</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar2" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Medien- & Infokompetenz</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar3" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Daten & Sicherheit</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar4" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Kommunikation</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar5" style="width: 0%;">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="department-chart">
                    <div class="chart-header">Entwicklung über Zeit</div>
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        Hier würde ein Liniendiagramm mit der zeitlichen Entwicklung der Kompetenzen angezeigt werden.
                    </p>
                </div>
            </div>

            <!-- Tab: Admin (only for admin users) -->
            <div id="adminTab" class="tab-content">
                <div class="code-generator">
                    <h3>Benutzerverwaltung</h3>
                    <div class="code-form">
                        <div class="form-group">
                            <label class="form-label">Abteilung</label>
                            <select id="newUserDepartmentSelect" class="form-select">
                                <option value="bau">Bau</option>
                                <option value="technik">Technik | Ernährung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                                <option value="admin">Administration</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Benutzername</label>
                            <input type="text" id="newUsername" class="form-input" placeholder="z.B. mueller">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Passwort</label>
                            <input type="password" id="newPassword" class="form-input" placeholder="Mind. 6 Zeichen">
                        </div>
                        <button id="addUserBtn" class="generate-button">
                            Benutzer hinzufügen
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Bestehende Benutzer</h4>
                        <div id="userList" style="margin-top: 10px; background: white; padding: 15px; border-radius: 8px;">
                            <!-- User list will be populated here -->
                        </div>
                    </div>
                </div>
            
                <h3>Abteilungsübersicht</h3>
                <div class="results-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="allDepartmentsCount">0</div>
                        <div class="stat-label">Aktive Abteilungen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTestsAdmin">0</div>
                        <div class="stat-label">Tests Gesamt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScoreAdmin">0%</div>
                        <div class="stat-label">Gesamt-Durchschnitt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="bestDeptAdmin">-</div>
                        <div class="stat-label">Beste Abteilung</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Abteilungsvergleich</h3>
                
                <!-- New Department Comparison Chart -->
                <div class="dept-comparison-chart">
                    <div class="chart-header">Durchschnittliche Scores nach Abteilung</div>
                    <div class="dept-bars" id="deptBarsChart">
                        <!-- Department bars will be generated here -->
                    </div>
                </div>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Abteilung</th>
                            <th>Anzahl Tests</th>
                            <th>Ø Score</th>
                            <th>Beste Kompetenz</th>
                            <th>Schwächste Kompetenz</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody">
                       <!-- Admin data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal for Details -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Test-Details</h3>
                    <button class="modal-close" data-modal-id="detailModal">×</button>
                </div>
                <div id="modalBody">
                    <!-- Details will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- General Purpose Modal for Alerts/Confirms -->
        <div id="alertModal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                 <div class="modal-header">
                    <h3 id="alertModalTitle">Hinweis</h3>
                    <button class="modal-close" data-modal-id="alertModal">×</button>
                </div>
                <div id="alertModalBody" style="margin: 10px 0 20px; color: #495057; line-height: 1.6;">
                    <!-- Alert/Confirm message goes here -->
                </div>
                <div id="alertModalFooter" style="text-align: right;">
                    <!-- Buttons go here -->
                </div>
            </div>
        </div>
        
    </div>
    
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCHhycjQmHU00_dQl5Xdo5PZCTn8JODk20",
            authDomain: "ikt-komp-bbw.firebaseapp.com",
            projectId: "ikt-komp-bbw",
            storageBucket: "ikt-komp-bbw.firebasestorage.app",
            messagingSenderId: "154620660911",
            appId: "1:154620660911:web:20d389d699d2f0d2c2d85a",
            measurementId: "G-JZ1VC46184"
        });
    </script>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            writeBatch, 
            where, 
            getDocs,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration - Direkt eingebettet
        const firebaseConfig = {
            apiKey: "AIzaSyCHhycjQmHU00_dQl5Xdo5PZCTn8JODk20",
            authDomain: "ikt-komp-bbw.firebaseapp.com",
            projectId: "ikt-komp-bbw",
            storageBucket: "ikt-komp-bbw.firebasestorage.app",
            messagingSenderId: "154620660911",
            appId: "1:154620660911:web:20d389d699d2f0d2c2d85a",
            measurementId: "G-JZ1VC46184"
        };

        const hasValidFirebaseConfig = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId;

        // Initialize Firebase guarded
        let app = null, db = null, auth = null;
        let firebaseReady = false;

        try {
            if (hasValidFirebaseConfig) {
                console.log("Initializing Firebase with config:", firebaseConfig.projectId);
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseReady = true;
                console.log("Firebase erfolgreich initialisiert");
            } else {
                console.warn("Kein gültiges Firebase-Config gefunden – starte im Local-Mode.");
            }
        } catch (e) {
            console.error("Firebase-Initialisierung fehlgeschlagen:", e);
            firebaseReady = false;
        }

        // Firestore Collection References (nur wenn verfügbar)
        let codesCollection = null;
        let resultsCollection = null;
        let accountsDocRef = null;
        if (db) {
            codesCollection = collection(db, 'codes');
            resultsCollection = collection(db, 'results');
            accountsDocRef = doc(db, 'config', 'userAccounts');
        }

        // State Management
        let currentUser = null;
        let currentDepartment = null;
        let generatedCodes = [];
        let testResults = [];
        let userAccounts = {};

        // Global verfügbar machen für Debugging
        window.generatedCodes = generatedCodes;
        window.testResults = testResults;
        window.currentDepartment = currentDepartment;

        const deptNames = {
            'bau': 'Bau',
            'technik': 'Technik | Ernährung',
            'maschinenbau': 'Maschinenbau',
            'informatik': 'Informatik | Naturwissenschaften',
            'admin': 'Administration'
        };
        // HIER DEN FOLGENDEN BLOCK EINFÜGEN

const sections = [
  {
    id: 1,
    name: "Grundkenntnisse IKT",
    subbereiche: [
      { title: "1.1 Geräte und Systeme",            questions: [{id:1},{id:2}] },
      { title: "1.2 Software und Anwendungen",      questions: [{id:3},{id:4}] },
      { title: "1.3 Cloud und digitale Ressourcen", questions: [{id:5},{id:6}] }
    ]
  },
  {
    id: 2,
    name: "Anwendung im Unterricht",
    subbereiche: [
      { title: "2.1 Unterrichtsvorbereitung",       questions: [{id:7},{id:8}] },
      { title: "2.2 Unterrichtsdurchführung",       questions: [{id:9},{id:10}] },
      { title: "2.3 Leistungserfassung und Feedback", questions: [{id:11},{id:12}] }
    ]
  },
  {
    id: 3,
    name: "Medien- und Informationskompetenz",
    subbereiche: [
      { title: "3.1 Informationskompetenz",         questions: [{id:13},{id:14}] },
      { title: "3.2 Medienkompetenz",               questions: [{id:15},{id:16}] },
      { title: "3.3 Kommunikation mit digitalen Medien", questions: [{id:17}] }
    ]
  },
  {
    id: 4,
    name: "Datenverwaltung und Datensicherheit",
    subbereiche: [
      { title: "4.1 Datenschutz und Datensicherheit", questions: [{id:18},{id:19}] },
      { title: "4.2 Datenmanagement",                 questions: [{id:20},{id:21}] },
      { title: "4.3 Rechtliche und ethische Aspekte", questions: [{id:22},{id:23}] }
    ]
  },
  {
    id: 5,
    name: "Kommunikation und Kollaboration",
    subbereiche: [
      { title: "5.1 Digitale Kommunikation",         questions: [{id:24},{id:25}] },
      { title: "5.2 Digitale Kollaboration",         questions: [{id:26},{id:27}] },
      { title: "5.3 Digitale Partizipation",         questions: [{id:28},{id:29}] }
    ]
  }
];
const categoryNames = [
    "Grundkenntnisse IKT",
    "Anwendung im Unterricht",
    "Medien- und Informationskompetenz",
    "Datenverwaltung und Datensicherheit",
    "Kommunikation und Kollaboration"
];
        async function initializeAppWithFirebase() {
            // Wenn Firebase nicht bereit ist: Local-Mode mit Demologins
            if (!firebaseReady || !auth || !db || !accountsDocRef) {
                console.warn("Initialize: Firebase nicht verfügbar – Demologins aktiv.");
                userAccounts = {
                    'bau': { user: 'demo', pass: 'demo123' },
                    'technik': { user: 'demo', pass: 'demo123' },
                    'maschinenbau': { user: 'demo', pass: 'demo123' },
                    'informatik': { user: 'demo', pass: 'demo123' },
                    'admin': { user: 'admin', pass: 'admin123' }
                };
                return;
            }

            try {
                // Sign in using the provided token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                const docSnap = await getDoc(accountsDocRef);
                if (docSnap.exists()) {
                    userAccounts = docSnap.data();
                    console.log("User accounts loaded from Firestore");
                } else {
                    console.log("No account config found, creating default accounts...");
                    userAccounts = {
                        'bau': [],
                        'technik': [],
                        'maschinenbau': [],
                        'informatik': [],
                        'admin': [{ user: 'admin', pass: 'admin123' }]
                    };
                    await setDoc(accountsDocRef, userAccounts);
                }

                // Real-time listeners mit besserer Fehlerbehandlung
                if (codesCollection) {
                    const unsubscribeCodes = onSnapshot(codesCollection, 
                        (snapshot) => {
                            generatedCodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.generatedCodes = generatedCodes; // Global verfügbar machen
                            console.log("Codes aktualisiert:", generatedCodes.length);
                            if (currentUser) {
                                loadDashboardData();
                                if (document.getElementById('resultsTab').classList.contains('active')) { loadResultsData(); }
                                if (document.getElementById('statisticsTab').classList.contains('active')) { loadStatisticsData(); }
                            }
                        },
                        (error) => {
                            console.error("Fehler beim Codes-Listener:", error);
                        }
                    );
                }

                if (resultsCollection) {
                    const unsubscribeResults = onSnapshot(resultsCollection, 
                        (snapshot) => {
                            testResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.testResults = testResults; // Global verfügbar machen
                            console.log("Results aktualisiert:", testResults.length);
                            if (currentUser) {
                                updateStatistics();
                                if (document.getElementById('resultsTab').classList.contains('active')) { loadResultsData(); }
                                if (document.getElementById('statisticsTab').classList.contains('active')) { loadStatisticsData(); }
                            }
                        },
                        (error) => {
                            console.error("Fehler beim Results-Listener:", error);
                        }
                    );
                }

                // Initiale Daten laden
                await loadInitialData();
                
            } catch (error) {
                console.error('Fehler bei der Firebase-Initialisierung:', error);
                // Fallback auf Local-Mode
                if (!userAccounts || Object.keys(userAccounts).length === 0) {
                    userAccounts = {
                        'bau': [],
                        'technik': [],
                        'maschinenbau': [],
                        'informatik': [],
                        'admin': [{ user: 'admin', pass: 'admin123' }]
                    };
                }
            }
        }

        // Neue Funktion: Initiale Daten laden
        async function loadInitialData() {
            console.log("Loading initial data...");
            
            if (!firebaseReady || !codesCollection || !resultsCollection) {
                console.log("Firebase not ready or collections not available");
                // Generate some test data for local testing
                if (generatedCodes.length === 0) {
                    console.log("No codes available, running in local mode");
                }
                if (testResults.length === 0) {
                    console.log("No test results available");
                }
                return;
            }
            
            try {
                // Codes manuell laden
                const codesSnapshot = await getDocs(codesCollection);
                generatedCodes = codesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.generatedCodes = generatedCodes;
                console.log("Initiale Codes geladen:", generatedCodes.length);
                
                // Results manuell laden
                const resultsSnapshot = await getDocs(resultsCollection);
                testResults = resultsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.testResults = testResults;
                console.log("Initiale Results geladen:", testResults.length);
                
                // Log first result for debugging if available
                if (testResults.length > 0) {
                    console.log("Sample result structure:", testResults[0]);
                }
            } catch (error) {
                console.error("Fehler beim initialen Laden:", error);
                // Initialize empty arrays on error
                generatedCodes = generatedCodes || [];
                testResults = testResults || [];
            }
        }

        
        // ---- Helpers ----
        function toJsDate(ts) {
            if (!ts) return null;
            if (typeof ts === 'string') return new Date(ts);
            if (typeof ts === 'number') return new Date(ts);
            if (typeof ts === 'object') {
                if (typeof ts.toDate === 'function') return ts.toDate();
                if (typeof ts.seconds === 'number') return new Date(ts.seconds * 1000);
            }
            return null;
        }
        function getCat(result, idx) {
            const cp = result && result.categoryPercentages ? result.categoryPercentages : {};
            return cp[idx] ?? cp[String(idx)] ?? 0;
        }
        
        // Login Handler with Back Button hiding
        async function handleLogin(event) {
            event.preventDefault();
            
            const department = document.getElementById('department').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const account = userAccounts[department];
            
            // Check if login is valid
            let loginOk = false;
            
            // If account is an array, check all users
            if (Array.isArray(account)) {
                loginOk = account.some(acc => username === acc.user && password === acc.pass);
            } 
            // If account is a single object (legacy format)
            else if (account && typeof account === 'object' && account.user) {
                loginOk = (username === account.user && password === account.pass);
            }
            
            // Demo login is allowed if:
            // 1. No users exist for the department (empty array or no account)
            // 2. Department is not admin
            const demoAllowed = (
                (!account || (Array.isArray(account) && account.length === 0)) && 
                department && 
                department !== 'admin'
            );
            
            // Accept login if either regular login is valid OR demo login is allowed
            if ((loginOk && department) || (demoAllowed && username === 'demo' && password === 'demo123')) {
                currentUser = username;
                currentDepartment = department;
                window.currentDepartment = department; // Global verfügbar machen
                
                // Hide login section and back button
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('backButton').classList.add('hidden');
                document.getElementById('dashboardSection').classList.add('active');
                
                document.getElementById('userDepartment').textContent = deptNames[department] || department;
                document.getElementById('userName').textContent = `Benutzer: ${username}`;
                
                const isAdmin = department === 'admin';
                document.getElementById('adminTabButton').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('adminDepartmentSelector').style.display = isAdmin ? 'block' : 'none';
                
                // Nach Login: Daten neu laden
                await loadInitialData();
                loadDashboardData();
                
                // If admin, load user list
                if (isAdmin) {
                    loadUserList();
                }
            } else {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                setTimeout(() => {
                   errorMessage.style.display = 'none';
                }, 3000);
            }
        }

        // Logout Handler with Back Button showing
        function handleLogout() {
            currentUser = null;
            currentDepartment = null;
            window.currentDepartment = null;
            
            // Show login section and back button
            document.getElementById('dashboardSection').classList.remove('active');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('backButton').classList.remove('hidden');
            document.getElementById('adminTabButton').style.display = 'none';
            
            // Clear form
            document.getElementById('department').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Reset to first tab
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector('.tab-button[data-tab="codes"]').classList.add('active');
            document.getElementById('codesTab').classList.add('active');
        }

        // Tab Switching - Fixed version
        function switchTab(tabButton) {
            try {
                const tabName = tabButton.dataset.tab;
                console.log("Switching to tab:", tabName);
                
                if (!tabName) {
                    console.error("No tab name found on button");
                    return;
                }
                
                // Remove active class from all buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active to clicked button
                tabButton.classList.add('active');
                
                // Remove active class from all content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Add active class to selected tab
                const targetTab = document.getElementById(tabName + 'Tab');
                if (targetTab) {
                    targetTab.classList.add('active');
                    
                    // Load data for specific tabs
                    if (tabName === 'results') {
                        loadResultsData();
                    } else if (tabName === 'statistics') {
                        loadStatisticsData();
                    } else if (tabName === 'admin') {
                        loadAdminData();
                    }
                } else {
                    console.error("Tab content not found:", tabName + 'Tab');
                    // List all available tabs for debugging
                    console.log("Available tabs:", Array.from(document.querySelectorAll('.tab-content')).map(el => el.id));
                }
            } catch (error) {
                console.error("Error in switchTab:", error);
                console.error("Error details:", error.stack);
            }
        }

        // Hilfsfunktion zum Generieren eines zufälligen Codes
        function generateRandomCode() {
            const part1 = Math.random().toString(36).substring(2, 6).toUpperCase();
            const part2 = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${part1}-${part2}`;
        }

        // Generate Codes Function
        async function generateCodes() {
            try {
                const description = document.getElementById('codeDescription').value.trim();
                const quantity = parseInt(document.getElementById('codeQuantity').value);
                
                const isAdmin = currentDepartment === 'admin';
                const targetDepartment = isAdmin 
                    ? document.getElementById('adminDepartmentSelect').value 
                    : currentDepartment;

                if (!description) {
                    showCustomAlert('Bitte alle Felder ausfüllen.');
                    return;
                }

                // Check if Firebase is available
                if (!firebaseReady || !db) {
                    // Local Mode - nur in Arrays speichern
                    const newCodes = [];
                    for (let i = 0; i < quantity; i++) {
                        const code = generateRandomCode();
                        const newCode = {
                            id: 'local_' + Date.now() + '_' + i,
                            code: code,
                            description: description,
                            department: targetDepartment,
                            created: new Date().toLocaleDateString('de-DE'),
                            
                            
                            timestamp: Date.now()
                        };
                        generatedCodes.push(newCode);
                        newCodes.push(code);
                    }
                    
                    window.generatedCodes = generatedCodes;
                    showCustomAlert(`${quantity} Code(s) wurden lokal generiert: ${newCodes.join(', ')}`);
                    loadDashboardData();
                    
                    // Reset form
                    document.getElementById('codeDescription').value = '';
                    
                    return;
                }

                // Firebase Mode
                const newCodes = [];
                for (let i = 0; i < quantity; i++) {
                    const code = generateRandomCode();
                    
                    const codeData = {
    code: code,
    description: description,
    department: targetDepartment,
    created: new Date().toLocaleDateString('de-DE'),
    createdTimestamp: serverTimestamp()
};

                    await addDoc(codesCollection, codeData);
                    newCodes.push(code);
                }

                showCustomAlert(`${quantity} Code(s) wurden erfolgreich generiert: ${newCodes.join(', ')}`);
                
                // Reset form
                document.getElementById('codeDescription').value = '';
                
                
                // Reload data
                setTimeout(async () => {
                    await loadInitialData();
                    loadDashboardData();
                }, 1500);
                
            } catch (error) {
                console.error('Fehler beim Generieren der Codes:', error);
                showCustomAlert('Fehler beim Generieren der Codes: ' + error.message);
            }
        }

        
        // Load Dashboard Data
        function loadDashboardData() {
            const codeTableBody = document.getElementById('codeTableBody');
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);

            console.log("LoadDashboard - Alle Codes:", generatedCodes.length, "Department Codes:", departmentCodes.length);

            document.getElementById('selectAllCheckbox').checked = false;
            updateDownloadButtonState();

            if (departmentCodes.length === 0) {
                 codeTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #6c757d; padding: 20px;">Keine Codes für diese Abteilung vorhanden.</td></tr>`;
                 return;
            }

            // show/hide Abteilung column in header
            const deptHeader = document.getElementById('deptHeader');
            if (deptHeader) deptHeader.style.display = isAdmin ? '' : 'none';

            codeTableBody.innerHTML = departmentCodes.sort((a,b) => {
                if (a.timestamp && b.timestamp) {
                    return b.timestamp - a.timestamp;
                }
                return new Date(b.created) - new Date(a.created);
            }).map(code => {
                const participants = testResults.filter(r => r.testCode === code.code).length;

                return `
                    <tr data-doc-id="${code.id}" data-code="${code.code}">
                        <td><input type="checkbox" class="code-checkbox" value="${code.code}"></td>
                        <td><span class="code-badge">${code.code}</span></td>
                        <td>${code.description}</td>
                        <td style="display: ${isAdmin ? '' : 'none'}">${deptNames[code.department] || code.department}</td>
                        <td>${code.created}</td>
                        <td>${participants}</td>
                        <td>
                            <button class="action-button view-button">Ansehen</button>
                            <button class="action-button delete-button">Löschen</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateStatistics();
        }
        
        window.loadDashboardData = loadDashboardData;


        // Load Results Data
        function loadResultsData() {
            console.log("Loading results data...");
            console.log("Test Results available:", testResults.length);
            
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => r && r.testCode && codeList.includes(r.testCode));
            
            console.log("Department codes:", codeList);
            console.log("Relevant results:", relevantResults.length);
            
            const codeFilter = document.getElementById('codeFilter');
            if (codeFilter) {
                codeFilter.innerHTML = '<option value="">Alle Codes</option>' + 
                    codeList.map(code => `<option value="${code}">${code}</option>`).join('');
            }
            
            displayResults(relevantResults);
        }

        // Display Results
        function displayResults(results) {
            const resultsTableBody = document.getElementById('resultsTableBody');
            
            if (!results || results.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #6c757d; padding: 20px;">Keine Ergebnisse vorhanden</td></tr>';
                return;
            }
            
            resultsTableBody.innerHTML = results.sort((a,b) => {
                const dateA = toJsDate(a.timestamp) || new Date(0);
                const dateB = toJsDate(b.timestamp) || new Date(0);
                return dateB - dateA;
            }).map(result => {
                const scoreClass = result.totalPercentage >= 80 ? 'score-high' : 
                   result.totalPercentage >= 60 ? 'score-medium' : 
                   result.totalPercentage >= 40 ? 'score-needs-improvement' : 
                   'score-low';
                
                return `
                    <tr data-doc-id="${result.id}">
                        <td><span class="code-badge">${result.testCode}</span></td>
                        <td>${(toJsDate(result.timestamp) || null) ? toJsDate(result.timestamp).toLocaleDateString('de-DE') : 'N/A'}</td>
                        <td><span class="score-badge ${scoreClass}">${result.totalPercentage || 0}%</span></td>
                        <td>${getCat(result,1)}%</td>
                        <td>${getCat(result,2)}%</td>
                        <td>${getCat(result,3)}%</td>
                        <td>${getCat(result,4)}%</td>
                        <td>${getCat(result,5)}%</td>
                        <td>
                            <button class="action-button view-button">Details</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load Statistics Data
        function loadStatisticsData() {
            console.log("Loading statistics data...");
            const departmentCodes = currentDepartment === 'admin' 
                ? generatedCodes 
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => r && r.testCode && codeList.includes(r.testCode));
            
            console.log("Statistics - Relevant results:", relevantResults.length);
            
            if (relevantResults.length > 0) {
                for (let i = 1; i <= 5; i++) {
                    const scores = relevantResults
                        .map(r => getCat(r, i) || 0)
                        .filter(score => !isNaN(score));
                    
                    const avg = scores.length > 0 
                        ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
                        : 0;
                    
                    const bar = document.getElementById(`bar${i}`);
                    if (bar) {
                        bar.style.width = avg + '%';
                        bar.textContent = avg + '%';
                    }
                }
            } else {
                for (let i = 1; i <= 5; i++) {
                    const bar = document.getElementById(`bar${i}`);
                    if (bar) {
                        bar.style.width = '0%';
                        bar.textContent = '0%';
                    }
                }
            }
        }
        
        // Load Admin specific data with improved department comparison
        function loadAdminData() {
            console.log("Loading admin data...");
            const adminTableBody = document.getElementById('adminTableBody');
            const departments = Object.keys(deptNames).filter(d => d !== 'admin');
            document.getElementById('allDepartmentsCount').textContent = departments.length;
            
            let bestDept = { name: '-', score: 0 };
            const deptStats = [];
            
            const tableRows = departments.map(deptKey => {
                const deptCodes = generatedCodes.filter(c => c.department === deptKey).map(c => c.code);
                const deptResults = testResults.filter(r => r && r.testCode && deptCodes.includes(r.testCode));
                
                if (deptResults.length === 0) {
                    deptStats.push({ dept: deptKey, name: deptNames[deptKey], score: 0, tests: 0 });
                    return `<tr><td>${deptNames[deptKey]}</td><td>0</td><td>N/A</td><td>N/A</td><td>N/A</td><td>-</td></tr>`;
                }

                const validResults = deptResults.filter(r => r.totalPercentage !== undefined);
                if (validResults.length === 0) {
                    deptStats.push({ dept: deptKey, name: deptNames[deptKey], score: 0, tests: 0 });
                    return `<tr><td>${deptNames[deptKey]}</td><td>0</td><td>N/A</td><td>N/A</td><td>N/A</td><td>-</td></tr>`;
                }

                const avgScore = Math.round(validResults.reduce((sum, r) => sum + (r.totalPercentage || 0), 0) / validResults.length);
                const scoreClass = avgScore >= 80 ? 'score-high' : 
                   avgScore >= 60 ? 'score-medium' : 
                   avgScore >= 40 ? 'score-needs-improvement' : 
                   'score-low';
                
                // Track best department
                if (avgScore > bestDept.score) {
                    bestDept = { name: deptNames[deptKey], score: avgScore };
                }
                
                deptStats.push({ dept: deptKey, name: deptNames[deptKey], score: avgScore, tests: deptResults.length });
                
                const categoryAvgs = [];
                for (let i = 1; i <= 5; i++) {
                    const scores = validResults
                        .filter(r => r.categoryPercentages && r.categoryPercentages[i] !== undefined)
                        .map(r => r.categoryPercentages[i]);
                    
                    if (scores.length > 0) {
                        categoryAvgs.push({
                            name: i,
                            avg: Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
                        });
                    }
                }
                
                if (categoryAvgs.length === 0) {
                    return `<tr><td>${deptNames[deptKey]}</td><td>${deptResults.length}</td><td><span class="score-badge ${scoreClass}">${avgScore}%</span></td><td>N/A</td><td>N/A</td><td>-</td></tr>`;
                }
                
                categoryAvgs.sort((a,b) => b.avg - a.avg);
                const bestCat = categoryAvgs[0].name;
                const worstCat = categoryAvgs[categoryAvgs.length - 1].name;
                const catNames = ["Grundkenntnisse IKT", "Anwendung im Unterricht", "Medien- & Infokompetenz", "Daten & Sicherheit", "Kommunikation"];
                
                // Calculate trend (simplified - just showing if above or below average)
                const overallAvg = deptStats.filter(d => d.score > 0).reduce((sum, d) => sum + d.score, 0) / deptStats.filter(d => d.score > 0).length || 0;
                const trend = avgScore > overallAvg ? '📈' : avgScore < overallAvg ? '📉' : '➡️';

                return `
                    <tr>
                        <td>${deptNames[deptKey]}</td>
                        <td>${deptResults.length}</td>
                        <td><span class="score-badge ${scoreClass}">${avgScore}%</span></td>
                        <td>${catNames[bestCat-1]}</td>
                        <td>${catNames[worstCat-1]}</td>
                        <td style="font-size: 1.2em;">${trend}</td>
                    </tr>`;
            }).join('');
            
            adminTableBody.innerHTML = tableRows;
            
            // Update best department
            document.getElementById('bestDeptAdmin').textContent = bestDept.name;
            
            // Create department comparison bars
            const deptBarsChart = document.getElementById('deptBarsChart');
            const maxScore = Math.max(...deptStats.map(d => d.score), 100);
            
            deptBarsChart.innerHTML = deptStats.map(dept => {
                const height = dept.score > 0 ? (dept.score / maxScore) * 100 : 5;
                const color = dept.score >= 80 ? '#28a745' : dept.score >= 60 ? '#ffc107' : dept.score > 0 ? '#dc3545' : '#dee2e6';
                
                return `
                    <div class="dept-bar-group">
                        <div class="dept-bar" style="height: ${height}%; background: ${color};">
                            ${dept.score > 0 ? dept.score + '%' : ''}
                        </div>
                        <div class="dept-bar-label">${dept.name}</div>
                    </div>
                `;
            }).join('');
            
            updateStatistics();
            
            // Load user list for admin
            loadUserList();
        }

        
        // --- Admin User Edit State ---
        let __editingDept = null;
        let __editingUser = null;
        
        // Load User List for Admin
        function loadUserList() {
            if (currentDepartment !== 'admin') return;
            
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            let html = '';
            for (const [dept, users] of Object.entries(userAccounts)) {
                html += `<div style="margin-bottom: 15px;">`;
                html += `<strong>${deptNames[dept] || dept}:</strong><br>`;
                
                if (Array.isArray(users) && users.length > 0) {
                    users.forEach(user => {
                        html += `<div style=\"margin-left: 20px; padding: 5px;\">`;
                        html += `${user.user} `;
                        html += `<button class=\"action-button view-button\" onclick=\"editUser('${dept}', '${user.user}')\">Bearbeiten</button>`;
                        html += `<button class=\"action-button delete-button\" onclick=\"removeUser('${dept}', '${user.user}')\">Entfernen</button>`;
                        html += `</div>`;
                    });
                } else if (users && typeof users === 'object' && users.user) {
                    html += `<div style="margin-left: 20px; padding: 5px;">`;
                    html += `${users.user} `;
                    html += `<button class=\"action-button view-button\" onclick=\"editUser('${dept}', '${users.user}')\">Bearbeiten</button>`;
                    html += `<button class=\"action-button delete-button\" onclick=\"removeUser('${dept}', '${users.user}')\">Entfernen</button>`;
                    html += `</div>`;
                } else {
                    html += `<div style="margin-left: 20px; color: #6c757d; padding: 5px;">Keine Benutzer (Demo-Login aktiv)</div>`;
                }
                html += `</div>`;
            }
            userList.innerHTML = html;
        }

        
       // Start editing an existing user
        window.editUser = function(dept, username) {
            __editingDept = dept;
            __editingUser = username;
            const formDept = document.getElementById('userDepartment');
            const userInput = document.getElementById('newUsername');
            const passInput = document.getElementById('newPassword');
            
            // Set and disable department selector during edit
            if (formDept) {
                formDept.value = dept;
                formDept.disabled = true;
                document.getElementById('deptEditHint').style.display = 'block';
            }
            
            if (userInput) userInput.value = username;
            if (passInput) {
                passInput.value = '';
                passInput.placeholder = 'Leer lassen für keine Änderung';
            }
            
            const btn = document.getElementById('addUserBtn');
            if (btn) btn.textContent = 'Änderungen speichern';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
            
            showCustomAlert('Bearbeitungsmodus für ' + username + ' (' + (deptNames[dept] || dept) + '): Benutzerdaten anpassen und „Änderungen speichern" klicken.');
        };
        
        // Cancel edit mode
        window.cancelEdit = function() {
            __editingDept = null;
            __editingUser = null;
            
            const formDept = document.getElementById('newUserDepartmentSelect');
            if (formDept) {
                formDept.disabled = false;
                document.getElementById('deptEditHint').style.display = 'none';
            }
            
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newPassword').placeholder = 'Mind. 6 Zeichen';
            
            const btn = document.getElementById('addUserBtn');
            if (btn) btn.textContent = 'Benutzer hinzufügen';
            
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) cancelBtn.style.display = 'none';
        };

        async function saveEditUser() {
            const dept = document.getElementById('newUserDepartmentSelect').value;
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;

            if (!__editingDept || !__editingUser) return false;

            if (!Array.isArray(userAccounts[dept])) {
                if (userAccounts[dept] && userAccounts[dept].user) userAccounts[dept] = [userAccounts[dept]];
                else userAccounts[dept] = [];
            }
            if (dept === __editingDept) {
                const idx = userAccounts[dept].findIndex(u => u.user === __editingUser);
                if (idx >= 0) {
                    userAccounts[dept][idx] = { user: username, pass: (password || userAccounts[dept][idx].pass) };
                }
            } else {
                if (Array.isArray(userAccounts[__editingDept])) {
                    userAccounts[__editingDept] = userAccounts[__editingDept].filter(u => u.user != __editingUser);
                }
                userAccounts[dept].push({ user: username, pass: password || 'changeme' });
            }

            if (firebaseReady && accountsDocRef) {
                await setDoc(accountsDocRef, userAccounts);
            }

            __editingDept = null;
            __editingUser = null;
            const btn = document.getElementById('addUserBtn');
            if (btn) btn.textContent = 'Benutzer hinzufügen';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            loadUserList();
            showCustomAlert('Benutzerdaten wurden gespeichert.');
            return true;
        }

        // Add User Function
        async function addUser() {
            if (__editingDept && __editingUser) { await saveEditUser(); return; }
            const dept = document.getElementById('newUserDepartmentSelect').value;
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;

            if (!username || password.length < 6) {
                showCustomAlert('Benutzername darf nicht leer sein und Passwort muss mindestens 6 Zeichen haben.');
                return;
            }

            // Convert to array format if needed
            if (!Array.isArray(userAccounts[dept])) {
                if (userAccounts[dept] && userAccounts[dept].user) {
                    userAccounts[dept] = [userAccounts[dept]];
                } else {
                    userAccounts[dept] = [];
                }
            }

            // Check if user already exists
            if (userAccounts[dept].some(u => u.user === username)) {
                showCustomAlert('Benutzer existiert bereits für diese Abteilung.');
                return;
            }

            // Add new user
            userAccounts[dept].push({ user: username, pass: password });

            // Save to Firestore if available
            if (firebaseReady && accountsDocRef) {
                try {
                    await setDoc(accountsDocRef, userAccounts);
                    showCustomAlert(`Benutzer ${username} wurde erfolgreich hinzugefügt.`);
                } catch (error) {
                    console.error('Fehler beim Speichern:', error);
                    showCustomAlert('Fehler beim Speichern: ' + error.message);
                }
            } else {
                showCustomAlert(`Benutzer ${username} wurde lokal hinzugefügt.`);
            }

            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            
            // Reload user list
            loadUserList();
        }

        // Remove User Function (global for inline onclick)
        window.removeUser = async function(dept, username) {
            showCustomConfirm(
                `Möchten Sie den Benutzer <strong>${username}</strong> aus der Abteilung <strong>${deptNames[dept]}</strong> wirklich entfernen?`,
                "Entfernen",
                async () => {
                    if (Array.isArray(userAccounts[dept])) {
                        userAccounts[dept] = userAccounts[dept].filter(u => u.user !== username);
                    } else if (userAccounts[dept] && userAccounts[dept].user === username) {
                        userAccounts[dept] = [];
                    }

                    // Save to Firestore if available
                    if (firebaseReady && accountsDocRef) {
                        try {
                            await setDoc(accountsDocRef, userAccounts);
                            showCustomAlert(`Benutzer ${username} wurde entfernt.`);
                        } catch (error) {
                            console.error('Fehler beim Speichern:', error);
                            showCustomAlert('Fehler beim Speichern: ' + error.message);
                        }
                    } else {
                        showCustomAlert(`Benutzer ${username} wurde lokal entfernt.`);
                    }

                    loadUserList();
                }
            );
        };

        // Update Statistics
        function updateStatistics() {
            console.log("Updating statistics...");
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => r && r.testCode && codeList.includes(r.testCode));
            
            console.log("Stats - Department codes:", departmentCodes.length, "Results:", relevantResults.length);
            
            document.getElementById('totalTests').textContent = relevantResults.length;
            document.getElementById('activeCodes').textContent = departmentCodes.length;
            
            if (relevantResults.length > 0) {
                const validResults = relevantResults.filter(r => typeof r.totalPercentage === 'number');
                if (validResults.length > 0) {
                    const avgScore = Math.round(validResults.reduce((sum, r) => sum + (r.totalPercentage || 0), 0) / validResults.length);
                    document.getElementById('avgScore').textContent = avgScore + '%';
                } else {
                    document.getElementById('avgScore').textContent = '0%';
                }
                
                const totalCodes = departmentCodes.length;
                const usedCodes = new Set(relevantResults.map(r => r.testCode)).size;
                const completionRate = totalCodes > 0 ? Math.round((usedCodes / totalCodes) * 100) : 0;
                document.getElementById('completionRate').textContent = completionRate + '%';
            } else {
                document.getElementById('avgScore').textContent = '0%';
                document.getElementById('completionRate').textContent = '0%';
            }
            
            if (isAdmin) {
                document.getElementById('totalTestsAdmin').textContent = testResults.length;
                const validAdminResults = testResults.filter(r => r && typeof r.totalPercentage === 'number');
                if (validAdminResults.length > 0) {
                    const avgScoreAdmin = Math.round(validAdminResults.reduce((sum, r) => sum + (r.totalPercentage || 0), 0) / validAdminResults.length);
                    document.getElementById('avgScoreAdmin').textContent = avgScoreAdmin + '%';
                } else {
                    document.getElementById('avgScoreAdmin').textContent = '0%';
                }
            }
        }

        // View Code Details
        function viewCodeDetails(docId) {
            const codeData = generatedCodes.find(c => c.id === docId);
            const codeResults = testResults.filter(r => r.testCode === codeData.code);
            
            document.getElementById('modalTitle').textContent = `Details für Code: ${codeData.code}`;
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <p><strong>Beschreibung:</strong> ${codeData.description}</p>
                <p><strong>Abteilung:</strong> ${deptNames[codeData.department]}</p>
                <p><strong>Erstellt:</strong> ${codeData.created}</p>
                <p><strong>Teilnehmer:</strong> ${codeResults.length}</p>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

         // View Result Details (Version 4 - mit Prozentwerten pro Unterbereich)
        function viewResultDetails(docId) {
            const result = testResults.find(r => r.id === docId);
            if (!result) {
                return showCustomAlert('Ergebnis-Details konnten nicht geladen werden.');
            }

            document.getElementById('modalTitle').textContent = `Detailergebnis für Code: ${result.testCode}`;
            const modalBody = document.getElementById('modalBody');
            
            let scoreClass, scoreText;
if (result.totalPercentage >= 80) { 
    scoreClass = 'score-high'; 
    scoreText = 'Ausgezeichnet!'; 
} else if (result.totalPercentage >= 60) { 
    scoreClass = 'score-medium'; 
    scoreText = 'Gut!'; 
} else if (result.totalPercentage >= 40) { 
    scoreClass = 'score-needs-improvement'; 
    scoreText = 'Sie sind auf einem guten Weg! In einigen Bereichen gibt es noch Entwicklungspotenzial.'; 
} else { 
    scoreClass = 'score-low'; 
    scoreText = 'Sie haben erste Grundlagen gelegt. Mit gezielter Weiterbildung können Sie Ihre Kompetenzen ausbauen.'; 
}

            // Prüfen, ob detaillierte Antworten vorhanden sind
            if (result.answers) {
                // NEUE ANSICHT MIT PROZENTEN PRO UNTERBEREICH
                let detailsHTML = sections.map(section => {
                    let subbereicheHTML = section.subbereiche.map(subbereich => {
                        let subScore = 0;
                        let subMaxScore = 0;
                        
                        subbereich.questions.forEach(question => {
                            if (result.answers[question.id] !== undefined) {
                                subScore += result.answers[question.id];
                                subMaxScore += 4; // Jede Frage hat einen Maximalwert von 4
                            }
                        });

                        const subPercent = subMaxScore > 0 ? Math.round((subScore / subMaxScore) * 100) : 0;
                        const barColor = subPercent >= 80 ? '#28a745' : 
                 subPercent >= 60 ? '#ffc107' : 
                 subPercent >= 40 ? '#ff9800' : 
                 '#ff69b4';
                        
                        return `
                            <div class="category-result" style="padding: 10px 15px; margin-bottom: 8px;">
                                <div class="category-result-header" style="margin-bottom: 5px;">
                                    <span class="category-result-title">${subbereich.title}</span>
                                    <span class="category-result-score">${subPercent}%</span>
                                </div>
                                <div class="result-bar-container" style="height: 10px;">
                                    <div class="result-bar" style="width: ${subPercent}%; background: ${barColor};"></div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `<h3 style="margin-top: 25px; margin-bottom: 10px; font-size: 1.2em;">${section.name} (${result.categoryPercentages[section.id]}%)</h3>${subbereicheHTML}`;
                }).join('');

                modalBody.innerHTML = `
                    <div style="text-align: center;">
                        <div class="score-circle ${scoreClass}">${result.totalPercentage}%</div>
                        <p style="font-size: 1.1em; color: #495057;">${scoreText}</p>
                    </div>
                    <hr style="margin: 20px 0;">
                    ${detailsHTML}
                `;

            } else {
                // ALTE ANSICHT (für Ergebnisse ohne Detail-Antworten)
                const categoriesHTML = categoryNames.map((name, i) => {
                    const p = getCat(result, i + 1);
                    const bc = (p >= 80 ? '#28a745' : 
            p >= 60 ? '#ffc107' : 
            p >= 40 ? '#ff9800' : 
            '#ff69b4');
                    return `<div class="category-result"><div class="category-result-header"><span class="category-result-title">${name}</span><span class="category-result-score">${p}%</span></div><div class="result-bar-container"><div class="result-bar" style="width: ${p}%; background: ${bc};"></div></div></div>`;
                }).join('');
                
                modalBody.innerHTML = `
                    <div style="text-align: center;">
                        <div class="score-circle ${scoreClass}">${result.totalPercentage}%</div>
                        <p style="font-size: 1.1em; color: #495057;">${scoreText}</p>
                        <p style="font-size: 0.9em; color: #718096; margin-top: 15px;">(Für dieses Ergebnis ist keine Detailansicht der Unterbereiche verfügbar.)</p>
                    </div>
                    <hr style="margin: 20px 0;">
                    <h4>Kompetenzbereiche</h4>
                    ${categoriesHTML}
                `;
            }

            document.getElementById('detailModal').classList.add('active');
        }
        // Delete Code
        async function deleteCode(docId, code) {
            showCustomConfirm(
                `Möchten Sie den Code <strong>${code}</strong> wirklich löschen? Alle zugehörigen Ergebnisse werden ebenfalls entfernt.`,
                "Löschen",
                async () => {
                    try {
                        if (firebaseReady && db) {
                            // Firebase Mode
                            await deleteDoc(doc(db, "codes", docId));
                            
                            // Delete related results
                            const q = query(resultsCollection, where("testCode", "==", code));
                            const querySnapshot = await getDocs(q);
                            const batch = writeBatch(db);
                            querySnapshot.forEach((doc) => batch.delete(doc.ref));
                            await batch.commit();
                            
                            generatedCodes = generatedCodes.filter(c => c.id !== docId);
                            testResults = testResults.filter(r => r.testCode !== code);
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            
                            loadDashboardData();
                            showCustomAlert(`Code ${code} wurde gelöscht.`);
                        } else {
                            // Local mode
                            generatedCodes = generatedCodes.filter(c => c.id !== docId);
                            testResults = testResults.filter(r => r.testCode !== code);
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            loadDashboardData();
                            showCustomAlert(`Code ${code} wurde lokal gelöscht.`);
                        }
                    } catch (error) {
                        console.error("Fehler beim Löschen:", error);
                        showCustomAlert(`Fehler beim Löschen: ${error.message}`);
                    }
                }
            );
        }

        // Delete Selected Codes
        async function deleteSelectedCodes() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            const selectedCodes = Array.from(checkedBoxes).map(cb => {
                const row = cb.closest('tr');
                return {
                    id: row.dataset.docId,
                    code: cb.value
                };
            });

            if (selectedCodes.length === 0) return;

            const codeList = selectedCodes.map(c => c.code).join(', ');
            
            showCustomConfirm(
                `Möchten Sie wirklich <strong>${selectedCodes.length}</strong> Code(s) löschen?<br><br>Codes: ${codeList}<br><br>Alle zugehörigen Ergebnisse werden ebenfalls entfernt.`,
                "Alle löschen",
                async () => {
                    try {
                        if (firebaseReady && db) {
                            const batch = writeBatch(db);
                            
                            for (const codeObj of selectedCodes) {
                                const docRef = doc(db, "codes", codeObj.id);
                                batch.delete(docRef);
                                
                                const q = query(resultsCollection, where("testCode", "==", codeObj.code));
                                const querySnapshot = await getDocs(q);
                                querySnapshot.forEach((resultDoc) => {
                                    batch.delete(resultDoc.ref);
                                });
                            }
                            
                            await batch.commit();
                            
                            const codeIds = selectedCodes.map(c => c.id);
                            const codes = selectedCodes.map(c => c.code);
                            generatedCodes = generatedCodes.filter(c => !codeIds.includes(c.id));
                            testResults = testResults.filter(r => !codes.includes(r.testCode));
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            
                            loadDashboardData();
                            showCustomAlert(`${selectedCodes.length} Code(s) wurden gelöscht.`);
                        } else {
                            const codeIds = selectedCodes.map(c => c.id);
                            const codes = selectedCodes.map(c => c.code);
                            generatedCodes = generatedCodes.filter(c => !codeIds.includes(c.id));
                            testResults = testResults.filter(r => !codes.includes(r.testCode));
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            loadDashboardData();
                            showCustomAlert(`${selectedCodes.length} Code(s) wurden lokal gelöscht.`);
                        }
                    } catch (error) {
                        console.error("Fehler beim Batch-Löschen:", error);
                        showCustomAlert(`Fehler beim Löschen: ${error.message}`);
                    }
                }
            );
        }

        // Modal and UI Helper Functions
        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('active');
        }

        function showCustomAlert(message) {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertModalTitle').textContent = 'Hinweis';
            document.getElementById('alertModalBody').innerHTML = `<p>${message}</p>`;
            document.getElementById('alertModalFooter').innerHTML = 
                `<button class="login-button" style="width: auto; padding: 10px 30px;" onclick="document.getElementById('alertModal').classList.remove('active')">OK</button>`;
            modal.classList.add('active');
        }
        window.showCustomAlert = showCustomAlert;
        
        function showCustomConfirm(message, confirmText, onConfirm) {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertModalTitle').textContent = 'Bestätigung erforderlich';
            document.getElementById('alertModalBody').innerHTML = `<p>${message}</p>`;
            document.getElementById('alertModalFooter').innerHTML = `
                <button class="logout-button" style="background: #6c757d; color: white; border: none; margin-right: 10px;" id="confirmCancelBtn">Abbrechen</button>
                <button class="login-button" style="background: #dc3545;" id="confirmOkBtn">${confirmText}</button>`;
            
            modal.classList.add('active');

            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');

            const handleConfirm = (result) => {
                closeModal('alertModal');
                if (result) onConfirm();
            };
            
            cancelBtn.onclick = () => handleConfirm(false);
            okBtn.onclick = () => handleConfirm(true);
        }
        window.showCustomConfirm = showCustomConfirm;

        function updateDownloadButtonState() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            const hasChecked = checkedBoxes.length > 0;
            document.getElementById('downloadCodesBtn').disabled = !hasChecked;
            
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.disabled = !hasChecked;
            }
        }

        function toggleAllCheckboxes(source) {
            document.querySelectorAll('.code-checkbox').forEach(cb => cb.checked = source.checked);
            updateDownloadButtonState();
        }

        function downloadSelectedCodes() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            const codesToDownload = Array.from(checkedBoxes).map(cb => cb.value);
            const relevantCodesData = generatedCodes.filter(c => codesToDownload.includes(c.code));
            if (relevantCodesData.length === 0) return;
            let csv = 'Code,Beschreibung,ErstelltAm\n';
            relevantCodesData.forEach(c => { csv += `${c.code},"${c.description}",${c.created}\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-codes_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

function exportResults() {
    const isAdmin = currentDepartment === 'admin';
    const departmentCodes = isAdmin
        ? generatedCodes.map(c => c.code)
        : generatedCodes.filter(c => c.department === currentDepartment).map(c => c.code);

    const relevantResults = testResults.filter(r => departmentCodes.includes(r.testCode));
    if (relevantResults.length === 0) {
        showCustomAlert('Keine Ergebnisse zum Exportieren vorhanden.');
        return;
    }

    const escapeCsv = (text) => `"${String(text).replace(/"/g, '""')}"`;
    const formatPct = (v) => (v === 'N/A' || v === null || v === undefined || isNaN(v)) ? 'N/A' : `${v}%`;

    // Ø je Unterbereich über alle relevanten Ergebnisse für die Kopfzeile
    const subAvgByTitle = new Map();
    sections.forEach(section => {
        section.subbereiche.forEach(sub => {
            let sum = 0, count = 0;
            relevantResults.forEach(result => {
                if (!result.answers) return; // alte Ergebnisse überspringen
                let s = 0, m = 0;
                sub.questions.forEach(q => {
                    const v = result.answers[q.id];
                    if (v !== undefined) { s += v; m += 4; }
                });
                if (m > 0) { sum += Math.round((s / m) * 100); count++; }
            });
            subAvgByTitle.set(sub.title, count > 0 ? Math.round(sum / count) : null);
        });
    });

    // Kopfzeile: pro Bereich zuerst "Bereich (Ø)", dann die 3 Unterbereiche (mit Ø in Klammern, falls vorhanden)
    const headerParts = ['Code', 'Datum', 'Gesamtscore'];
    sections.forEach(section => {
        headerParts.push(escapeCsv(`${section.name} (Ø)`));
        section.subbereiche.forEach(sub => {
            const avg = subAvgByTitle.get(sub.title);
            headerParts.push(escapeCsv(avg !== null ? `${sub.title} (Ø ${avg}%)` : sub.title));
        });
    });
    const headers = headerParts.join(',');

    // Helfer: Bereichs-Prozent für ein Ergebnis (nutzt getCat, fällt bei Bedarf auf Berechnung via answers zurück)
    const catPctFor = (result, section) => {
        try {
            if (typeof getCat === 'function') {
                const v = getCat(result, section.id);
                if (!isNaN(v)) return v;
            }
        } catch (_) {}
        if (result.categoryPercentages && typeof result.categoryPercentages[section.id] === 'number') {
            return result.categoryPercentages[section.id];
        }
        if (result.answers) {
            let s = 0, m = 0;
            section.subbereiche.forEach(sub => {
                sub.questions.forEach(q => {
                    const v = result.answers[q.id];
                    if (v !== undefined) { s += v; m += 4; }
                });
            });
            return m > 0 ? Math.round((s / m) * 100) : 0;
        }
        return 'N/A';
    };

    // Zeilen: pro Bereich zuerst der Bereichs-Ø des Teilnehmers, dann seine drei Unterbereiche
    const rows = relevantResults.map(result => {
        const row = [
            escapeCsv(result.testCode),
            escapeCsv(toJsDate(result.timestamp)?.toLocaleDateString('de-DE') || 'N/A'),
            `"${result.totalPercentage}%"`
        ];

        sections.forEach(section => {
            // Bereich
            row.push(formatPct(catPctFor(result, section)));

            // Unterbereiche
            section.subbereiche.forEach(sub => {
                if (!result.answers) { row.push('N/A'); return; }
                let s = 0, m = 0;
                sub.questions.forEach(q => {
                    const v = result.answers[q.id];
                    if (v !== undefined) { s += v; m += 4; }
                });
                row.push(formatPct(m > 0 ? Math.round((s / m) * 100) : 0));
            });
        });

        return row.join(',');
    });

    // Download
    const csvContent = headers + '\n' + rows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `kompetenzen_export_unterbereiche_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

        function filterResults() {
            const selectedCode = document.getElementById('codeFilter').value;
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin
                ? generatedCodes
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            let relevantResults = testResults.filter(r => r && r.testCode && codeList.includes(r.testCode));

            if (selectedCode) {
                 relevantResults = relevantResults.filter(r => r.testCode === selectedCode)
            }
            
            console.log("Filtering results - Selected code:", selectedCode, "Results:", relevantResults.length);
            displayResults(relevantResults);
        }

        // Event Listeners Setup
        document.addEventListener('DOMContentLoaded', async () => {
            const loginButton = document.querySelector('.login-button');
            if (loginButton) {
                loginButton.disabled = true;
                loginButton.textContent = 'Lädt...';
            }

            try {
                await initializeAppWithFirebase();
            } catch (error) {
                console.error('Fehler bei der Firebase-Initialisierung:', error);
            } finally {
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Anmelden';
                }
            }

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('generateCodesBtn').addEventListener('click', generateCodes);
            document.getElementById('addUserBtn').addEventListener('click', addUser);
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => toggleAllCheckboxes(e.target));
            document.getElementById('downloadCodesBtn').addEventListener('click', downloadSelectedCodes);
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedCodes);
            document.getElementById('exportResultsBtn').addEventListener('click', exportResults);
            document.getElementById('refreshResultsBtn').addEventListener('click', async () => { await loadInitialData(); loadResultsData(); loadStatisticsData(); });
            document.getElementById('codeFilter').addEventListener('change', filterResults);

            document.getElementById('tabNav').addEventListener('click', (e) => {
                // Find the closest tab-button (in case we clicked on a child element)
                const tabButton = e.target.closest('.tab-button');
                if (tabButton) {
                    e.preventDefault();
                    switchTab(tabButton);
                }
            });

            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', (e) => closeModal(e.target.dataset.modalId));
            });

            // Event Delegation for dynamic buttons
            document.addEventListener('click', e => {
                if (e.target.closest('#codeTableBody')) {
                    const row = e.target.closest('tr');
                    if (!row) return;

                    const docId = row.dataset.docId;
                    const code = row.dataset.code;

                    if (e.target.classList.contains('view-button')) {
                        viewCodeDetails(docId);
                    } else if (e.target.classList.contains('delete-button')) {
                        deleteCode(docId, code);
                    }
                }

                if (e.target.closest('#resultsTableBody') && e.target.classList.contains('view-button')) {
                    const row = e.target.closest('tr');
                    const docId = row.dataset.docId;
                    viewResultDetails(docId);
                }
            });
            
            document.addEventListener('change', e => {
                if (e.target.classList.contains('code-checkbox')) {
                    updateDownloadButtonState();
                }
            });
        });
    </script>
</body>
</html>
