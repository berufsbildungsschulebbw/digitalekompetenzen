<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selbsteinsch√§tzung - BBW Digitale Kompetenzen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: calc(100vh - 40px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #5a67d8;
        }

        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }

        /* Code Entry Section */
        .code-entry {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .code-entry h2 {
            color: #495057;
            margin-bottom: 20px;
        }

        .code-input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 30px 0;
        }

        .code-input {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            width: 250px;
            text-align: center;
            text-transform: uppercase;
        }

        .code-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .start-button {
            padding: 15px 40px;
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-button:hover {
            background: #E53E3E;
            transform: translateY(-2px);
        }

        .start-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* Test Section */
        .test-section {
            display: none;
        }

        .test-section.active {
            display: block;
        }

        /* Progress Bar */
        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 30px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Section Header */
        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .section-title {
            font-size: 1.8em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .section-description {
            color: #718096;
            font-size: 1em;
            line-height: 1.6;
        }

        /* Question Card */
        .question-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }

        .question-card.answered {
            border-color: #667eea;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .category-badge {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .category-1 { background: #3887be; }
        .category-2 { background: #28a745; }
        .category-3 { background: #e74c3c; }
        .category-4 { background: #8e44ad; }
        .category-5 { background: #e67e22; }

        .question-text {
            font-size: 1.1em;
            color: #2d3748;
            margin-bottom: 20px;
            line-height: 1.6;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        /* Info Button */
        .info-button {
            min-width: 30px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .info-button:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        /* Info Box */
        .info-box {
            display: none;
            background: #e8f4ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            animation: slideDown 0.3s ease;
        }

        .info-box.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-box h4 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .info-box p {
            color: #4a5568;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .concept-tags {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .concept-tag {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .ikt-tag {
            background: #d6e8f5;
            color: #3887be;
        }

        .paed-tag {
            background: #fce5e2;
            color: #e74c3c;
        }

        /* Answer Options */
        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .answer-option {
            padding: 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .answer-option:hover {
            border-color: #667eea;
            background: #f7f7ff;
        }

        .answer-option input[type="radio"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .answer-option label {
            cursor: pointer;
            flex: 1;
            font-size: 0.95em;
        }

        .answer-option.selected {
            border-color: #667eea;
            background: #f0f0ff;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px 0;
        }

        .nav-button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .prev-button {
            background: #e9ecef;
            color: #495057;
        }

        .prev-button:hover {
            background: #dee2e6;
        }

        .next-button {
            background: #667eea;
            color: white;
        }

        .next-button:hover {
            background: #5a67d8;
        }

        .submit-button {
            background: #28a745;
            color: white;
        }

        .submit-button:hover {
            background: #218838;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            font-weight: bold;
            color: white;
        }

        .score-excellent { background: linear-gradient(135deg, #28a745, #20c997); }
        .score-good { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .score-needs-improvement { background: linear-gradient(135deg, #dc3545, #c82333); }

        .category-results {
            margin: 30px 0;
        }

        .category-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .category-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .category-result-title {
            font-weight: bold;
            color: #2d3748;
        }

        .category-result-score {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            background: white;
        }

        .result-bar-container {
            background: #e9ecef;
            border-radius: 5px;
            height: 20px;
            overflow: hidden;
        }

        .result-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 1s ease;
        }

        /* Recommendations */
        .recommendations {
            background: #f0f8ff;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .recommendations h3 {
            color: #495057;
            margin-bottom: 20px;
        }

        .recommendation-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .action-button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .print-button {
            background: #6c757d;
            color: white;
        }

        .print-button:hover {
            background: #5a6268;
        }

        .restart-button {
            background: #667eea;
            color: white;
        }

        .restart-button:hover {
            background: #5a67d8;
        }
        
         /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 450px; text-align: center; }
        .modal-body { margin: 20px 0; color: #495057; line-height: 1.6; }
        .modal-footer button { width: 100px; }


        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .code-input {
                width: 200px;
            }

            .question-text {
                font-size: 1em;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .nav-button {
                width: 100%;
            }
        }

        @media print {
            body {
                background: white;
            }
            
            .container {
                box-shadow: none;
                padding: 20px;
            }

            .back-button,
            .action-buttons,
            .info-button {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-button">‚Üê Zur√ºck zur Startseite</a>
        
        <div class="header">
            <h1>Selbsteinsch√§tzung</h1>
            <p class="subtitle">√úberpr√ºfen Sie Ihre digitalen Kompetenzen</p>
        </div>

        <!-- Code Entry Section -->
        <div id="codeEntry" class="code-entry">
            <h2>Zugangs-Code eingeben</h2>
            <p>Bitte geben Sie den Code ein, den Sie von Ihrer Abteilungsleitung erhalten haben.</p>
            <div class="code-input-group">
                <input type="text" 
                       id="accessCode" 
                       class="code-input" 
                       placeholder="CODE-XXXXX" 
                       maxlength="10">
                <button id="startTest" class="start-button">
                    Test starten
                </button>
            </div>
            <p style="color: #6c757d; font-size: 0.9em; margin-top: 20px;">
                Der Code dient zur anonymen Zuordnung Ihrer Ergebnisse zu Ihrer Abteilung.
            </p>
        </div>

        <!-- Test Section -->
        <div id="testSection" class="test-section">
            <div class="progress-container">
                <div id="progressBar" class="progress-bar" style="width: 0%">
                    Bereich 1 von 5
                </div>
            </div>

            <div id="sectionContainer">
                <!-- Section content will be dynamically inserted here -->
            </div>

            <div class="nav-buttons">
                <button id="prevButton" class="nav-button prev-button">
                    ‚Üê Vorheriger Bereich
                </button>
                <button id="nextButton" class="nav-button next-button">
                    N√§chster Bereich ‚Üí
                </button>
                <button id="submitButton" class="nav-button submit-button" style="display: none;">
                    Test abschlie√üen
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <div class="results-header">
                <h2>Ihre Ergebnisse</h2>
                <div id="scoreCircle" class="score-circle">
                    <!-- Score will be inserted here -->
                </div>
                <p id="scoreText" style="font-size: 1.2em; color: #495057;"></p>
            </div>

            <div id="categoryResults" class="category-results">
                <!-- Category results will be inserted here -->
            </div>

            <div id="recommendations" class="recommendations">
                <h3>Empfohlene Entwicklungsma√ünahmen</h3>
                <div id="recommendationsList">
                    <!-- Recommendations will be inserted here -->
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-button print-button" onclick="window.print()">
                    üìÑ Ergebnisse drucken
                </button>
                <button class="action-button restart-button">
                    üîÑ Neuer Test
                </button>
            </div>
        </div>
        
        <!-- General Purpose Modal for Alerts -->
        <div id="alertModal" class="modal">
            <div class="modal-content">
                <div class="modal-body" id="alertModalBody"></div>
                <div class="modal-footer">
                    <button class="nav-button next-button" id="alertOkBtn">OK</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration is provided by the environment
        const firebaseConfig = typeof __firebase_config !== "undefined"
            ? JSON.parse(__firebase_config)
            : {};
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Firestore Collection References
        const codesCollection = collection(db, 'codes');
        const resultsCollection = collection(db, 'results');

        // Test Questions Database
        const sections = [
            {
                id: 1, name: "Grundkenntnisse IKT", description: "Grundlegende technische F√§higkeiten zum Umgang mit digitalen Ger√§ten, Anwendungen und Systemen.",
                questions: [
                    { id: 1, text: "Wie sicher f√ºhlen Sie sich beim Verbinden von Ger√§ten (z.B. Beamer, Drucker)?", info: { examples: "Beamer √ºber HDMI, Drucker im Netzwerk einrichten", tools: "Systemeinstellungen, Netzwerk-Tools", tips: "Halten Sie Adapter bereit.", ikt: "RE üíö", paed: "PDM üõ†Ô∏è" }, options: [{ value: 4, text: "Sehr sicher" }, { value: 3, text: "Sicher" }, { value: 2, text: "Teilweise sicher" }, { value: 1, text: "Unsicher" }] },
                    { id: 2, text: "Wie gut k√∂nnen Sie Office-Programme f√ºr Unterrichtsmaterialien nutzen?", info: { examples: "Arbeitsbl√§tter, Notenverwaltung in Excel", tools: "Microsoft 365, Google Workspace", tips: "Nutzen Sie Vorlagen.", ikt: "MV üîÑ", paed: "PDM üõ†Ô∏è" }, options: [{ value: 4, text: "Expertenniveau" }, { value: 3, text: "Fortgeschritten" }, { value: 2, text: "Grundkenntnisse" }, { value: 1, text: "Anf√§nger" }] },
                    { id: 3, text: "Wie routiniert nutzen Sie Cloud-Dienste (OneDrive, Teams)?", info: { examples: "Materialien in OneDrive speichern und teilen", tools: "OneDrive, Teams, Google Drive", tips: "Strukturieren Sie Ihre Cloud-Ordner.", ikt: "KN üåê", paed: "PDM üõ†Ô∏è" }, options: [{ value: 4, text: "T√§glich" }, { value: 3, text: "Regelm√§√üig" }, { value: 2, text: "Gelegentlich" }, { value: 1, text: "Selten" }] }
                ]
            },
            {
                id: 2, name: "Anwendung im Unterricht", description: "Praktische Implementierung digitaler Medien in den Unterrichtsprozess.",
                questions: [
                     { id: 4, text: "Wie h√§ufig setzen Sie digitale Werkzeuge/KI f√ºr Lernmaterialien ein?", info: { examples: "ChatGPT f√ºr Aufgaben, Canva f√ºr Infografiken", tools: "ChatGPT, Canva, H5P", tips: "Pr√ºfen Sie KI-Inhalte immer.", ikt: "RE üíö", paed: "PDM üõ†Ô∏è" }, options: [{ value: 4, text: "Sehr h√§ufig" }, { value: 3, text: "H√§ufig" }, { value: 2, text: "Manchmal" }, { value: 1, text: "Selten" }] },
                     { id: 5, text: "Wie interaktiv gestalten Sie Ihren Unterricht mit Tools (Kahoot, Padlet)?", info: { examples: "Kahoot-Quiz, Padlet f√ºr Brainstorming", tools: "Kahoot, Padlet, Mentimeter", tips: "Halten Sie eine analoge Alternative bereit.", ikt: "HE üí°", paed: "PL üéì" }, options: [{ value: 4, text: "Sehr interaktiv" }, { value: 3, text: "Interaktiv" }, { value: 2, text: "Wenig interaktiv" }, { value: 1, text: "Nicht interaktiv" }] },
                     { id: 6, text: "Wie setzen Sie E-Assessments f√ºr die Leistungserfassung ein?", info: { examples: "Online-Tests in Forms, Portfolio in OneNote", tools: "Microsoft Forms, OpenOlat, Moodle", tips: "Geben Sie zeitnahes digitales Feedback.", ikt: "KM ‚öôÔ∏è", paed: "PL üéì" }, options: [{ value: 4, text: "Systematisch" }, { value: 3, text: "H√§ufig" }, { value: 2, text: "Gelegentlich" }, { value: 1, text: "Nie" }] }
                ]
            },
            {
                id: 3, name: "Medien- und Informationskompetenz", description: "Informationen kritisch bewerten, Medien reflektiert nutzen.",
                questions: [
                    { id: 7, text: "Wie gut kennen Sie die Funktionsweise von Social Media?", info: { examples: "Twitter f√ºr Nachrichten analysieren, TikTok-Ph√§nomene diskutieren", tools: "Twitter/X, Instagram, TikTok", tips: "Thematisieren Sie Datenschutz.", ikt: "KR üîç", paed: "PL üéì" }, options: [{ value: 4, text: "Sehr gut" }, { value: 3, text: "Gut" }, { value: 2, text: "Grundkenntnisse" }, { value: 1, text: "Wenig" }] },
                    { id: 8, text: "K√∂nnen Sie multimediale Inhalte (Videos, Podcasts) erstellen?", info: { examples: "Lernvideos mit OBS Studio, Podcasts mit Audacity", tools: "OBS Studio, Audacity, Genially", tips: "Beginnen Sie mit kurzen Videos.", ikt: "MF üîì", paed: "PDM üõ†Ô∏è" }, options: [{ value: 4, text: "Ja, professionell" }, { value: 3, text: "Ja, gut" }, { value: 2, text: "Teilweise" }, { value: 1, text: "Nein" }] },
                    { id: 9, text: "Wie vermitteln Sie kritische Medienkompetenz und Quellenpr√ºfung?", info: { examples: "Fake News erkennen, Bildmanipulation verstehen", tools: "Faktencheck-Seiten, Reverse Image Search", tips: "Nutzen Sie aktuelle Beispiele.", ikt: "KR üîç", paed: "PU üìö" }, options: [{ value: 4, text: "Systematisch" }, { value: 3, text: "Regelm√§√üig" }, { value: 2, text: "Gelegentlich" }, { value: 1, text: "Selten" }] }
                ]
            },
            {
                id: 4, name: "Datenverwaltung und Datensicherheit", description: "Verantwortungsvoller Umgang mit digitalen und sensiblen Daten.",
                questions: [
                    { id: 10, text: "Wie gut kennen Sie die rechtlichen Grundlagen zum Datenschutz?", info: { examples: "DSGVO, Einwilligungen f√ºr Fotos", tools: "Schulische Datenschutzrichtlinien, DSGVO-Leitf√§den", tips: "Besuchen Sie Schulungen.", ikt: "KR üîç", paed: "PLL üë•" }, options: [{ value: 4, text: "Sehr gut" }, { value: 3, text: "Gut" }, { value: 2, text: "Grundkenntnisse" }, { value: 1, text: "Wenig" }] },
                    { id: 11, text: "Wie verwalten Sie Ihre Passw√∂rter und Zugangsdaten?", info: { examples: "Passwort-Manager, 2-Faktor-Authentifizierung", tools: "Bitwarden, KeePass, Microsoft Authenticator", tips: "Nutzen Sie 2FA wo m√∂glich.", ikt: "DS üîí", paed: "PU üìö" }, options: [{ value: 4, text: "Professionell" }, { value: 3, text: "Sicher" }, { value: 2, text: "Ausreichend" }, { value: 1, text: "Unsicher" }] },
                    { id: 12, text: "Wie strukturiert verwalten Sie digitale Materialien und Daten?", info: { examples: "Klare Ordnerstruktur, regelm√§√üige Backups", tools: "OneDrive, Teams, Backup-Software", tips: "Erstellen Sie ein Benennungsschema.", ikt: "RE üíö", paed: "PLK üè´" }, options: [{ value: 4, text: "Sehr strukturiert" }, { value: 3, text: "Strukturiert" }, { value: 2, text: "Teilweise" }, { value: 1, text: "Unstrukturiert" }] }
                ]
            },
            {
                id: 5, name: "Kommunikation und Kollaboration", description: "Digitale Medien f√ºr den professionellen Austausch und kollaborative Lernprozesse.",
                questions: [
                    { id: 13, text: "Wie aktiv nutzen Sie Teams f√ºr die Kommunikation?", info: { examples: "Teams-Kan√§le, Chat f√ºr Absprachen, Videobesprechungen", tools: "Microsoft Teams, Slack, Zoom", tips: "Definieren Sie Kommunikationsregeln.", ikt: "KN üåê", paed: "PL üéì" }, options: [{ value: 4, text: "Sehr aktiv" }, { value: 3, text: "Aktiv" }, { value: 2, text: "Gelegentlich" }, { value: 1, text: "Selten" }] },
                    { id: 14, text: "Wie gut k√∂nnen Sie kollaborative Dokumente nutzen?", info: { examples: "Gemeinsame Unterrichtsplanung in Word, simultane Bearbeitung", tools: "Office 365, Google Workspace, OneNote", tips: "Nutzen Sie die Kommentarfunktion.", ikt: "KA ü§ù", paed: "PU üìö" }, options: [{ value: 4, text: "Expertenniveau" }, { value: 3, text: "Gut" }, { value: 2, text: "Grundkenntnisse" }, { value: 1, text: "Wenig Erfahrung" }] },
                    { id: 15, text: "Wie professionell ist Ihre digitale Kommunikation?", info: { examples: "Klare Betreffzeilen, zeitnahe Antworten, professionelle Anrede", tools: "Outlook-Regeln, E-Mail-Vorlagen", tips: "Setzen Sie Erreichbarkeitszeiten.", ikt: "MG üõ†Ô∏è", paed: "PLL üë•" }, options: [{ value: 4, text: "Sehr professionell" }, { value: 3, text: "Professionell" }, { value: 2, text: "Ausreichend" }, { value: 1, text: "Verbesserungsw√ºrdig" }] }
                ]
            }
        ];

        // State Management
        let currentSectionIndex = 0;
        let answers = {};
        let testCode = "";
        let testStartTime = null;

        // Start Test Function
        async function startTest() {
            const codeInput = document.getElementById('accessCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (code.length < 4) {
                showAlert('Bitte geben Sie einen g√ºltigen Code ein.');
                return;
            }

            // Validate code against Firestore
            const q = query(codesCollection, where("code", "==", code), limit(1));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showAlert('Der eingegebene Code ist ung√ºltig.');
                return;
            }
            
            const codeData = querySnapshot.docs[0].data();
            if (new Date() > new Date(codeData.expiry)) {
                showAlert('Dieser Code ist leider abgelaufen.');
                return;
            }
            
            testCode = code;
            testStartTime = new Date();
            
            document.getElementById('codeEntry').style.display = 'none';
            document.getElementById('testSection').classList.add('active');
            
            showSection(0);
        }

        // Show Section Function
        function showSection(sectionIndex) {
            const section = sections[sectionIndex];
            const container = document.getElementById('sectionContainer');
            
            const progress = Math.round(((sectionIndex + 1) / sections.length) * 100);
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = `Bereich ${sectionIndex + 1} von ${sections.length}`;
            
            let sectionHTML = `
                <div class="section-header">
                    <h2 class="section-title">${section.name}</h2>
                    <p class="section-description">${section.description}</p>
                </div>
            `;
            
            section.questions.forEach((question, qIndex) => {
                const isAnswered = answers[question.id] !== undefined;
                
                sectionHTML += `
                    <div class="question-card ${isAnswered ? 'answered' : ''}" id="question-${question.id}">
                        <div class="question-text">
                            <span style="flex: 1;">${question.text}</span>
                            <button class="info-button" data-question-id="${question.id}">?</button>
                        </div>
                        <div id="info-${question.id}" class="info-box">
                            <h4>üìç Praktische Beispiele</h4> <p>${question.info.examples}</p>
                            <h4>üõ†Ô∏è Empfohlene Tools</h4> <p>${question.info.tools}</p>
                            <h4>üí° Tipp</h4> <p>${question.info.tips}</p>
                            <div class="concept-tags">
                                <span class="concept-tag ikt-tag">${question.info.ikt}</span>
                                <span class="concept-tag paed-tag">${question.info.paed}</span>
                            </div>
                        </div>
                        <div class="answer-options">
                            ${question.options.map((option) => `
                                <div class="answer-option ${answers[question.id] === option.value ? 'selected' : ''}" data-question-id="${question.id}" data-value="${option.value}">
                                    <input type="radio" name="question${question.id}" value="${option.value}" ${answers[question.id] === option.value ? 'checked' : ''}>
                                    <label>${option.text}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = sectionHTML;
            
            document.getElementById('prevButton').style.display = sectionIndex === 0 ? 'none' : 'block';
            document.getElementById('nextButton').style.display = sectionIndex === sections.length - 1 ? 'none' : 'block';
            document.getElementById('submitButton').style.display = sectionIndex === sections.length - 1 ? 'block' : 'none';
        }

        // Toggle Info Box Function
        function toggleInfo(questionId) {
            document.getElementById(`info-${questionId}`).classList.toggle('active');
        }

        // Select Answer Function
        function selectAnswer(questionId, value, element) {
            answers[questionId] = value;
            
            const questionCard = document.getElementById(`question-${questionId}`);
            questionCard.classList.add('answered');
            
            questionCard.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        // Check if all questions in current section are answered
        function checkSectionComplete() {
            return sections[currentSectionIndex].questions.every(q => answers[q.id]);
        }

        // Navigation Functions
        function previousSection() {
            if (currentSectionIndex > 0) {
                currentSectionIndex--;
                showSection(currentSectionIndex);
            }
        }

        function nextSection() {
            if (!checkSectionComplete()) {
                showAlert('Bitte beantworten Sie alle Fragen in diesem Bereich.');
                return;
            }
            if (currentSectionIndex < sections.length - 1) {
                currentSectionIndex++;
                showSection(currentSectionIndex);
            }
        }

        // Submit Test Function
        function submitTest() {
            if (!checkSectionComplete()) {
                showAlert('Bitte beantworten Sie alle Fragen in diesem Bereich.');
                return;
            }
            const results = calculateResults();
            showResults(results);
            saveResultsToFirestore(results);
        }

        // Calculate Results Function
        function calculateResults() {
            const categoryScores = {};
            const categoryMaxScores = {};
            
            sections.forEach(section => {
                categoryScores[section.id] = 0;
                categoryMaxScores[section.id] = 0;
                section.questions.forEach(question => {
                    if (answers[question.id]) {
                        categoryScores[section.id] += answers[question.id];
                        categoryMaxScores[section.id] += 4;
                    }
                });
            });
            
            const categoryPercentages = {};
            let totalScore = 0;
            let totalMaxScore = 0;
            
            for (let i = 1; i <= sections.length; i++) {
                categoryPercentages[i] = categoryMaxScores[i] > 0 ? Math.round((categoryScores[i] / categoryMaxScores[i]) * 100) : 0;
                totalScore += categoryScores[i];
                totalMaxScore += categoryMaxScores[i];
            }
            
            const totalPercentage = Math.round((totalScore / totalMaxScore) * 100);
            
            return {
                totalPercentage,
                categoryPercentages,
                testCode,
                timestamp: new Date().toISOString(),
                duration: Math.round((new Date() - testStartTime) / 1000)
            };
        }

        // Show Results Function
        function showResults(results) {
            document.getElementById('testSection').classList.remove('active');
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('active');
            
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            
            scoreCircle.textContent = results.totalPercentage + '%';
            
            if (results.totalPercentage >= 80) {
                scoreCircle.className = 'score-circle score-excellent';
                scoreText.textContent = 'Ausgezeichnet! Sie verf√ºgen √ºber sehr gute digitale Kompetenzen.';
            } else if (results.totalPercentage >= 60) {
                scoreCircle.className = 'score-circle score-good';
                scoreText.textContent = 'Gut! Sie haben solide digitale Kompetenzen mit Entwicklungspotenzial.';
            } else {
                scoreCircle.className = 'score-circle score-needs-improvement';
                scoreText.textContent = 'Es besteht Entwicklungsbedarf in mehreren Bereichen.';
            }
            
            const categoryNames = sections.map(s => s.name);
            const categoryResultsHTML = categoryNames.map((name, i) => {
                const percentage = results.categoryPercentages[i + 1];
                const barColor = percentage >= 80 ? '#28a745' : percentage >= 60 ? '#ffc107' : '#dc3545';
                return `
                    <div class="category-result">
                        <div class="category-result-header">
                            <span class="category-result-title">${name}</span>
                            <span class="category-result-score">${percentage}%</span>
                        </div>
                        <div class="result-bar-container">
                            <div class="result-bar" style="width: ${percentage}%; background: ${barColor};"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('categoryResults').innerHTML = categoryResultsHTML;
            
            // Recommendations (simplified)
            document.getElementById('recommendationsList').innerHTML = `<div class="recommendation-item"><strong>N√§chste Schritte:</strong> Besprechen Sie Ihre Ergebnisse mit Ihrer Abteilungsleitung, um gezielte Fortbildungen zu planen.</div>`;
        }

        // Save Results to Firestore
        async function saveResultsToFirestore(results) {
            try {
                await addDoc(resultsCollection, results);
                console.log("Results saved to Firestore");
            } catch (error) {
                console.error("Error saving results: ", error);
                showAlert("Fehler beim Speichern der Ergebnisse. Bitte versuchen Sie es sp√§ter erneut.");
            }
        }

        // Restart Test Function
        function restartTest() {
            location.reload();
        }
        
        // Modal helpers
        function showAlert(message) {
            document.getElementById('alertModalBody').textContent = message;
            document.getElementById('alertModal').classList.add('active');
        }
        function closeModal() {
             document.getElementById('alertModal').classList.remove('active');
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
             // Sign in using the provided token or anonymously
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token);
            } else {
                signInAnonymously(auth);
            }

            // Event listeners
            document.getElementById('startTest').addEventListener('click', startTest);
            document.getElementById('prevButton').addEventListener('click', previousSection);
            document.getElementById('nextButton').addEventListener('click', nextSection);
            document.getElementById('submitButton').addEventListener('click', submitTest);
            document.querySelector('.restart-button').addEventListener('click', restartTest);
            document.getElementById('alertOkBtn').addEventListener('click', closeModal);

            document.getElementById('sectionContainer').addEventListener('click', (e) => {
                const infoButton = e.target.closest('.info-button');
                if (infoButton) {
                    toggleInfo(infoButton.dataset.questionId);
                    return;
                }
                
                const answerOption = e.target.closest('.answer-option');
                if (answerOption) {
                    const { questionId, value } = answerOption.dataset;
                    selectAnswer(parseInt(questionId), parseInt(value), answerOption);
                    return;
                }
            });
        });

    </script>
</body>
</html>

}

Hallo, es tut mir sehr leid, dass der Login immer noch nicht funktioniert. Das ist nat√ºrlich nicht der Sinn der Sache, und ich verstehe Ihre Frustration. Wir beheben das jetzt endg√ºltig.

Sie haben recht, das Problem zu finden, wenn man die Logins nicht kennt. Hier sind die Standard-Logins und wo Sie sie finden:

### Standard-Logins
* **F√ºr normale Abteilungen** (Bau, Technik, etc.):
    * Benutzername: `demo`
    * Passwort: `demo123`
* **F√ºr den Admin-Zugang:**
    * Abteilung: `Administration`
    * Benutzername: `admin`
    * Passwort: `admin123`

### Wo k√∂nnen Sie die aktuellen Passw√∂rter nachschauen?
Die Passw√∂rter werden zentral in Ihrer Firebase-Datenbank gespeichert. Sie k√∂nnen sie jederzeit √ºberpr√ºfen:
1.  Gehen Sie zu Ihrer **Firestore Database** in der Firebase-Konsole.
2.  Sie sehen eine Sammlung namens `config`. Klicken Sie darauf.
3.  Darin befindet sich ein Dokument namens `userAccounts`. Wenn Sie dieses anklicken, sehen Sie alle Abteilungen mit den zugeh√∂rigen Benutzernamen (`user`) und Passw√∂rtern (`pass`).

### Die eigentliche L√∂sung
Das Problem ist eine "Race Condition" im Code: Sie sind schneller mit der Eingabe Ihrer Login-Daten, als die Anwendung die Passw√∂rter aus der Datenbank laden kann.

Ich habe das nun behoben, indem der "Anmelden"-Button kurz deaktiviert wird, w√§hrend die Verbindung zur Datenbank im Hintergrund aufgebaut wird. Sobald alles bereit ist, wird der Button automatisch wieder aktiv. Das macht den Prozess robust und behebt das Problem.

Hier ist die finale, korrigierte Version der `index.html`-Datei.

