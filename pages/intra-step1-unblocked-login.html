<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intra - BBW Digitale Kompetenzen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: calc(100vh - 40px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #5a67d8;
        }

        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        h3 {
             color: #2d3748;
             margin-bottom: 15px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }

        /* Login Section */
        .login-section {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-section h2 {
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: #9C27B0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        /* Dashboard Section */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details h3 {
            margin-bottom: 5px;
            color: white;
        }

        .logout-button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-button:hover {
            background: white;
            color: #667eea;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6c757d;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            color: #495057;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Code Management */
        .code-generator {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .code-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .code-form .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 0;
        }

        .generate-button {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-button:hover {
            background: #218838;
        }

        .code-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .download-button {
             padding: 10px 20px;
             background: #007bff;
             color: white;
             border: none;
             border-radius: 8px;
             font-weight: bold;
             cursor: pointer;
             transition: all 0.3s;
        }
        
        .download-button:hover {
            background: #0056b3;
        }
        
        .download-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .code-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .code-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .code-table th, .code-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }
        
        .code-table th:first-child, .code-table td:first-child {
            width: 40px;
            text-align: center;
        }

        .code-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .code-table tr:last-child td {
            border-bottom: none;
        }

        .code-table tr:hover {
            background: #f8f9fa;
        }

        .code-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 20px;
            font-weight: 500;
            font-family: monospace;
            font-size: 1.1em;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-used {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .action-button {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .view-button {
            background: #17a2b8;
            color: white;
        }

        .view-button:hover {
            background: #138496;
        }

        .delete-button {
            background: #dc3545;
            color: white;
        }

        .delete-button:hover {
            background: #c82333;
        }

        /* Results Section */
        .results-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        /* Department Stats */
        .department-chart {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .chart-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
        }

        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            width: 200px;
            font-weight: 500;
            color: #495057;
        }

        .bar-container {
            flex: 1;
            background: #e9ecef;
            border-radius: 5px;
            height: 30px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }

        /* Individual Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .results-table th, .results-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-table tr:last-child td {
            border-bottom: none;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }

        .score-high { background: #28a745; }
        .score-medium { background: #ffc107; }
        .score-low { background: #dc3545; }

        /* Export Button */
        .export-button {
            padding: 12px 30px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .export-button:hover {
            background: #5a6268;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
             color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .tab-navigation {
                flex-wrap: wrap;
            }

            .code-form {
                flex-direction: column;
                align-items: stretch;
            }
            
             .code-form .form-group {
                margin-bottom: 15px;
            }

            .user-info {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-button">‚Üê Zur√ºck zur Startseite</a>
        
        <div class="header">
            <h1>Intra-Bereich</h1>
            <p class="subtitle">Verwaltung und Auswertung digitaler Kompetenzen</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>üîê Anmeldung</h2>
            <div id="errorMessage" class="error-message">
                Ung√ºltige Anmeldedaten. Bitte versuchen Sie es erneut.
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select id="department" class="form-select" required>
                        <option value="">Bitte w√§hlen...</option>
                        <option value="bau">Bau</option>
                        <option value="technik">Technik | Ern√§hrung</option>
                        <option value="maschinenbau">Maschinenbau</option>
                        <option value="informatik">Informatik | Naturwissenschaften</option>
                        <option value="admin">Administration</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Benutzername</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" class="login-button">Anmelden</button>
            </form>
            <p style="margin-top: 20px; color: #6c757d; font-size: 0.9em; text-align: center;">
                Demo-Login: W√§hlen Sie eine Abteilung, Benutzer: <strong>demo</strong>, PW: <strong>demo123</strong><br>
                Admin-Login: Abteilung Admin, Benutzer: <strong>admin</strong>, PW: <strong>admin123</strong>
            </p>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard-section">
            <!-- User Info Bar -->
            <div class="user-info">
                <div class="user-details">
                    <h3 id="userDepartment">Abteilung</h3>
                    <p id="userName">Benutzer</p>
                </div>
                <button id="logoutBtn" class="logout-button">Abmelden</button>
            </div>

            <!-- Tab Navigation -->
            <div id="tabNav" class="tab-navigation">
                <button class="tab-button active" data-tab="codes">
                    üìù Code-Verwaltung
                </button>
                <button class="tab-button" data-tab="results">
                    üìä Ergebnisse
                </button>
                <button class="tab-button" data-tab="statistics">
                    üìà Statistiken
                </button>
                <button id="adminTabButton" class="tab-button" data-tab="admin" style="display: none;">
                    ‚öôÔ∏è Administration
                </button>
            </div>

            <!-- Tab: Code Management -->
            <div id="codesTab" class="tab-content active">
                <div class="code-generator">
                    <h3>Neue Test-Codes generieren</h3>
                    <div class="code-form">
                        <div class="form-group" id="adminDepartmentSelector" style="display: none;">
                            <label class="form-label">F√ºr Abteilung</label>
                             <select id="adminDepartmentSelect" class="form-select">
                                <option value="bau">Bau</option>
                                <option value="technik">Technik | Ern√§hrung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <input type="text" id="codeDescription" class="form-input" 
                                   placeholder="z.B. Q1 2025 Assessment" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">G√ºltig bis</label>
                            <input type="date" id="codeExpiry" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anzahl</label>
                            <select id="codeQuantity" class="form-select">
                                <option value="10">10 Codes</option>
                                <option value="20">20 Codes</option>
                                <option value="30">30 Codes</option>
                                <option value="40">40 Codes</option>
                                <option value="50">50 Codes</option>
                            </select>
                        </div>
                        <button id="generateCodesBtn" class="generate-button">
                            Codes generieren
                        </button>
                    </div>
                </div>

                <div class="code-list-header">
                     <h3>Generierte Codes</h3>
                     <button id="downloadCodesBtn" class="download-button" disabled>
                        üì• Ausgew√§hlte herunterladen
                     </button>
                </div>

                <div class="code-list">
                    <table class="code-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Code</th>
                                <th>Beschreibung</th>
                                <th>Abteilung</th>
                                <th>Erstellt am</th>
                                <th>G√ºltig bis</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="codeTableBody">
                            <!-- Codes will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Results -->
            <div id="resultsTab" class="tab-content">
                <div class="results-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTests">0</div>
                        <div class="stat-label">Durchgef√ºhrte Tests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScore">0%</div>
                        <div class="stat-label">Durchschnittlicher Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCodes">0</div>
                        <div class="stat-label">Aktive Codes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">Abschlussrate</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Individuelle Ergebnisse nach Code</h3>
                <div style="margin-bottom: 20px;">
                    <select id="codeFilter" class="form-select" style="width: auto;">
                        <option value="">Alle Codes</option>
                    </select>
                </div>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Datum</th>
                            <th>Gesamtscore</th>
                            <th>Bereich 1</th>
                            <th>Bereich 2</th>
                            <th>Bereich 3</th>
                            <th>Bereich 4</th>
                            <th>Bereich 5</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>

                <button id="exportResultsBtn" class="export-button">
                    üì• Ergebnisse exportieren (CSV)
                </button>
            </div>

            <!-- Tab: Statistics -->
            <div id="statisticsTab" class="tab-content">
                <div class="department-chart">
                    <div class="chart-header">Durchschnittliche Scores nach Kompetenzbereich</div>
                    <div class="chart-bars">
                        <div class="chart-bar">
                            <div class="bar-label">Grundkenntnisse IKT</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar1" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Anwendung im Unterricht</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar2" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Medien- & Infokompetenz</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar3" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Daten & Sicherheit</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar4" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Kommunikation</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar5" style="width: 0%;">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="department-chart">
                    <div class="chart-header">Entwicklung √ºber Zeit</div>
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        Hier w√ºrde ein Liniendiagramm mit der zeitlichen Entwicklung der Kompetenzen angezeigt werden.
                    </p>
                </div>
            </div>

            <!-- Tab: Admin (only for admin users) -->
            <div id="adminTab" class="tab-content">
                 <div class="code-generator">
                    <h3>Passwort zur√ºcksetzen</h3>
                    <div class="code-form">
                        <div class="form-group">
                             <label class="form-label">Abteilung</label>
                             <select id="resetPwDepartment" class="form-select">
                                <option value="bau">Bau</option>
                                <option value="technik">Technik | Ern√§hrung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label class="form-label">Neues Passwort</label>
                            <input type="text" id="newPassword" class="form-input" placeholder="Mind. 6 Zeichen">
                        </div>
                         <button id="resetPasswordBtn" class="generate-button" style="background: #ffc107;">
                            Passwort √§ndern
                        </button>
                    </div>
                </div>
            
                <h3>Abteilungs√ºbersicht</h3>
                <div class="results-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="allDepartmentsCount">0</div>
                        <div class="stat-label">Aktive Abteilungen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTestsAdmin">0</div>
                        <div class="stat-label">Tests Gesamt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScoreAdmin">0%</div>
                        <div class="stat-label">Gesamt-Durchschnitt</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Abteilungsvergleich</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Abteilung</th>
                            <th>Anzahl Tests</th>
                            <th>√ò Score</th>
                            <th>Beste Kompetenz</th>
                            <th>Schw√§chste Kompetenz</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody">
                       <!-- Admin data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal for Details -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Test-Details</h3>
                    <button class="modal-close" data-modal-id="detailModal">√ó</button>
                </div>
                <div id="modalBody">
                    <!-- Details will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- General Purpose Modal for Alerts/Confirms -->
        <div id="alertModal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                 <div class="modal-header">
                    <h3 id="alertModalTitle">Hinweis</h3>
                    <button class="modal-close" data-modal-id="alertModal">√ó</button>
                </div>
                <div id="alertModalBody" style="margin: 10px 0 20px; color: #495057; line-height: 1.6;">
                    <!-- Alert/Confirm message goes here -->
                </div>
                <div id="alertModalFooter" style="text-align: right;">
                    <!-- Buttons go here -->
                </div>
            </div>
        </div>
        
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, collection, query, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration is provided by the environment
const rawFirebaseConfig = (typeof __firebase_config !== "undefined" && __firebase_config)
  ? JSON.parse(__firebase_config)
  : null;

const hasValidFirebaseConfig = rawFirebaseConfig && rawFirebaseConfig.apiKey && rawFirebaseConfig.projectId;

// Initialize Firebase guarded
let app = null, db = null, auth = null;
let firebaseReady = false;

try {
  if (hasValidFirebaseConfig) {
    app = initializeApp(rawFirebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    firebaseReady = true;
  } else {
    console.warn("Kein g√ºltiges Firebase-Config gefunden ‚Äì starte im Local-Mode.");
  }
} catch (e) {
  console.warn("Firebase-Initialisierung √ºbersprungen (fehlende/ung√ºltige Config):", e);
  firebaseReady = false;
}

// Firestore Collection References (nur wenn verf√ºgbar)
let codesCollection = null;
let resultsCollection = null;
let accountsDocRef = null;
if (db) {
  codesCollection = collection(db, 'codes');
  resultsCollection = collection(db, 'results');
  accountsDocRef = doc(db, 'config', 'userAccounts');
}

// State Management
let currentUser = null;
let currentDepartment = null;
let generatedCodes = [];
let testResults = [];
let userAccounts = {};

const deptNames = {
    'bau': 'Bau',
    'technik': 'Technik | Ern√§hrung',
    'maschinenbau': 'Maschinenbau',
    'informatik': 'Informatik | Naturwissenschaften',
    'admin': 'Administration'
};

        async function initializeAppWithFirebase() 
{
  // Wenn Firebase nicht bereit ist: Local-Mode mit Demologins
  if (!firebaseReady || !auth || !db || !accountsDocRef) {
    console.warn("Initialize: Firebase nicht verf√ºgbar ‚Äì Demologins aktiv.");
    userAccounts = {
      'bau': { user: 'demo', pass: 'demo123' },
      'technik': { user: 'demo', pass: 'demo123' },
      'maschinenbau': { user: 'demo', pass: 'demo123' },
      'informatik': { user: 'demo', pass: 'demo123' },
      'admin': { user: 'admin', pass: 'admin123' }
    };
    return;
  }

  try {
    // Sign in using the provided token or anonymously
    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
      await signInWithCustomToken(auth, __initial_auth_token);
    } else {
      await signInAnonymously(auth);
    }

    const docSnap = await getDoc(accountsDocRef);
    if (docSnap.exists()) {
      userAccounts = docSnap.data();
    } else {
      console.log("No account config found, creating default accounts...");
      userAccounts = {
        'bau': { user: 'demo', pass: 'demo123' },
        'technik': { user: 'demo', pass: 'demo123' },
        'maschinenbau': { user: 'demo', pass: 'demo123' },
        'informatik': { user: 'demo', pass: 'demo123' },
        'admin': { user: 'admin', pass: 'admin123' }
      };
      await setDoc(accountsDocRef, userAccounts);
    }

    // Real-time listeners nur starten, wenn Collections verf√ºgbar
    if (codesCollection) {
      onSnapshot(codesCollection, (snapshot) => {
        generatedCodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (currentUser) {
          loadDashboardData();
        }
      });
    }

    if (resultsCollection) {
      onSnapshot(resultsCollection, (snapshot) => {
        testResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (currentUser) {
          updateStatistics();
          if (document.getElementById('resultsTab').classList.contains('active')) {
            loadResultsData();
          }
        }
      });
    }
  } catch (error) {
    console.error('Fehler bei der Firebase-Initialisierung:', error);
    // Fallback auf Local-Mode
    if (!userAccounts || Object.keys(userAccounts).length === 0) {
      userAccounts = {
        'bau': { user: 'demo', pass: 'demo123' },
        'technik': { user: 'demo', pass: 'demo123' },
        'maschinenbau': { user: 'demo', pass: 'demo123' },
        'informatik': { user: 'demo', pass: 'demo123' },
        'admin': { user: 'admin', pass: 'admin123' }
      };
    }
  }
}


        // Login Handler
        async function handleLogin(event) {
            event.preventDefault();
            
            const department = document.getElementById('department').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const account = userAccounts[department];

            // Allow login if credentials match Firestore DB OR if it's the standard demo login (for non-admin departments)
            if ((account && username === account.user && password === account.pass && department) || 
                (username === 'demo' && password === 'demo123' && department && department !== 'admin')) {
                currentUser = username;
                currentDepartment = department;
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').classList.add('active');
                
                document.getElementById('userDepartment').textContent = deptNames[department] || department;
                document.getElementById('userName').textContent = `Benutzer: ${username}`;
                
                const isAdmin = department === 'admin';
                document.getElementById('adminTabButton').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('adminDepartmentSelector').style.display = isAdmin ? 'block' : 'none';

                loadDashboardData();
            } else {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                setTimeout(() => {
                   errorMessage.style.display = 'none';
                }, 3000);
            }
        }

        // Logout Handler
        function handleLogout() {
            currentUser = null;
            currentDepartment = null;
            document.getElementById('dashboardSection').classList.remove('active');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminTabButton').style.display = 'none';
            
            document.getElementById('department').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Tab Switching
        function switchTab(event) {
            const tabName = event.currentTarget.dataset.tab;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'results') loadResultsData();
            if (tabName === 'statistics') loadStatisticsData();
            if (tabName === 'admin') loadAdminData();
        }

        // Generate Codes in Batches
        async function generateCodes() {
            const descriptionInput = document.getElementById('codeDescription');
            const expiryInputEl = document.getElementById('codeExpiry');
            
            const description = descriptionInput.value.trim();
            const expiryInput = expiryInputEl.value;

            if (!description || !expiryInput) {
                showCustomAlert('Bitte geben Sie eine Beschreibung und ein G√ºltigkeitsdatum ein, um fortzufahren.');
                return;
            }

            const quantity = parseInt(document.getElementById('codeQuantity').value, 10);
            const isAdmin = currentDepartment === 'admin';
            const targetDepartment = isAdmin ? document.getElementById('adminDepartmentSelect').value : currentDepartment;
            
            const batch = writeBatch(db);
            let generatedCount = 0;
            
            while (generatedCount < quantity) {
                const prefix = targetDepartment.toUpperCase().substring(0, 4);
                const random = Math.floor(Math.random() * 90000) + 10000;
                const code = `${prefix}-${random}`;

                if (!generatedCodes.some(c => c.code === code)) {
                    const newCodeRef = doc(codesCollection);
                    batch.set(newCodeRef, {
                        code: code,
                        description: description,
                        department: targetDepartment,
                        created: new Date().toISOString().split('T')[0],
                        expiry: expiryInput,
                    });
                    generatedCount++;
                }
            }

            try {
                await batch.commit();
                showCustomAlert(`${quantity} Codes f√ºr die Abteilung '${deptNames[targetDepartment]}' wurden erfolgreich generiert.`);
            } catch (error) {
                console.error("Error writing batch: ", error);
                showCustomAlert("Fehler beim Erstellen der Codes.");
            }

            descriptionInput.value = '';
            expiryInputEl.value = '';
        }

        // Load Dashboard Data
        function loadDashboardData() {
            const codeTableBody = document.getElementById('codeTableBody');
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);

            document.getElementById('selectAllCheckbox').checked = false;
            updateDownloadButtonState();

            if (departmentCodes.length === 0) {
                 codeTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #6c757d; padding: 20px;">Keine Codes f√ºr diese Abteilung vorhanden.</td></tr>`;
                 return;
            }

            document.querySelector('.code-table th:nth-child(4)').style.display = isAdmin ? '' : 'none';

            codeTableBody.innerHTML = departmentCodes.sort((a,b) => new Date(b.created) - new Date(a.created)).map(code => {
                const isExpired = new Date() > new Date(code.expiry);
                const status = isExpired ? 'Abgelaufen' : 'Aktiv';
                const statusClass = isExpired ? 'status-expired' : 'status-active';
                const participants = testResults.filter(r => r.testCode === code.code).length;

                return `
                    <tr data-doc-id="${code.id}" data-code="${code.code}">
                        <td><input type="checkbox" class="code-checkbox" value="${code.code}"></td>
                        <td><span class="code-badge">${code.code}</span></td>
                        <td>${code.description}</td>
                        <td style="display: ${isAdmin ? '' : 'none'}">${deptNames[code.department] || code.department}</td>
                        <td>${code.created}</td>
                        <td>${code.expiry}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span> (${participants})</td>
                        <td>
                            <button class="action-button view-button">Ansehen</button>
                            <button class="action-button delete-button">L√∂schen</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateStatistics();
        }

        // Load Results Data
        function loadResultsData() {
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            const codeFilter = document.getElementById('codeFilter');
            codeFilter.innerHTML = '<option value="">Alle Codes</option>' + 
                codeList.map(code => `<option value="${code}">${code}</option>`).join('');
            
            displayResults(relevantResults);
        }

        // Display Results
        function displayResults(results) {
            const resultsTableBody = document.getElementById('resultsTableBody');
            
            if (results.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #6c757d; padding: 20px;">Keine Ergebnisse vorhanden</td></tr>';
                return;
            }
            
            resultsTableBody.innerHTML = results.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(result => {
                const scoreClass = result.totalPercentage >= 80 ? 'score-high' : 
                                     result.totalPercentage >= 60 ? 'score-medium' : 'score-low';
                
                return `
                    <tr data-doc-id="${result.id}">
                        <td><span class="code-badge">${result.testCode}</span></td>
                        <td>${new Date(result.timestamp).toLocaleDateString('de-DE')}</td>
                        <td><span class="score-badge ${scoreClass}">${result.totalPercentage}%</span></td>
                        <td>${result.categoryPercentages[1]}%</td>
                        <td>${result.categoryPercentages[2]}%</td>
                        <td>${result.categoryPercentages[3]}%</td>
                        <td>${result.categoryPercentages[4]}%</td>
                        <td>${result.categoryPercentages[5]}%</td>
                        <td>
                            <button class="action-button view-button">Details</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load Statistics Data
        function loadStatisticsData() {
            const departmentCodes = currentDepartment === 'admin' 
                ? generatedCodes 
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            if (relevantResults.length > 0) {
                for (let i = 1; i <= 5; i++) {
                    const scores = relevantResults.map(r => r.categoryPercentages[i]);
                    const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                    const bar = document.getElementById(`bar${i}`);
                    bar.style.width = avg + '%';
                    bar.textContent = avg + '%';
                }
            } else {
                 for (let i = 1; i <= 5; i++) {
                    const bar = document.getElementById(`bar${i}`);
                    bar.style.width = '0%';
                    bar.textContent = '0%';
                }
            }
        }
        
        // Load Admin specific data
        function loadAdminData() {
            const adminTableBody = document.getElementById('adminTableBody');
            const departments = Object.keys(deptNames).filter(d => d !== 'admin');
            document.getElementById('allDepartmentsCount').textContent = departments.length;
            
            const tableRows = departments.map(deptKey => {
                const deptCodes = generatedCodes.filter(c => c.department === deptKey).map(c => c.code);
                const deptResults = testResults.filter(r => deptCodes.includes(r.testCode));
                
                if (deptResults.length === 0) {
                     return `<tr><td>${deptNames[deptKey]}</td><td>0</td><td>N/A</td><td>N/A</td><td>N/A</td></tr>`;
                }

                const avgScore = Math.round(deptResults.reduce((sum, r) => sum + r.totalPercentage, 0) / deptResults.length);
                const scoreClass = avgScore >= 80 ? 'score-high' : avgScore >= 60 ? 'score-medium' : 'score-low';
                
                const categoryAvgs = [];
                 for (let i = 1; i <= 5; i++) {
                    const scores = deptResults.map(r => r.categoryPercentages[i]);
                    categoryAvgs.push({
                        name: i,
                        avg: Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
                    });
                }
                
                categoryAvgs.sort((a,b) => b.avg - a.avg);
                const bestCat = categoryAvgs[0].name;
                const worstCat = categoryAvgs[categoryAvgs.length - 1].name;
                const catNames = ["Grundkenntnisse IKT", "Anwendung im Unterricht", "Medien- & Infokompetenz", "Daten & Sicherheit", "Kommunikation"];

                return `
                    <tr>
                        <td>${deptNames[deptKey]}</td>
                        <td>${deptResults.length}</td>
                        <td><span class="score-badge ${scoreClass}">${avgScore}%</span></td>
                        <td>${catNames[bestCat-1]}</td>
                        <td>${catNames[worstCat-1]}</td>
                    </tr>`;
            }).join('');
            
            adminTableBody.innerHTML = tableRows;
            updateStatistics();
        }

        // Update Statistics
        function updateStatistics() {
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            document.getElementById('totalTests').textContent = relevantResults.length;
            document.getElementById('activeCodes').textContent = departmentCodes.filter(c => new Date(c.expiry) >= new Date()).length;
            
            if (relevantResults.length > 0) {
                const avgScore = Math.round(relevantResults.reduce((sum, r) => sum + r.totalPercentage, 0) / relevantResults.length);
                document.getElementById('avgScore').textContent = avgScore + '%';
                
                const totalCodes = departmentCodes.length;
                const usedCodes = new Set(relevantResults.map(r => r.testCode)).size;
                const completionRate = totalCodes > 0 ? Math.round((usedCodes / totalCodes) * 100) : 0;
                document.getElementById('completionRate').textContent = completionRate + '%';
            } else {
                 document.getElementById('avgScore').textContent = '0%';
                 document.getElementById('completionRate').textContent = '0%';
            }
            
            if (isAdmin) {
                document.getElementById('totalTestsAdmin').textContent = testResults.length;
                if (testResults.length > 0) {
                    const avgScoreAdmin = Math.round(testResults.reduce((sum, r) => sum + r.totalPercentage, 0) / testResults.length);
                    document.getElementById('avgScoreAdmin').textContent = avgScoreAdmin + '%';
                } else {
                    document.getElementById('avgScoreAdmin').textContent = '0%';
                }
            }
        }

        // View Code Details
        function viewCodeDetails(docId) {
            const codeData = generatedCodes.find(c => c.id === docId);
            const codeResults = testResults.filter(r => r.testCode === codeData.code);
            
            document.getElementById('modalTitle').textContent = `Details f√ºr Code: ${codeData.code}`;
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <p><strong>Beschreibung:</strong> ${codeData.description}</p>
                <p><strong>Abteilung:</strong> ${deptNames[codeData.department]}</p>
                <p><strong>Erstellt:</strong> ${codeData.created}</p>
                <p><strong>G√ºltig bis:</strong> ${codeData.expiry}</p>
                <p><strong>Teilnehmer:</strong> ${codeResults.length}</p>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        // View Result Details
        function viewResultDetails(docId) {
            const result = testResults.find(r => r.id === docId);
            
            document.getElementById('modalTitle').textContent = 'Test-Ergebnis Details';
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <p><strong>Code:</strong> ${result.testCode}</p>
                <p><strong>Datum:</strong> ${new Date(result.timestamp).toLocaleString('de-DE')}</p>
                <p><strong>Testdauer:</strong> ${Math.round(result.duration / 60)} Minuten</p>
                <p><strong>Gesamtscore:</strong> ${result.totalPercentage}%</p>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        // Delete Code
        async function deleteCode(docId, code) {
             showCustomConfirm(
                `M√∂chten Sie den Code <strong>${code}</strong> wirklich l√∂schen? Alle zugeh√∂rigen Ergebnisse werden ebenfalls entfernt.`,
                "L√∂schen",
                async () => {
                    await deleteDoc(doc(db, "codes", docId));
                    const q = query(resultsCollection, where("testCode", "==", code));
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    showCustomAlert(`Code ${code} und alle Ergebnisse wurden gel√∂scht.`);
                }
            );
        }
        
        // Admin: Reset Password
        async function resetPassword() {
            const departmentToReset = document.getElementById('resetPwDepartment').value;
            const newPassword = document.getElementById('newPassword').value;

            if (newPassword.length < 6) {
                showCustomAlert('Das Passwort muss mindestens 6 Zeichen lang sein.');
                return;
            }

            showCustomConfirm(
                `M√∂chten Sie das Passwort f√ºr <strong>${deptNames[departmentToReset]}</strong> wirklich √§ndern?`,
                "Ja, √§ndern",
                async () => {
                    userAccounts[departmentToReset].pass = newPassword;
                    await setDoc(accountsDocRef, userAccounts);
                    document.getElementById('newPassword').value = '';
                    showCustomAlert(`Das Passwort f√ºr ${deptNames[departmentToReset]} wurde ge√§ndert.`);
                }
            );
        }

        // Modal and UI Helper Functions
        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('active');
        }

        function showCustomAlert(message) {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertModalTitle').textContent = 'Hinweis';
            document.getElementById('alertModalBody').innerHTML = `<p>${message}</p>`;
            document.getElementById('alertModalFooter').innerHTML = 
                `<button class="login-button" style="width: auto; padding: 10px 30px;" onclick="document.getElementById('alertModal').classList.remove('active')">OK</button>`;
            modal.classList.add('active');
        };
        
        function showCustomConfirm(message, confirmText, onConfirm) {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertModalTitle').textContent = 'Best√§tigung erforderlich';
            document.getElementById('alertModalBody').innerHTML = `<p>${message}</p>`;
            document.getElementById('alertModalFooter').innerHTML = `
                <button class="logout-button" style="background: #6c757d; color: white; border: none; margin-right: 10px;" id="confirmCancelBtn">Abbrechen</button>
                <button class="login-button" style="background: #dc3545;" id="confirmOkBtn">${confirmText}</button>`;
            
            modal.classList.add('active');

            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');

            const handleConfirm = (result) => {
                closeModal('alertModal');
                if (result) onConfirm();
            };
            
            cancelBtn.onclick = () => handleConfirm(false);
            okBtn.onclick = () => handleConfirm(true);
        };

        function updateDownloadButtonState() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            document.getElementById('downloadCodesBtn').disabled = checkedBoxes.length === 0;
        };

        function toggleAllCheckboxes(source) {
            document.querySelectorAll('.code-checkbox').forEach(cb => cb.checked = source.checked);
            updateDownloadButtonState();
        };

        function downloadSelectedCodes() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            const codesToDownload = Array.from(checkedBoxes).map(cb => cb.value);
            const relevantCodesData = generatedCodes.filter(c => codesToDownload.includes(c.code));
            if (relevantCodesData.length === 0) return;
            let csv = 'Code,Beschreibung,GueltigBis\n';
            relevantCodesData.forEach(c => { csv += `${c.code},"${c.description}",${c.expiry}\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-codes_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };
        function exportResults() {
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin
                ? generatedCodes
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            if (relevantResults.length === 0) {
                showCustomAlert('Keine Ergebnisse zum Exportieren vorhanden.');
                return;
            }
            
            let csv = 'Code,Datum,Gesamtscore,Grundkenntnisse IKT,Anwendung im Unterricht,Medien- & Infokompetenz,Daten & Sicherheit,Kommunikation\n';
            
            relevantResults.forEach(result => {
                csv += `${result.testCode},${new Date(result.timestamp).toLocaleDateString('de-DE')},`;
                csv += `${result.totalPercentage},${result.categoryPercentages[1]},${result.categoryPercentages[2]},${result.categoryPercentages[3]},${result.categoryPercentages[4]},${result.categoryPercentages[5]}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kompetenzen_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        };
        function filterResults() {
            const selectedCode = document.getElementById('codeFilter').value;
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin
                ? generatedCodes
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            let relevantResults = testResults.filter(r => codeList.includes(r.testCode));

            if (selectedCode) {
                 relevantResults = relevantResults.filter(r => r.testCode === selectedCode)
            }
            
            displayResults(relevantResults);
        };

        // Event Listeners Setup
        document.addEventListener('DOMContentLoaded', async () => {
// Login-Button w√§hrend des Ladens deaktivieren
const loginButton = document.querySelector('.login-button');
if (loginButton) {
  loginButton.disabled = true;
  loginButton.textContent = 'L√§dt...';
}

try {
  await initializeAppWithFirebase();
} catch (error) {
  console.error('Fehler bei der Firebase-Initialisierung:', error);
} finally {
  if (loginButton) {
    loginButton.disabled = false;
    loginButton.textContent = 'Anmelden';
  }
}
document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('generateCodesBtn').addEventListener('click', generateCodes);
            document.getElementById('resetPasswordBtn').addEventListener('click', resetPassword);
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => toggleAllCheckboxes(e.target));
            document.getElementById('downloadCodesBtn').addEventListener('click', downloadSelectedCodes);
            document.getElementById('exportResultsBtn').addEventListener('click', exportResults);
            document.getElementById('codeFilter').addEventListener('change', filterResults);

            document.getElementById('tabNav').addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    switchTab(e);
                }
            });

            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', (e) => closeModal(e.target.dataset.modalId));
            });

            document.getElementById('codeTableBody').addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (!row) return;

                const docId = row.dataset.docId;
                const code = row.dataset.code;

                if (e.target.matches('.view-button')) {
                    viewCodeDetails(docId);
                } else if (e.target.matches('.delete-button')) {
                    deleteCode(docId, code);
                }
            });

             document.getElementById('resultsTableBody').addEventListener('click', e => {
                if(e.target.matches('.view-button')) {
                    const row = e.target.closest('tr');
                    const docId = row.dataset.docId;
                    viewResultDetails(docId);
                }
            });
            
             document.getElementById('codeTableBody').addEventListener('change', e => {
                if (e.target.matches('.code-checkbox')) {
                    updateDownloadButtonState();
                }
            });
        });
    </script>
</body>
</html>

