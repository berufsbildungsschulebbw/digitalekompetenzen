<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intra - BBW Digitale Kompetenzen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: calc(100vh - 40px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #5a67d8;
        }

        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        h3 {
             color: #2d3748;
             margin-bottom: 15px;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }

        /* Login Section */
        .login-section {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-section h2 {
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: #9C27B0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        /* Dashboard Section */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details h3 {
            margin-bottom: 5px;
            color: white;
        }

        .logout-button {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-button:hover {
            background: white;
            color: #667eea;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6c757d;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            color: #495057;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Code Management */
        .code-generator {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .code-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .code-form .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 0;
        }

        .generate-button {
            padding: 12px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-button:hover {
            background: #218838;
        }

        .code-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .download-button {
             padding: 10px 20px;
             background: #007bff;
             color: white;
             border: none;
             border-radius: 8px;
             font-weight: bold;
             cursor: pointer;
             transition: all 0.3s;
        }
        
        .download-button:hover {
            background: #0056b3;
        }
        
        .download-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .code-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .code-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .code-table th, .code-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }
        
        .code-table th:first-child, .code-table td:first-child {
            width: 40px;
            text-align: center;
        }

        .code-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .code-table tr:last-child td {
            border-bottom: none;
        }

        .code-table tr:hover {
            background: #f8f9fa;
        }

        .code-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 20px;
            font-weight: 500;
            font-family: monospace;
            font-size: 1.1em;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-used {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .action-button {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .view-button {
            background: #17a2b8;
            color: white;
        }

        .view-button:hover {
            background: #138496;
        }

        .delete-button {
            background: #dc3545;
            color: white;
        }

        .delete-button:hover {
            background: #c82333;
        }

        /* Results Section */
        .results-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        /* Department Stats */
        .department-chart {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .chart-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
        }

        .chart-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-label {
            width: 200px;
            font-weight: 500;
            color: #495057;
        }

        .bar-container {
            flex: 1;
            background: #e9ecef;
            border-radius: 5px;
            height: 30px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }

        /* Individual Results */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .results-table th, .results-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            text-align: left;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-table tr:last-child td {
            border-bottom: none;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
        }

        .score-high { background: #28a745; }
        .score-medium { background: #ffc107; }
        .score-low { background: #dc3545; }

        /* Export Button */
        .export-button {
            padding: 12px 30px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .export-button:hover {
            background: #5a6268;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
             color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .tab-navigation {
                flex-wrap: wrap;
            }

            .code-form {
                flex-direction: column;
                align-items: stretch;
            }
            
             .code-form .form-group {
                margin-bottom: 15px;
            }

            .user-info {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-button">← Zurück zur Startseite</a>
        
        <div class="header">
            <h1>Intra-Bereich</h1>
            <p class="subtitle">Verwaltung und Auswertung digitaler Kompetenzen</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>🔐 Anmeldung</h2>
            <div id="errorMessage" class="error-message">
                Ungültige Anmeldedaten. Bitte versuchen Sie es erneut.
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select id="department" class="form-select" required>
                        <option value="">Bitte wählen...</option>
                        <option value="bau">Bau</option>
                        <option value="technik">Technik | Ernährung</option>
                        <option value="maschinenbau">Maschinenbau</option>
                        <option value="informatik">Informatik | Naturwissenschaften</option>
                        <option value="admin">Administration</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Benutzername</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" class="login-button">Anmelden</button>
            </form>
            <p style="margin-top: 20px; color: #6c757d; font-size: 0.9em; text-align: center;">
                Demo-Login: Wählen Sie eine Abteilung, Benutzer: <strong>demo</strong>, PW: <strong>demo123</strong><br>
                Admin-Login: Abteilung Admin, Benutzer: <strong>admin</strong>, PW: <strong>admin123</strong>
            </p>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard-section">
            <!-- User Info Bar -->
            <div class="user-info">
                <div class="user-details">
                    <h3 id="userDepartment">Abteilung</h3>
                    <p id="userName">Benutzer</p>
                </div>
                <button id="logoutBtn" class="logout-button">Abmelden</button>
            </div>

            <!-- Tab Navigation -->
            <div id="tabNav" class="tab-navigation">
                <button class="tab-button active" data-tab="codes">
                    📝 Code-Verwaltung
                </button>
                <button class="tab-button" data-tab="results">
                    📊 Ergebnisse
                </button>
                <button class="tab-button" data-tab="statistics">
                    📈 Statistiken
                </button>
                <button id="adminTabButton" class="tab-button" data-tab="admin" style="display: none;">
                    ⚙️ Administration
                </button>
            </div>

            <!-- Tab: Code Management -->
            <div id="codesTab" class="tab-content active">
                <div class="code-generator">
                    <h3>Neue Test-Codes generieren</h3>
                    <div class="code-form">
                        <!-- Zugangsdaten verwalten (nur Admin) -->
                        <div class="form-group" id="adminCredentialsSection" style="display: none; border-top: 1px dashed #ccc; padding-top: 12px; margin-top: 12px;">
                            <label class="form-label">Zugangsdaten verwalten</label>
                            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                                <div style="min-width:220px;">
                                    <label class="form-label">Abteilung</label>
                                    <select id="credDepartmentSelect" class="form-select">
                                        <option value="admin">Administration</option>
                                        <option value="bau">Bau</option>
                                        <option value="technik">Technik | Ernährung</option>
                                        <option value="maschinenbau">Maschinenbau</option>
                                        <option value="informatik">Informatik | Naturwissenschaften</option>
                                    </select>
                                </div>
                                <div style="min-width:220px;">
                                    <label class="form-label">Benutzername</label>
                                    <input id="credUsername" type="text" class="form-input" placeholder="z.B. admin">
                                </div>
                                <div style="min-width:220px;">
                                    <label class="form-label">Passwort</label>
                                    <input id="credPassword" type="password" class="form-input" placeholder="Neues Passwort">
                                </div>
                            </div>
                            <div style="margin-top:10px; display:flex; gap:10px;">
                                <button id="loadCredsBtn" class="generate-button" type="button">Aktuelle laden</button>
                                <button id="saveCredsBtn" class="generate-button" type="button">Zugang speichern</button>
                            </div>
                            <small style="opacity:0.7;">Hinweis: Speicherung in Firestore-Dokument <code>config/userAccounts</code>. Fällt automatisch auf Demo-Logins zurück, wenn Firestore fehlt.</small>
                        </div>

                        <div class="form-group" id="adminDepartmentSelector" style="display: none;">
                            <label class="form-label">Für Abteilung</label>
                             <select id="adminDepartmentSelect" class="form-select">
                                                                <option value="admin">Administration</option>
<option value="bau">Bau</option>
                                <option value="technik">Technik | Ernährung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <input type="text" id="codeDescription" class="form-input" 
                                   placeholder="z.B. Q1 2025 Assessment" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gültig bis</label>
                            <input type="date" id="codeExpiry" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anzahl</label>
                            <input id="codeQuantity" type="number" class="form-input" min="1" max="1000" step="1" value="10">
                        </div>
                        <button id="generateCodesBtn" class="generate-button">
                            Codes generieren
                        </button>
                    </div>
                </div>

                <div class="code-list-header">
                     <h3>Generierte Codes</h3>
                     <div style="display: flex; gap: 10px;">
                         <button id="downloadCodesBtn" class="download-button" disabled>
                            📥 Ausgewählte herunterladen
                         </button>
                         <button id="deleteSelectedBtn" class="delete-button" style="padding: 10px 20px; border-radius: 8px; font-weight: bold;" disabled>
                            🗑️ Ausgewählte löschen
                         </button>
                     </div>
                </div>

                <div class="code-list">
                    <table class="code-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Code</th>
                                <th>Beschreibung</th>
                                <th>Abteilung</th>
                                <th>Erstellt am</th>
                                <th>Gültig bis</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="codeTableBody">
                            <!-- Codes will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Results -->
            <div id="resultsTab" class="tab-content">
                <div class="results-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTests">0</div>
                        <div class="stat-label">Durchgeführte Tests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScore">0%</div>
                        <div class="stat-label">Durchschnittlicher Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCodes">0</div>
                        <div class="stat-label">Aktive Codes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">Abschlussrate</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Individuelle Ergebnisse nach Code</h3>
                <div style="margin-bottom: 20px;">
                    <select id="codeFilter" class="form-select" style="width: auto;">
                        <option value="">Alle Codes</option>
                    </select>
                </div>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Datum</th>
                            <th>Gesamtscore</th>
                            <th>Bereich 1</th>
                            <th>Bereich 2</th>
                            <th>Bereich 3</th>
                            <th>Bereich 4</th>
                            <th>Bereich 5</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>

                <button id="exportResultsBtn" class="export-button">
                    📥 Ergebnisse exportieren (CSV)
                </button>
            </div>

            <!-- Tab: Statistics -->
            <div id="statisticsTab" class="tab-content">
                <div class="department-chart">
                    <div class="chart-header">Durchschnittliche Scores nach Kompetenzbereich</div>
                    <div class="chart-bars">
                        <div class="chart-bar">
                            <div class="bar-label">Grundkenntnisse IKT</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar1" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Anwendung im Unterricht</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar2" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Medien- & Infokompetenz</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar3" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Daten & Sicherheit</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar4" style="width: 0%;">0%</div>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">Kommunikation</div>
                            <div class="bar-container">
                                <div class="bar-fill" id="bar5" style="width: 0%;">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="department-chart">
                    <div class="chart-header">Entwicklung über Zeit</div>
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        Hier würde ein Liniendiagramm mit der zeitlichen Entwicklung der Kompetenzen angezeigt werden.
                    </p>
                </div>
            </div>

            <!-- Tab: Admin (only for admin users) -->
            <div id="adminTab" class="tab-content">
                 <div class="code-generator">
                    <h3>Passwort zurücksetzen</h3>
                    <div class="code-form">
                        <div class="form-group">
                             <label class="form-label">Abteilung</label>
                             <select id="resetPwDepartment" class="form-select">
                                <option value="bau">Bau</option>
                                <option value="technik">Technik | Ernährung</option>
                                <option value="maschinenbau">Maschinenbau</option>
                                <option value="informatik">Informatik | Naturwissenschaften</option>
                            </select>
                        </div>
                        <div class="form-group">
                             <label class="form-label">Neues Passwort</label>
                            <input type="text" id="newPassword" class="form-input" placeholder="Mind. 6 Zeichen">
                        </div>
                         <button id="resetPasswordBtn" class="generate-button" style="background: #ffc107;">
                            Passwort ändern
                        </button>
                    </div>
                </div>
            
                <h3>Abteilungsübersicht</h3>
                <div class="results-overview">
                    <div class="stat-card">
                        <div class="stat-number" id="allDepartmentsCount">0</div>
                        <div class="stat-label">Aktive Abteilungen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTestsAdmin">0</div>
                        <div class="stat-label">Tests Gesamt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScoreAdmin">0%</div>
                        <div class="stat-label">Gesamt-Durchschnitt</div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px;">Abteilungsvergleich</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Abteilung</th>
                            <th>Anzahl Tests</th>
                            <th>Ø Score</th>
                            <th>Beste Kompetenz</th>
                            <th>Schwächste Kompetenz</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody">
                       <!-- Admin data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal for Details -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Test-Details</h3>
                    <button class="modal-close" data-modal-id="detailModal">×</button>
                </div>
                <div id="modalBody">
                    <!-- Details will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- General Purpose Modal for Alerts/Confirms -->
        <div id="alertModal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                 <div class="modal-header">
                    <h3 id="alertModalTitle">Hinweis</h3>
                    <button class="modal-close" data-modal-id="alertModal">×</button>
                </div>
                <div id="alertModalBody" style="margin: 10px 0 20px; color: #495057; line-height: 1.6;">
                    <!-- Alert/Confirm message goes here -->
                </div>
                <div id="alertModalFooter" style="text-align: right;">
                    <!-- Buttons go here -->
                </div>
            </div>
        </div>
        
    </div>
    
    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCHhycjQmHU00_dQl5Xdo5PZCTn8JODk20",
            authDomain: "ikt-komp-bbw.firebaseapp.com",
            projectId: "ikt-komp-bbw",
            storageBucket: "ikt-komp-bbw.firebasestorage.app",
            messagingSenderId: "154620660911",
            appId: "1:154620660911:web:20d389d699d2f0d2c2d85a",
            measurementId: "G-JZ1VC46184"
        });
    </script>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            writeBatch, 
            where, 
            getDocs,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration is provided by the environment
        const rawFirebaseConfig = (typeof __firebase_config !== "undefined" && __firebase_config)
            ? JSON.parse(__firebase_config)
            : null;

        const hasValidFirebaseConfig = rawFirebaseConfig && rawFirebaseConfig.apiKey && rawFirebaseConfig.projectId;

        // Initialize Firebase guarded
        let app = null, db = null, auth = null;
        let firebaseReady = false;

        try {
            if (hasValidFirebaseConfig) {
                app = initializeApp(rawFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseReady = true;
                console.log("Firebase erfolgreich initialisiert");
            } else {
                console.warn("Kein gültiges Firebase-Config gefunden – starte im Local-Mode.");
            }
        } catch (e) {
            console.warn("Firebase-Initialisierung übersprungen (fehlende/ungültige Config):", e);
            firebaseReady = false;
        }

        // Firestore Collection References (nur wenn verfügbar)
        let codesCollection = null;
        let resultsCollection = null;
        let accountsDocRef = null;
        if (db) {
            codesCollection = collection(db, 'codes');
            resultsCollection = collection(db, 'results');
            accountsDocRef = doc(db, 'config', 'userAccounts');
        }

        // State Management
        let currentUser = null;
        let currentDepartment = null;
        let generatedCodes = [];
        let testResults = [];
        let userAccounts = {};

        // Global verfügbar machen für Debugging
        window.generatedCodes = generatedCodes;
        window.testResults = testResults;
        window.currentDepartment = currentDepartment;

        const deptNames = {
            'bau': 'Bau',
            'technik': 'Technik | Ernährung',
            'maschinenbau': 'Maschinenbau',
            'informatik': 'Informatik | Naturwissenschaften',
            'admin': 'Administration'
        };

        async function initializeAppWithFirebase() {
            // Wenn Firebase nicht bereit ist: Local-Mode mit Demologins
            if (!firebaseReady || !auth || !db || !accountsDocRef) {
                console.warn("Initialize: Firebase nicht verfügbar – Demologins aktiv.");
                userAccounts = {
                    'bau': { user: 'demo', pass: 'demo123' },
                    'technik': { user: 'demo', pass: 'demo123' },
                    'maschinenbau': { user: 'demo', pass: 'demo123' },
                    'informatik': { user: 'demo', pass: 'demo123' },
                    'admin': { user: 'admin', pass: 'admin123' }
                };
                return;
            }

            try {
                // Sign in using the provided token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                const docSnap = await getDoc(accountsDocRef);
                if (docSnap.exists()) {
                    userAccounts = docSnap.data();
                } else {
                    console.log("No account config found, creating default accounts...");
                    userAccounts = {
                        'bau': { user: 'demo', pass: 'demo123' },
                        'technik': { user: 'demo', pass: 'demo123' },
                        'maschinenbau': { user: 'demo', pass: 'demo123' },
                        'informatik': { user: 'demo', pass: 'demo123' },
                        'admin': { user: 'admin', pass: 'admin123' }
                    };
                    await setDoc(accountsDocRef, userAccounts);
                }

                // Real-time listeners mit besserer Fehlerbehandlung
                if (codesCollection) {
                    const unsubscribeCodes = onSnapshot(codesCollection, 
                        (snapshot) => {
                            generatedCodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.generatedCodes = generatedCodes; // Global verfügbar machen
                            console.log("Codes aktualisiert:", generatedCodes.length);
                            if (currentUser) {
                                loadDashboardData();
                            }
                        },
                        (error) => {
                            console.error("Fehler beim Codes-Listener:", error);
                        }
                    );
                }

                if (resultsCollection) {
                    const unsubscribeResults = onSnapshot(resultsCollection, 
                        (snapshot) => {
                            testResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            window.testResults = testResults; // Global verfügbar machen
                            console.log("Results aktualisiert:", testResults.length);
                            if (currentUser) {
                                updateStatistics();
                                if (document.getElementById('resultsTab').classList.contains('active')) {
                                    loadResultsData();
                                }
                            }
                        },
                        (error) => {
                            console.error("Fehler beim Results-Listener:", error);
                        }
                    );
                }

                // Initiale Daten laden
                await loadInitialData();
                
            } catch (error) {
                console.error('Fehler bei der Firebase-Initialisierung:', error);
                // Fallback auf Local-Mode
                if (!userAccounts || Object.keys(userAccounts).length === 0) {
                    userAccounts = {
                        'bau': { user: 'demo', pass: 'demo123' },
                        'technik': { user: 'demo', pass: 'demo123' },
                        'maschinenbau': { user: 'demo', pass: 'demo123' },
                        'informatik': { user: 'demo', pass: 'demo123' },
                        'admin': { user: 'admin', pass: 'admin123' }
                    };
                }
            }
        }

        // Neue Funktion: Initiale Daten laden
        async function loadInitialData() {
            if (!firebaseReady || !codesCollection || !resultsCollection) return;
            
            try {
                // Codes manuell laden
                const codesSnapshot = await getDocs(codesCollection);
                generatedCodes = codesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.generatedCodes = generatedCodes;
                console.log("Initiale Codes geladen:", generatedCodes.length);
                
                // Results manuell laden
                const resultsSnapshot = await getDocs(resultsCollection);
                testResults = resultsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.testResults = testResults;
                console.log("Initiale Results geladen:", testResults.length);
            } catch (error) {
                console.error("Fehler beim initialen Laden:", error);
            }
        }

        // Login Handler
        async function handleLogin(event) {
            event.preventDefault();
            
            const department = document.getElementById('department').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const account = userAccounts[department];

            // Allow login if credentials match Firestore DB OR if it's the standard demo login (for non-admin departments)
            let loginOk = false;
            if (Array.isArray(account)) {
                loginOk = account.some(acc => username === acc.user && password === acc.pass);
            } else if (account && typeof account === 'object') {
                loginOk = (username === account.user && password === account.pass);
            }
            const demoAllowed = ((!account) || (Array.isArray(account) && account.length === 0)) && department && department !== 'admin';
            if ((loginOk && department) || (demoAllowed && username === 'demo' && password === 'demo123')) {
                currentUser = username;
                currentDepartment = department;
                window.currentDepartment = department; // Global verfügbar machen
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').classList.add('active');
                
                document.getElementById('userDepartment').textContent = deptNames[department] || department;
                document.getElementById('userName').textContent = `Benutzer: ${username}`;
                
                const isAdmin = department === 'admin';
                document.getElementById('adminTabButton').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('adminDepartmentSelector').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('adminCredentialsSection').style.display = isAdmin ? 'block' : 'none';
                if (isAdmin) { try { renderCredUserList(); } catch(_){} }

                // Nach Login: Daten neu laden
                await loadInitialData();
                loadDashboardData();
            } else {
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                setTimeout(() => {
                   errorMessage.style.display = 'none';
                }, 3000);
            }
        }

        // Logout Handler
        function handleLogout() {
            currentUser = null;
            currentDepartment = null;
            window.currentDepartment = null;
            document.getElementById('dashboardSection').classList.remove('active');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminTabButton').style.display = 'none';
            
            document.getElementById('department').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Tab Switching
        function switchTab(event) {
            const tabName = event.currentTarget.dataset.tab;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'results') loadResultsData();
            if (tabName === 'statistics') loadStatisticsData();
            if (tabName === 'admin') loadAdminData();
        }

        // Hilfsfunktion zum Generieren eines zufälligen Codes
        function generateRandomCode() {
            const part1 = Math.random().toString(36).substring(2, 6).toUpperCase();
            const part2 = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `${part1}-${part2}`;
        }

        // KORRIGIERTE generateCodes Funktion mit manuellem Reload
        async function generateCodes() {
            try {
                // Korrekte Element-IDs verwenden
                const description = document.getElementById('codeDescription').value.trim();
                const expiryStr = document.getElementById('codeExpiry').value;
                const quantity = parseInt(document.getElementById('codeQuantity').value);
                
                // Für Admin: Abteilung aus dem Admin-Selektor holen
                const isAdmin = currentDepartment === 'admin';
                const targetDepartment = isAdmin 
                    ? document.getElementById('adminDepartmentSelect').value 
                    : currentDepartment;

                if (!description || !expiryStr) {
                    showCustomAlert('Bitte alle Felder ausfüllen.');
                    return;
                }

                // Prüfen ob Firebase verfügbar ist
                if (!firebaseReady || !db) {
                    // Local Mode - nur in Arrays speichern
                    const newCodes = [];
                    for (let i = 0; i < quantity; i++) {
                        const code = generateRandomCode();
                        const newCode = {
                            id: 'local_' + Date.now() + '_' + i,
                            code: code,
                            description: description,
                            department: targetDepartment,
                            created: new Date().toLocaleDateString('de-DE'),
                            expiry: new Date(expiryStr).toLocaleDateString('de-DE'),
                            status: 'Aktiv',
                            timestamp: Date.now()
                        };
                        generatedCodes.push(newCode);
                        newCodes.push(code);
                    }
                    
                    window.generatedCodes = generatedCodes;
                    showCustomAlert(`${quantity} Code(s) wurden lokal generiert: ${newCodes.join(', ')}`);
                    loadDashboardData();
                    
                    // Formular zurücksetzen
                    document.getElementById('codeDescription').value = '';
                    document.getElementById('codeExpiry').value = '';
                    return;
                }

                // Firebase Mode
                const newCodes = [];
                for (let i = 0; i < quantity; i++) {
                    const code = generateRandomCode();
                    
                    const codeData = {
                        code: code,
                        description: description,
                        department: targetDepartment,
                        created: new Date().toLocaleDateString('de-DE'),
                        expiry: new Date(expiryStr).toLocaleDateString('de-DE'),
                        createdTimestamp: serverTimestamp(),
                        expiryDate: new Date(expiryStr).toISOString(),
                        status: 'Aktiv'
                    };

                    // Verwende die globale codesCollection Variable
                    await addDoc(codesCollection, codeData);
                    newCodes.push(code);
                }

                showCustomAlert(`${quantity} Code(s) wurden erfolgreich generiert: ${newCodes.join(', ')}`);
                
                // Formular zurücksetzen
                document.getElementById('codeDescription').value = '';
                document.getElementById('codeExpiry').value = '';
                
                // Nach dem Generieren: Codes manuell neu laden
                setTimeout(async () => {
                    await loadInitialData();
                    loadDashboardData();
                }, 1500);
                
            } catch (error) {
                console.error('Fehler beim Generieren der Codes:', error);
                showCustomAlert('Fehler beim Generieren der Codes: ' + error.message);
            }
        }

        // Load Dashboard Data - Global verfügbar machen
        function loadDashboardData() {
            const codeTableBody = document.getElementById('codeTableBody');
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);

            console.log("LoadDashboard - Alle Codes:", generatedCodes.length, "Department Codes:", departmentCodes.length);

            document.getElementById('selectAllCheckbox').checked = false;
            updateDownloadButtonState();

            if (departmentCodes.length === 0) {
                 codeTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #6c757d; padding: 20px;">Keine Codes für diese Abteilung vorhanden.</td></tr>`;
                 return;
            }

            document.querySelector('.code-table th:nth-child(4)').style.display = isAdmin ? '' : 'none';

            codeTableBody.innerHTML = departmentCodes.sort((a,b) => {
                // Sortiere nach Timestamp wenn vorhanden, sonst nach created string
                if (a.timestamp && b.timestamp) {
                    return b.timestamp - a.timestamp;
                }
                return new Date(b.created) - new Date(a.created);
            }).map(code => {
                const isExpired = new Date() > new Date(code.expiry || code.expiryDate);
                const status = isExpired ? 'Abgelaufen' : 'Aktiv';
                const statusClass = isExpired ? 'status-expired' : 'status-active';
                const participants = testResults.filter(r => r.testCode === code.code).length;

                return `
                    <tr data-doc-id="${code.id}" data-code="${code.code}">
                        <td><input type="checkbox" class="code-checkbox" value="${code.code}"></td>
                        <td><span class="code-badge">${code.code}</span></td>
                        <td>${code.description}</td>
                        <td style="display: ${isAdmin ? '' : 'none'}">${deptNames[code.department] || code.department}</td>
                        <td>${code.created}</td>
                        <td>${code.expiry}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span> (${participants})</td>
                        <td>
                            <button class="action-button view-button">Ansehen</button>
                            <button class="action-button delete-button">Löschen</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateStatistics();
        }
        
        // Global verfügbar machen
        window.loadDashboardData = loadDashboardData;

        // Load Results Data
        function loadResultsData() {
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            const codeFilter = document.getElementById('codeFilter');
            codeFilter.innerHTML = '<option value="">Alle Codes</option>' + 
                codeList.map(code => `<option value="${code}">${code}</option>`).join('');
            
            displayResults(relevantResults);
        }

        // Display Results
        function displayResults(results) {
            const resultsTableBody = document.getElementById('resultsTableBody');
            
            if (results.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #6c757d; padding: 20px;">Keine Ergebnisse vorhanden</td></tr>';
                return;
            }
            
            resultsTableBody.innerHTML = results.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(result => {
                const scoreClass = result.totalPercentage >= 80 ? 'score-high' : 
                                     result.totalPercentage >= 60 ? 'score-medium' : 'score-low';
                
                return `
                    <tr data-doc-id="${result.id}">
                        <td><span class="code-badge">${result.testCode}</span></td>
                        <td>${new Date(result.timestamp).toLocaleDateString('de-DE')}</td>
                        <td><span class="score-badge ${scoreClass}">${result.totalPercentage}%</span></td>
                        <td>${result.categoryPercentages[1]}%</td>
                        <td>${result.categoryPercentages[2]}%</td>
                        <td>${result.categoryPercentages[3]}%</td>
                        <td>${result.categoryPercentages[4]}%</td>
                        <td>${result.categoryPercentages[5]}%</td>
                        <td>
                            <button class="action-button view-button">Details</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load Statistics Data
        function loadStatisticsData() {
            const departmentCodes = currentDepartment === 'admin' 
                ? generatedCodes 
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            if (relevantResults.length > 0) {
                for (let i = 1; i <= 5; i++) {
                    const scores = relevantResults.map(r => r.categoryPercentages[i]);
                    const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                    const bar = document.getElementById(`bar${i}`);
                    bar.style.width = avg + '%';
                    bar.textContent = avg + '%';
                }
            } else {
                 for (let i = 1; i <= 5; i++) {
                    const bar = document.getElementById(`bar${i}`);
                    bar.style.width = '0%';
                    bar.textContent = '0%';
                }
            }
        }
        
        // Load Admin specific data
        function loadAdminData() {
            const adminTableBody = document.getElementById('adminTableBody');
            const departments = Object.keys(deptNames).filter(d => d !== 'admin');
            document.getElementById('allDepartmentsCount').textContent = departments.length;
            
            const tableRows = departments.map(deptKey => {
                const deptCodes = generatedCodes.filter(c => c.department === deptKey).map(c => c.code);
                const deptResults = testResults.filter(r => deptCodes.includes(r.testCode));
                
                if (deptResults.length === 0) {
                     return `<tr><td>${deptNames[deptKey]}</td><td>0</td><td>N/A</td><td>N/A</td><td>N/A</td></tr>`;
                }

                const avgScore = Math.round(deptResults.reduce((sum, r) => sum + r.totalPercentage, 0) / deptResults.length);
                const scoreClass = avgScore >= 80 ? 'score-high' : avgScore >= 60 ? 'score-medium' : 'score-low';
                
                const categoryAvgs = [];
                 for (let i = 1; i <= 5; i++) {
                    const scores = deptResults.map(r => r.categoryPercentages[i]);
                    categoryAvgs.push({
                        name: i,
                        avg: Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
                    });
                }
                
                categoryAvgs.sort((a,b) => b.avg - a.avg);
                const bestCat = categoryAvgs[0].name;
                const worstCat = categoryAvgs[categoryAvgs.length - 1].name;
                const catNames = ["Grundkenntnisse IKT", "Anwendung im Unterricht", "Medien- & Infokompetenz", "Daten & Sicherheit", "Kommunikation"];

                return `
                    <tr>
                        <td>${deptNames[deptKey]}</td>
                        <td>${deptResults.length}</td>
                        <td><span class="score-badge ${scoreClass}">${avgScore}%</span></td>
                        <td>${catNames[bestCat-1]}</td>
                        <td>${catNames[worstCat-1]}</td>
                    </tr>`;
            }).join('');
            
            adminTableBody.innerHTML = tableRows;
            updateStatistics();
        }

        // Update Statistics
        function updateStatistics() {
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin ? generatedCodes : generatedCodes.filter(c => c.department === currentDepartment);
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            document.getElementById('totalTests').textContent = relevantResults.length;
            document.getElementById('activeCodes').textContent = departmentCodes.filter(c => {
                const expiryDate = c.expiry || c.expiryDate;
                return new Date(expiryDate) >= new Date();
            }).length;
            
            if (relevantResults.length > 0) {
                const avgScore = Math.round(relevantResults.reduce((sum, r) => sum + r.totalPercentage, 0) / relevantResults.length);
                document.getElementById('avgScore').textContent = avgScore + '%';
                
                const totalCodes = departmentCodes.length;
                const usedCodes = new Set(relevantResults.map(r => r.testCode)).size;
                const completionRate = totalCodes > 0 ? Math.round((usedCodes / totalCodes) * 100) : 0;
                document.getElementById('completionRate').textContent = completionRate + '%';
            } else {
                 document.getElementById('avgScore').textContent = '0%';
                 document.getElementById('completionRate').textContent = '0%';
            }
            
            if (isAdmin) {
                document.getElementById('totalTestsAdmin').textContent = testResults.length;
                if (testResults.length > 0) {
                    const avgScoreAdmin = Math.round(testResults.reduce((sum, r) => sum + r.totalPercentage, 0) / testResults.length);
                    document.getElementById('avgScoreAdmin').textContent = avgScoreAdmin + '%';
                } else {
                    document.getElementById('avgScoreAdmin').textContent = '0%';
                }
            }
        }

        // View Code Details
        function viewCodeDetails(docId) {
            const codeData = generatedCodes.find(c => c.id === docId);
            const codeResults = testResults.filter(r => r.testCode === codeData.code);
            
            document.getElementById('modalTitle').textContent = `Details für Code: ${codeData.code}`;
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <p><strong>Beschreibung:</strong> ${codeData.description}</p>
                <p><strong>Abteilung:</strong> ${deptNames[codeData.department]}</p>
                <p><strong>Erstellt:</strong> ${codeData.created}</p>
                <p><strong>Gültig bis:</strong> ${codeData.expiry}</p>
                <p><strong>Teilnehmer:</strong> ${codeResults.length}</p>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        // View Result Details
        function viewResultDetails(docId) {
            const result = testResults.find(r => r.id === docId);
            
            document.getElementById('modalTitle').textContent = 'Test-Ergebnis Details';
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <p><strong>Code:</strong> ${result.testCode}</p>
                <p><strong>Datum:</strong> ${new Date(result.timestamp).toLocaleString('de-DE')}</p>
                <p><strong>Testdauer:</strong> ${Math.round(result.duration / 60)} Minuten</p>
                <p><strong>Gesamtscore:</strong> ${result.totalPercentage}%</p>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        // Delete Code - Korrigierte Version
        async function deleteCode(docId, code) {
            showCustomConfirm(
                `Möchten Sie den Code <strong>${code}</strong> wirklich löschen? Alle zugehörigen Ergebnisse werden ebenfalls entfernt.`,
                "Löschen",
                async () => {
                    try {
                        if (firebaseReady && db) {
                            // Firebase Mode
                            await deleteDoc(doc(db, "codes", docId));
                            
                            // Auch zugehörige Results löschen
                            const q = query(resultsCollection, where("testCode", "==", code));
                            const querySnapshot = await getDocs(q);
                            const batch = writeBatch(db);
                            querySnapshot.forEach((doc) => batch.delete(doc.ref));
                            await batch.commit();
                            
                            // Arrays aktualisieren
                            generatedCodes = generatedCodes.filter(c => c.id !== docId);
                            testResults = testResults.filter(r => r.testCode !== code);
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            
                            loadDashboardData();
                            showCustomAlert(`Code ${code} wurde gelöscht.`);
                        } else {
                            // Local mode: remove from array
                            generatedCodes = generatedCodes.filter(c => c.id !== docId);
                            testResults = testResults.filter(r => r.testCode !== code);
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            loadDashboardData();
                            showCustomAlert(`Code ${code} wurde lokal gelöscht.`);
                        }
                    } catch (error) {
                        console.error("Fehler beim Löschen:", error);
                        showCustomAlert(`Fehler beim Löschen: ${error.message}`);
                    }
                }
            );
        }

        // Neue Funktion: Mehrere Codes löschen
        async function deleteSelectedCodes() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            const selectedCodes = Array.from(checkedBoxes).map(cb => {
                const row = cb.closest('tr');
                return {
                    id: row.dataset.docId,
                    code: cb.value
                };
            });

            if (selectedCodes.length === 0) return;

            const codeList = selectedCodes.map(c => c.code).join(', ');
            
            showCustomConfirm(
                `Möchten Sie wirklich <strong>${selectedCodes.length}</strong> Code(s) löschen?<br><br>Codes: ${codeList}<br><br>Alle zugehörigen Ergebnisse werden ebenfalls entfernt.`,
                "Alle löschen",
                async () => {
                    try {
                        if (firebaseReady && db) {
                            // Firebase Mode - Batch-Löschung
                            const batch = writeBatch(db);
                            
                            // Codes löschen
                            for (const codeObj of selectedCodes) {
                                const docRef = doc(db, "codes", codeObj.id);
                                batch.delete(docRef);
                                
                                // Zugehörige Results finden und löschen
                                const q = query(resultsCollection, where("testCode", "==", codeObj.code));
                                const querySnapshot = await getDocs(q);
                                querySnapshot.forEach((resultDoc) => {
                                    batch.delete(resultDoc.ref);
                                });
                            }
                            
                            await batch.commit();
                            
                            // Arrays aktualisieren
                            const codeIds = selectedCodes.map(c => c.id);
                            const codes = selectedCodes.map(c => c.code);
                            generatedCodes = generatedCodes.filter(c => !codeIds.includes(c.id));
                            testResults = testResults.filter(r => !codes.includes(r.testCode));
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            
                            loadDashboardData();
                            showCustomAlert(`${selectedCodes.length} Code(s) wurden gelöscht.`);
                        } else {
                            // Local mode
                            const codeIds = selectedCodes.map(c => c.id);
                            const codes = selectedCodes.map(c => c.code);
                            generatedCodes = generatedCodes.filter(c => !codeIds.includes(c.id));
                            testResults = testResults.filter(r => !codes.includes(r.testCode));
                            window.generatedCodes = generatedCodes;
                            window.testResults = testResults;
                            loadDashboardData();
                            showCustomAlert(`${selectedCodes.length} Code(s) wurden lokal gelöscht.`);
                        }
                    } catch (error) {
                        console.error("Fehler beim Batch-Löschen:", error);
                        showCustomAlert(`Fehler beim Löschen: ${error.message}`);
                    }
                }
            );
        }
        
        // Admin: Reset Password
        async function resetPassword() {
            const departmentToReset = document.getElementById('resetPwDepartment').value;
            const newPassword = document.getElementById('newPassword').value;

            if (newPassword.length < 6) {
                showCustomAlert('Das Passwort muss mindestens 6 Zeichen lang sein.');
                return;
            }

            showCustomConfirm(
                `Möchten Sie das Passwort für <strong>${deptNames[departmentToReset]}</strong> wirklich ändern?`,
                "Ja, ändern",
                async () => {
                    userAccounts[departmentToReset].pass = newPassword;
                    if (firebaseReady && accountsDocRef) {
                        await setDoc(accountsDocRef, userAccounts);
                    }
                    document.getElementById('newPassword').value = '';
                    showCustomAlert(`Das Passwort für ${deptNames[departmentToReset]} wurde geändert.`);
                }
            );
        }

        // Modal and UI Helper Functions
        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('active');
        }

        function showCustomAlert(message) {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertModalTitle').textContent = 'Hinweis';
            document.getElementById('alertModalBody').innerHTML = `<p>${message}</p>`;
            document.getElementById('alertModalFooter').innerHTML = 
                `<button class="login-button" style="width: auto; padding: 10px 30px;" onclick="document.getElementById('alertModal').classList.remove('active')">OK</button>`;
            modal.classList.add('active');
        }
        window.showCustomAlert = showCustomAlert; // Globale Verfügbarkeit
        
        function showCustomConfirm(message, confirmText, onConfirm) {
            const modal = document.getElementById('alertModal');
            document.getElementById('alertModalTitle').textContent = 'Bestätigung erforderlich';
            document.getElementById('alertModalBody').innerHTML = `<p>${message}</p>`;
            document.getElementById('alertModalFooter').innerHTML = `
                <button class="logout-button" style="background: #6c757d; color: white; border: none; margin-right: 10px;" id="confirmCancelBtn">Abbrechen</button>
                <button class="login-button" style="background: #dc3545;" id="confirmOkBtn">${confirmText}</button>`;
            
            modal.classList.add('active');

            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');

            const handleConfirm = (result) => {
                closeModal('alertModal');
                if (result) onConfirm();
            };
            
            cancelBtn.onclick = () => handleConfirm(false);
            okBtn.onclick = () => handleConfirm(true);
        }
        window.showCustomConfirm = showCustomConfirm; // Globale Verfügbarkeit

        function updateDownloadButtonState() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            const hasChecked = checkedBoxes.length > 0;
            document.getElementById('downloadCodesBtn').disabled = !hasChecked;
            
            // Auch den Delete-Button aktualisieren
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.disabled = !hasChecked;
            }
        }

        function toggleAllCheckboxes(source) {
            document.querySelectorAll('.code-checkbox').forEach(cb => cb.checked = source.checked);
            updateDownloadButtonState();
        }

        function downloadSelectedCodes() {
            const checkedBoxes = document.querySelectorAll('.code-checkbox:checked');
            const codesToDownload = Array.from(checkedBoxes).map(cb => cb.value);
            const relevantCodesData = generatedCodes.filter(c => codesToDownload.includes(c.code));
            if (relevantCodesData.length === 0) return;
            let csv = 'Code,Beschreibung,GueltigBis\n';
            relevantCodesData.forEach(c => { csv += `${c.code},"${c.description}",${c.expiry}\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-codes_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportResults() {
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin
                ? generatedCodes
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            const relevantResults = testResults.filter(r => codeList.includes(r.testCode));
            
            if (relevantResults.length === 0) {
                showCustomAlert('Keine Ergebnisse zum Exportieren vorhanden.');
                return;
            }
            
            let csv = 'Code,Datum,Gesamtscore,Grundkenntnisse IKT,Anwendung im Unterricht,Medien- & Infokompetenz,Daten & Sicherheit,Kommunikation\n';
            
            relevantResults.forEach(result => {
                csv += `${result.testCode},${new Date(result.timestamp).toLocaleDateString('de-DE')},`;
                csv += `${result.totalPercentage},${result.categoryPercentages[1]},${result.categoryPercentages[2]},${result.categoryPercentages[3]},${result.categoryPercentages[4]},${result.categoryPercentages[5]}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kompetenzen_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function filterResults() {
            const selectedCode = document.getElementById('codeFilter').value;
            const isAdmin = currentDepartment === 'admin';
            const departmentCodes = isAdmin
                ? generatedCodes
                : generatedCodes.filter(c => c.department === currentDepartment);
            
            const codeList = departmentCodes.map(c => c.code);
            let relevantResults = testResults.filter(r => codeList.includes(r.testCode));

            if (selectedCode) {
                 relevantResults = relevantResults.filter(r => r.testCode === selectedCode)
            }
            
            displayResults(relevantResults);
        }

        // Event Listeners Setup
        document.addEventListener('DOMContentLoaded', async () => {
            // Login-Button während des Ladens deaktivieren
            const loginButton = document.querySelector('.login-button');
            if (loginButton) {
                loginButton.disabled = true;
                loginButton.textContent = 'Lädt';
            }

            try {
                await initializeAppWithFirebase();
            } catch (error) {
                console.error('Fehler bei der Firebase-Initialisierung:', error);
            } finally {
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Anmelden';
                }
            }

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('generateCodesBtn').addEventListener('click', generateCodes);
            document.getElementById('resetPasswordBtn').addEventListener('click', resetPassword);
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => toggleAllCheckboxes(e.target));
            document.getElementById('downloadCodesBtn').addEventListener('click', downloadSelectedCodes);

            // --- Zugangsdaten-Verwaltung (Admin) ---
            async function loadCredentials() {
                try {
                    const dept = document.getElementById('credDepartmentSelect').value;
                    const account = userAccounts && userAccounts[dept];
                    document.getElementById('credUsername').value = account?.user || '';
                    document.getElementById('credPassword').value = account?.pass || '';
                } catch (e) {
                    console.warn('loadCredentials error', e);
                }
            }
            async function saveCredentials() {
                const dept = document.getElementById('credDepartmentSelect').value;
                const user = document.getElementById('credUsername').value.trim();
                const pass = document.getElementById('credPassword').value;

                if (!dept || !user || !pass) {
                    showCustomAlert('Bitte Abteilung, Benutzername und Passwort ausfüllen.');
                    return;
                }

                // Update local object
                if (!userAccounts) userAccounts = {};
                userAccounts[dept] = { user, pass };

                try {
                    if (accountsDocRef) {
                        await setDoc(accountsDocRef, userAccounts);
                        showCustomAlert('Zugangsdaten gespeichert.');
                    } else {
                        showCustomAlert('Ohne Firestore gespeichert (lokaler Modus).');
                    }
                } catch (e) {
                    console.error('Fehler beim Speichern:', e);
                    showCustomAlert('Fehler beim Speichern: ' + e.message);
                }
            }

            // Buttons verdrahten
            document.getElementById('loadCredsBtn')?.addEventListener('click', loadCredentials);
            document.getElementById('saveCredsBtn')?.addEventListener('click', saveCredentials);

            function getDeptUsers(dept) {
                const acc = userAccounts ? userAccounts[dept] : null;
                if (Array.isArray(acc)) return acc;
                if (acc && typeof acc === 'object' && acc.user) return [acc]; // backward compat
                return [];
            }
            function setDeptUsers(dept, arr) {
                if (!userAccounts) userAccounts = {};
                userAccounts[dept] = arr;
            }
            function renderCredUserList() {
                const dept = document.getElementById('credDepartmentSelect').value;
                const users = getDeptUsers(dept);
                const list = document.getElementById('credUserList');
                if (!list) return;
                if (!users.length) {
                    list.innerHTML = '<div style="opacity:.7">Keine Benutzer erfasst.</div>';
                    document.getElementById('removeSelectedCredUsersBtn').disabled = true;
                    return;
                }
                let htmlRows = users.map((u, idx) => {
                    const safeUser = (u.user || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    return \`
                        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; border-bottom:1px solid #eee;">
                            <input type="checkbox" class="credRowChk" data-idx="\${idx}">
                            <span style="min-width:200px; font-weight:600;">\${safeUser}</span>
                            <span style="opacity:.7;">(Passwort gesetzt)</span>
                        </label>\`;
                }).join('');
                list.innerHTML = htmlRows;
                document.getElementById('removeSelectedCredUsersBtn').disabled = true;
                list.querySelectorAll('.credRowChk').forEach(chk => {
                    chk.addEventListener('change', () => {
                        const any = Array.from(list.querySelectorAll('.credRowChk')).some(c => c.checked);
                        document.getElementById('removeSelectedCredUsersBtn').disabled = !any;
                    });
                });
            }
            async function loadCredentials() {
                try {
                    const dept = document.getElementById('credDepartmentSelect').value;
                    const users = getDeptUsers(dept);
                    document.getElementById('credUsername').value = users[0]?.user || '';
                    document.getElementById('credPassword').value = users[0]?.pass || '';
                    renderCredUserList();
                } catch (e) {
                    console.warn('loadCredentials error', e);
                }
            }
            async function saveCredentials() {
                const dept = document.getElementById('credDepartmentSelect').value;
                const user = document.getElementById('credUsername').value.trim();
                const pass = document.getElementById('credPassword').value;
                if (!dept || !user || !pass) {
                    showCustomAlert('Bitte Abteilung, Benutzername und Passwort ausfüllen.');
                    return;
                }
                const arr = getDeptUsers(dept);
                // Update or append: if same username exists, replace
                const idx = arr.findIndex(u => u.user === user);
                if (idx >= 0) arr[idx] = { user, pass };
                else arr.push({ user, pass });
                setDeptUsers(dept, arr);
                try {
                    if (accountsDocRef) {
                        await setDoc(accountsDocRef, userAccounts);
                        showCustomAlert('Benutzer gespeichert.');
                    } else {
                        showCustomAlert('Ohne Firestore gespeichert (lokaler Modus).');
                    }
                } catch (e) {
                    console.error('Fehler beim Speichern:', e);
                    showCustomAlert('Fehler beim Speichern: ' + e.message);
                }
                renderCredUserList();
            }
            function removeSelectedCredUsers() {
                const dept = document.getElementById('credDepartmentSelect').value;
                const arr = getDeptUsers(dept);
                const list = document.getElementById('credUserList');
                const toRemove = Array.from(list.querySelectorAll('.credRowChk'))
                    .filter(c => c.checked)
                    .map(c => parseInt(c.dataset.idx,10))
                    .sort((a,b)=>b-a); // remove from end
                toRemove.forEach(i => { if (i>=0 && i < arr.length) arr.splice(i,1); });
                setDeptUsers(dept, arr);
                if (accountsDocRef) {
                    setDoc(accountsDocRef, userAccounts).then(()=>{
                        showCustomAlert('Benutzer entfernt.');
                        renderCredUserList();
                    }).catch(e=>{
                        console.error(e);
                        showCustomAlert('Fehler beim Speichern: ' + e.message);
                    });
                } else {
                    renderCredUserList();
                    showCustomAlert('Lokal entfernt (kein Firestore).');
                }
            }
            document.getElementById('addCredUserBtn')?.addEventListener('click', saveCredentials);
            document.getElementById('removeSelectedCredUsersBtn')?.addEventListener('click', removeSelectedCredUsers);
            document.getElementById('credDepartmentSelect')?.addEventListener('change', () => {
                // Beim Wechsel der Abteilung Eingabefelder leeren und Liste rendern
                document.getElementById('credUsername').value = '';
                document.getElementById('credPassword').value = '';
                renderCredUserList();
            });
    

            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedCodes);
            document.getElementById('exportResultsBtn').addEventListener('click', exportResults);
            document.getElementById('codeFilter').addEventListener('change', filterResults);

            document.getElementById('tabNav').addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    switchTab(e);
                }
            });

            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', (e) => closeModal(e.target.dataset.modalId));
            });

            // Event Delegation für dynamische Buttons
            document.addEventListener('click', e => {
                // Handle Code Table Actions
                if (e.target.closest('#codeTableBody')) {
                    const row = e.target.closest('tr');
                    if (!row) return;

                    const docId = row.dataset.docId;
                    const code = row.dataset.code;

                    if (e.target.classList.contains('view-button')) {
                        viewCodeDetails(docId);
                    } else if (e.target.classList.contains('delete-button')) {
                        deleteCode(docId, code);
                    }
                }

                // Handle Results Table Actions
                if (e.target.closest('#resultsTableBody') && e.target.classList.contains('view-button')) {
                    const row = e.target.closest('tr');
                    const docId = row.dataset.docId;
                    viewResultDetails(docId);
                }
            });
            
            // Checkbox Change Handler
            document.addEventListener('change', e => {
                if (e.target.classList.contains('code-checkbox')) {
                    updateDownloadButtonState();
                }
            });
        });
    </script>
</body>
</html>
